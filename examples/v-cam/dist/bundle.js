(()=>{"use strict";const e="ftarcache";const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];async function a(t,a){const i=await async function(t){const a=await caches.open(e),i=await a.match(t);if(!i)return null;const n=await i.arrayBuffer();return new Uint8Array(n)}("/ftar/"+t.id);if(i)return{data:i,ready:Promise.resolve(!0),id:t.id,name:t.meta?.name};t.ftar||(t=await FtarView.flexatarEntry(a,t.id,{ftar:!0}));const n=await FtarView.getFlexatar(t);return await async function(t,a){const i=await caches.open(e),n=new Response(a,{headers:{"Content-Type":"application/octet-stream"}});await i.put(t,n)}("/ftar/"+t.id,n.data),n}async function i(t){const a=await async function(t){const a=await caches.open(e),i=await a.match(t);if(!i)return null;const n=await i.blob();return URL.createObjectURL(n)}("/ftarpreview/"+t.id);if(a)return a;const i=await FtarView.getPreview(t);return await async function(t,a){const i=await async function(e){const t=await fetch(e);return await t.blob()}(a),n=await caches.open(e),s=new Response(i,{headers:{"Content-Type":i.type||"application/octet-stream"}});await n.put(t,s)}("/ftarpreview/"+t.id,i),i}class n{static DROP_PHOTO="DROP PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START"}function s(e,t){let a={};return t?a[t]=e:a=e,a}class o{constructor(e,t,a){this.iframeId=a,this.holderId=t,this.postMessageProvider=e,this.peerConnection=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all"}),this.peerConnection.ontrack=e=>{const a=e.track;"iframe"==t?"audio"==a.kind&&this.onaudioready&&this.onaudioready(a):"host"==t&&("video"==a.kind?this.onflexatarready&&this.onflexatarready(a):this.ondelayedaudio&&this.ondelayedaudio(a))},this.peerConnection.onicecandidate=t=>{t.candidate&&e.postMessage({flexatar:s({type:"ice-candidate",candidate:JSON.stringify(t.candidate)},this.iframeId)},"*")},this.peerConnection.onconnectionstatechange=()=>{this.peerConnection.connectionState},this.isNegotiating=!0,this.peerConnection.onnegotiationneeded=async()=>{this.isNegotiating||(this.isNegotiating=!0,e.postMessage({flexatar:s(await this.offerMessage(),this.iframeId)},"*"))}}async recvOffer(e){const t=new RTCSessionDescription({type:"offer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t);const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.postMessageProvider.postMessage({flexatar:s({type:"answer",sdp:a.sdp},this.iframeId)},"*")}async recvAnswer(e){const t=new RTCSessionDescription({type:"answer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t)}async addIceCandidate(e){await this.peerConnection.addIceCandidate(JSON.parse(e.candidate))}async offerMessage(){const e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),{type:"offer",sdp:e.sdp}}addAudioTrack(e){e?this.audioTransiver?this.audioTransiver.sender.replaceTrack(e).then((()=>{})).catch((e=>{console.error("Error replacing track:",e)})):this.audioTransiver=this.peerConnection.addTransceiver(e,{direction:"sendonly"}):this.audioTransiver&&(this.peerConnection.getSenders().forEach((e=>{e.track&&"audio"===e.track.kind&&this.peerConnection.removeTrack(e)})),this.audioTransiver.stop(),this.audioTransiver=null)}addAllTraks(e){e.getTracks().forEach((e=>{this.peerConnection.addTransceiver(e,{direction:"sendonly"})}))}}allowAuidoOverlay.textContent=n.ALLOW_AUDIO;const r=window.location.search;let c;new URLSearchParams(r).forEach(((e,t)=>{"id"===t&&(c=e)}));const l=FtarLipsync.newInstance();let d;const p=new Promise((e=>{d=e})),w=new Promise((e=>{allowAuidoOverlay.onclick=()=>{e()}})),u=new Promise((async e=>{const t=await l;await p,allowAuidoOverlay.classList.remove("invisible"),await w,allowAuidoOverlay.classList.add("invisible"),await t.startAudioContext(),e(t)}));let m,v,f,h,y;async function g(e,t){const n=await i(e),s=document.createElement("span");s.className="item-holder";const o=document.createElement("img");o.src=n,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",s.appendChild(o),s.id=e.id;const r=document.createElement("span");return r.className="loader",f||(s.classList.add("selected-item"),f=s,h={element:s,ftarId:e.id}),previewListHolder.insertBefore(s,previewListHolder.children[2]),s.onclick=async()=>{h={element:s,ftarId:e.id},f&&f.classList.remove("selected-item"),f=s,s.classList.add("selected-item"),s.appendChild(r);try{v.slot1=await a(e,T),v.start()}finally{r.remove()}},s}!function(){const e=createFlexatarHolder,i=plusCircle,s=makeTextHolder;s.textContent=n.DROP_PHOTO;const o=makeOverlayElement,r=e=>(i.classList.add("rotated"),s.textContent=e,()=>{i.classList.remove("rotated"),s.textContent=n.DROP_PHOTO});let c;!function(e,t){const a=document.createElement("input");a.type="file",a.accept="image/*",a.onchange=e=>t(e),e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),e.classList.remove("hover");const i=a.dataTransfer.files;t({target:{files:i}})}}(e,(async e=>{c&&(c(),c=null);const l=(i.style.display="none",s.style.display="none",o.style.display="block",()=>{i.style.display="block",s.style.display="block",o.style.display="none"}),d=e.target.files[0];if(!function(e,t){for(const a of t)if(e==a)return!0;return!1}(d.type,t))return c=r(n.NOT_PHOTO),void l();const p=await FtarView.makeFlexatar(T,d,"noname",{ftar:!0,preview:!0});l(),p||(c=r(n.UNKNOWN)),p.err?p.reason&&("queue_limit"===p.reason||("subscription_limit"===p.reason?c=r(n.LIMIT):"bad_photo"===p.reason&&(c=r(n.BAD_PHOTO)))):(FtarView.userInfo(T).then((e=>{ftarCountSign.textContent=e.FtarCount})),await a(p,T),(await g(p)).click(),emptyBlock.textContent="")}))}();let L,b,T,O,k=new MediaStream,C=new Promise((e=>{O=e}));window.addEventListener("message",(async e=>{let t=e.data;if(t.flexatar){if(t=t.flexatar,"reload_token"===t.type)b(t.token);else if("request_audio"===t.type){console.log("obtained request_audio"),allowAuidoOverlay.classList.remove("invisible"),await w,allowAuidoOverlay.classList.add("invisible");const e={};e[c]={type:"request_audio"},window.parent.postMessage({flexatar:e},"*")}else if("resolution"===t.type)await C,v.canvas.width=t.resolution.width,v.canvas.height=t.resolution.height;else if("background"===t.type){await C;const e=URL.createObjectURL(new Blob([t.imageBuffer],{type:"image/jpg"})),a=await m.newOverlay(e);v.addOverlay(a,{x:0,y:0,width:100,height:100,mode:"back"})}else if(t.token){const e=new FtarView.GetToken((async()=>{const e=new Promise((e=>{b=e})),t={};return t[c]={type:"reload_token"},window.parent.postMessage({flexatar:t},"*"),await e}));T=e,FtarView.userInfo(T).then((e=>{e.restricted||(createFlexatarHolder.classList.remove("invisible"),reloadFtarListButton.classList.remove("invisible"),trashButton.classList.remove("invisible"),ftarCountSign.textContent=e.FtarCount)}));const t=await FtarView.flexatarList(e,{preview:!0});if(t.error)return;for(const e of t)await g(e);m=new FtarView.SDK(e),v=await m.getRenderer(),t.length>0?previewListHolder.children[2].click():emptyBlock.textContent=n.EMPTY,O(),v.canvas.width=240,v.canvas.height=320,v.canvas.style.display="none",document.body.appendChild(v.canvas);const a=v.canvas.captureStream(30);y=new o(window.parent,"iframe",c),y.addAllTraks(a);const i={};i[c]=await y.offerMessage(),window.parent.postMessage({flexatar:i},"*"),y.onaudioready=async e=>{d(),L&&k.removeTrack(L),L=e,k.addTrack(e);const t=new Audio;t.srcObject=k,t.pause(),t.muted=!0;const a=await u;a.mediaStream=k,a.connect(v);const i=a.synchronizedStream();y.addAudioTrack(i.getAudioTracks()[0]),e.onended=()=>{setTimeout((()=>{a.mediaStream=null,y.addAudioTrack(null),y.isNegotiating=!1}),700)},y.isNegotiating=!1}}"offer"===t.type?y.recvOffer(t):"ice-candidate"===t.type?y.addIceCandidate(t):"answer"===t.type&&y.recvAnswer(t)}}));let I=!1;trashButton.onclick=()=>{I?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),I=!I},confirmButton.onclick=async()=>{confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,await new Promise((e=>{setTimeout((()=>{e()}),3e3)})),await FtarView.deleteFlexatar({id:h.ftarId,token:T})&&(h.element.remove(),previewListHolder.children.length>1?previewListHolder.children[2].click():v.pause()),trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),I=!I},reloadFtarListButton.onclick=async()=>{reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");const e=await FtarView.flexatarList(T,{preview:!0});if(e.error)return void reloadIcon.classList.remove("roating");const t=h.element.id;for(;previewListHolder.children.length>3;)previewListHolder.children[2].remove();for(const a of e){const e=await g(a);a.id===t&&e.click()}reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1};let x,P,A,F=!1;document.addEventListener("mousedown",(e=>{N&&clearInterval(N),F=!0,x=e.screenY,P=window.scrollY}));let H,N,B=0,E=0,M=0,D=!1;function R(){if(F=!1,B=0,A&&clearInterval(A),document.body.style.pointerEvents="auto",!D)return;D=!1,P=window.scrollY,E=.5*M,N=setInterval((()=>{P+=E,window.scrollTo(0,P),E*=.9,Math.abs(E)<1&&clearInterval(N)}),50);const e=N;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{F&&(e.preventDefault(),H=x-e.screenY,!D&&Math.abs(H)<10||(D||(M=0,A=setInterval((()=>{E=H-B,B=H,M=.5*(M+E)}),100)),D=!0,document.body.style.pointerEvents="none",window.scrollTo(0,P+H)))})),document.addEventListener("mouseup",R),document.addEventListener("mouseleave",R)})();
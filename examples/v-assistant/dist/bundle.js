(()=>{var e={975:e=>{"use strict";function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var n,a="",i=0,s=-1,o=0,r=0;r<=e.length;++r){if(r<e.length)n=e.charCodeAt(r);else{if(47===n)break;n=47}if(47===n){if(s===r-1||1===o);else if(s!==r-1&&2===o){if(a.length<2||2!==i||46!==a.charCodeAt(a.length-1)||46!==a.charCodeAt(a.length-2))if(a.length>2){var c=a.lastIndexOf("/");if(c!==a.length-1){-1===c?(a="",i=0):i=(a=a.slice(0,c)).length-1-a.lastIndexOf("/"),s=r,o=0;continue}}else if(2===a.length||1===a.length){a="",i=0,s=r,o=0;continue}t&&(a.length>0?a+="/..":a="..",i=2)}else a.length>0?a+="/"+e.slice(s+1,r):a=e.slice(s+1,r),i=r-s-1;s=r,o=0}else 46===n&&-1!==o?++o:o=-1}return a}var a={resolve:function(){for(var e,a="",i=!1,s=arguments.length-1;s>=-1&&!i;s--){var o;s>=0?o=arguments[s]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(a=o+"/"+a,i=47===o.charCodeAt(0))}return a=n(a,!i),i?a.length>0?"/"+a:"/":a.length>0?a:"."},normalize:function(e){if(t(e),0===e.length)return".";var a=47===e.charCodeAt(0),i=47===e.charCodeAt(e.length-1);return 0!==(e=n(e,!a)).length||a||(e="."),e.length>0&&i&&(e+="/"),a?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,n=0;n<arguments.length;++n){var i=arguments[n];t(i),i.length>0&&(void 0===e?e=i:e+="/"+i)}return void 0===e?".":a.normalize(e)},relative:function(e,n){if(t(e),t(n),e===n)return"";if((e=a.resolve(e))===(n=a.resolve(n)))return"";for(var i=1;i<e.length&&47===e.charCodeAt(i);++i);for(var s=e.length,o=s-i,r=1;r<n.length&&47===n.charCodeAt(r);++r);for(var c=n.length-r,l=o<c?o:c,d=-1,h=0;h<=l;++h){if(h===l){if(c>l){if(47===n.charCodeAt(r+h))return n.slice(r+h+1);if(0===h)return n.slice(r+h)}else o>l&&(47===e.charCodeAt(i+h)?d=h:0===h&&(d=0));break}var f=e.charCodeAt(i+h);if(f!==n.charCodeAt(r+h))break;47===f&&(d=h)}var p="";for(h=i+d+1;h<=s;++h)h!==s&&47!==e.charCodeAt(h)||(0===p.length?p+="..":p+="/..");return p.length>0?p+n.slice(r+d):(r+=d,47===n.charCodeAt(r)&&++r,n.slice(r))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var n=e.charCodeAt(0),a=47===n,i=-1,s=!0,o=e.length-1;o>=1;--o)if(47===(n=e.charCodeAt(o))){if(!s){i=o;break}}else s=!1;return-1===i?a?"/":".":a&&1===i?"//":e.slice(0,i)},basename:function(e,n){if(void 0!==n&&"string"!=typeof n)throw new TypeError('"ext" argument must be a string');t(e);var a,i=0,s=-1,o=!0;if(void 0!==n&&n.length>0&&n.length<=e.length){if(n.length===e.length&&n===e)return"";var r=n.length-1,c=-1;for(a=e.length-1;a>=0;--a){var l=e.charCodeAt(a);if(47===l){if(!o){i=a+1;break}}else-1===c&&(o=!1,c=a+1),r>=0&&(l===n.charCodeAt(r)?-1==--r&&(s=a):(r=-1,s=c))}return i===s?s=c:-1===s&&(s=e.length),e.slice(i,s)}for(a=e.length-1;a>=0;--a)if(47===e.charCodeAt(a)){if(!o){i=a+1;break}}else-1===s&&(o=!1,s=a+1);return-1===s?"":e.slice(i,s)},extname:function(e){t(e);for(var n=-1,a=0,i=-1,s=!0,o=0,r=e.length-1;r>=0;--r){var c=e.charCodeAt(r);if(47!==c)-1===i&&(s=!1,i=r+1),46===c?-1===n?n=r:1!==o&&(o=1):-1!==n&&(o=-1);else if(!s){a=r+1;break}}return-1===n||-1===i||0===o||1===o&&n===i-1&&n===a+1?"":e.slice(n,i)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,a=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+a:n+"/"+a:a}(0,e)},parse:function(e){t(e);var n={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return n;var a,i=e.charCodeAt(0),s=47===i;s?(n.root="/",a=1):a=0;for(var o=-1,r=0,c=-1,l=!0,d=e.length-1,h=0;d>=a;--d)if(47!==(i=e.charCodeAt(d)))-1===c&&(l=!1,c=d+1),46===i?-1===o?o=d:1!==h&&(h=1):-1!==o&&(h=-1);else if(!l){r=d+1;break}return-1===o||-1===c||0===h||1===h&&o===c-1&&o===r+1?-1!==c&&(n.base=n.name=0===r&&s?e.slice(1,c):e.slice(r,c)):(0===r&&s?(n.name=e.slice(1,o),n.base=e.slice(1,c)):(n.name=e.slice(r,o),n.base=e.slice(r,c)),n.ext=e.slice(o,c)),r>0?n.dir=e.slice(0,r-1):s&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};a.posix=a,e.exports=a},956:(e,t,n)=>{const a=n(975);e.exports={entry:"./src/index.js",output:{filename:"bundle.js",path:a.resolve("/","dist")},mode:"development",resolve:{fallback:{fs:!1,path:975}},module:{rules:[{test:/\.js$/,exclude:/node_modules/}]},devServer:{static:"./dist"}}}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}(()=>{"use strict";const e="ftarcache";async function t(t,n){const a=await async function(t){const n=await caches.open(e),a=await n.match(t);if(!a)return null;const i=await a.arrayBuffer();return new Uint8Array(i)}("/ftar/"+t.id);if(a)return{data:a,ready:Promise.resolve(!0),id:t.id,name:t.meta?.name};t.ftar||(t=await FtarView.flexatarEntry(n,t.id,{ftar:!0}));const i=await FtarView.getFlexatar(t);return await async function(t,n){const a=await caches.open(e),i=new Response(n,{headers:{"Content-Type":"application/octet-stream"}});await a.put(t,i)}("/ftar/"+t.id,i.data),i}async function a(t){const n=await async function(t){const n=await caches.open(e),a=await n.match(t);if(!a)return null;const i=await a.blob();return URL.createObjectURL(i)}("/ftarpreview/"+t.id);if(n)return n;const a=await FtarView.getPreview(t);return await async function(t,n){const a=await async function(e){const t=await fetch(e);return await t.blob()}(n),i=await caches.open(e),s=new Response(a,{headers:{"Content-Type":a.type||"application/octet-stream"}});await i.put(t,s)}("/ftarpreview/"+t.id,a),a}class i{static DROP_PHOTO="DROP PHOTO";static BAD_PHOTO="BAD PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN"}class s{constructor(e,t){this.holderId=t,this.postMessageProvider=e,this.peerConnection=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all"}),this.peerConnection.ontrack=e=>{console.log("ontrack",t),console.log(e.track);const n=e.track;"iframe"==t?"audio"==n.kind&&this.onaudioready&&this.onaudioready(n):"host"==t&&("video"==n.kind?this.onflexatarready&&this.onflexatarready(n):this.ondelayedaudio&&this.ondelayedaudio(n))},this.peerConnection.onicecandidate=t=>{console.log("onicecandidate"),t.candidate&&e.postMessage({flexatar:{type:"ice-candidate",candidate:JSON.stringify(t.candidate)}},"*")},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection State:",this.peerConnection.connectionState),this.peerConnection.connectionState},this.isNegotiating=!0,this.peerConnection.onnegotiationneeded=async()=>{console.log("Negotiation needed...",t),this.isNegotiating||(this.isNegotiating=!0,e.postMessage({flexatar:await this.offerMessage()},"*"))}}async recvOffer(e){console.log("recvOffer");const t=new RTCSessionDescription({type:"offer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t);const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n),console.log("send answer"),this.postMessageProvider.postMessage({flexatar:{type:"answer",sdp:n.sdp}},"*")}async recvAnswer(e){console.log("recvAnswer");const t=new RTCSessionDescription({type:"answer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t)}async addIceCandidate(e){await this.peerConnection.addIceCandidate(JSON.parse(e.candidate))}async offerMessage(){const e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),console.log(this.holderId),{type:"offer",sdp:e.sdp}}addAudioTrack(e){e?this.audioTransiver?this.audioTransiver.sender.replaceTrack(e).then((()=>{console.log("Track replaced successfully.")})).catch((e=>{console.error("Error replacing track:",e)})):(console.log("setting new transiver",this.holderId),this.audioTransiver=this.peerConnection.addTransceiver(e,{direction:"sendonly"})):this.audioTransiver&&(this.peerConnection.getSenders().forEach((e=>{e.track&&"audio"===e.track.kind&&this.peerConnection.removeTrack(e)})),this.audioTransiver.stop(),this.audioTransiver=null)}addAllTraks(e){e.getTracks().forEach((e=>{this.peerConnection.addTransceiver(e,{direction:"sendonly"})}))}}n(956);const o=FtarLipsync.newInstance(),r=new Promise((async e=>{const t=await o;await t.startAudioContext(),console.log("audioContext",t.audioContext),e(t)}));let c,l,d,h;async function f(e,n){const i=await a(e),s=document.createElement("span");s.className="item-holder";const o=document.createElement("img");o.src=i,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",s.appendChild(o);const r=document.createElement("span");r.className="loader",d||(s.classList.add("selected-item"),d=s),n&&previewListHolder.childNodes.length>1?previewListHolder.insertBefore(s,previewListHolder.childNodes[2]):previewListHolder.appendChild(s),o.onclick=async()=>{d&&(console.log("remove class"),d.classList.remove("selected-item")),d=s,s.classList.add("selected-item"),s.appendChild(r);try{l.slot1=await t(e,g)}finally{r.remove()}}}!function(){const e=createFlexatarHolder,t=plusCircle,n=makeTextHolder;n.textContent=i.DROP_PHOTO;const a=makeOverlayElement;let s;!function(e,t){const n=document.createElement("input");n.type="file",n.accept="image/*",n.onchange=e=>t(),e.onclick=()=>{n.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=n=>{n.preventDefault(),e.classList.remove("hover");n.dataTransfer.files;t()}}(e,(async e=>{s&&(s(),s=null);const o=(t.style.display="none",n.style.display="none",a.style.display="block",()=>{t.style.display="block",n.style.display="block",a.style.display="none"});setTimeout((()=>{var e;o(),e=i.BAD_PHOTO,t.classList.add("rotated"),n.textContent=e,s=()=>{t.classList.remove("rotated"),n.textContent=i.DROP_PHOTO}}),3e3)}))}();let p,u,g,v=new MediaStream;window.addEventListener("message",(async e=>{let n=e.data;if(n.flexatar){if(n=n.flexatar,"reload_token"===n.type)u(n.token);else if(n.token){const e=new FtarView.GetToken((async()=>{console.log("reload token iframe");const e=new Promise((e=>{u=e}));return window.parent.postMessage({flexatar:{type:"reload_token"}},"*"),await e}));g=e;const n=await FtarView.flexatarList(e,{preview:!0});if(n.error)return;for(const e of n.reverse())await f(e);if(c=new FtarView.SDK(e),l=await c.getRenderer(),n.length>0){const e=n[0],a=await t(e,g);l.slot1=a,l.start()}l.canvas.width=240,l.canvas.height=320,l.canvas.style.display="none",document.body.appendChild(l.canvas);const a=l.canvas.captureStream(30);h=new s(window.parent,"iframe"),h.addAllTraks(a),window.parent.postMessage({flexatar:await h.offerMessage()},"*"),h.onaudioready=async e=>{const t=new Audio;t.srcObject=v,t.pause(),t.muted=!0,p&&v.removeTrack(p),p=e,v.addTrack(e);const n=await r;n.mediaStream=v,n.connect(l);const a=n.synchronizedStream();h.addAudioTrack(a.getAudioTracks()[0]),e.onended=()=>{console.log("Track has been stopped."),setTimeout((()=>{n.mediaStream=null,h.addAudioTrack(null),h.isNegotiating=!1}),700)},h.isNegotiating=!1}}"offer"===n.type?h.recvOffer(n):"ice-candidate"===n.type?h.addIceCandidate(n):"answer"===n.type&&h.recvAnswer(n)}}));let w=!1;trashButton.onclick=()=>{w?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),w=!w},confirmButton.onclick=async()=>{confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),w=!w}})()})();
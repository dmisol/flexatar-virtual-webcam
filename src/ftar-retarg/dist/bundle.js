(()=>{"use strict";async function e(e,t){const a=new FormData;Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t);return!!(await fetch(e.url,{method:"POST",body:a})).ok}class t{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}async function a(e,t="currentUserId"){if(e)return e;const a={};a[t]=null;const s=await chrome.storage.local.get(a);return s?s[t]:{error:"not_authorized"}}const s={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue",FTAR_FAV_LIST_ID:"_favorite_list",AUIDIO_RECORD_LIST_ID:"_audio_record_list"};async function r(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o].concat(t);return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function o(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=t;return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function n(e,t){const s=await a(t);if(s.error)return s;const r=s+e,o={};o[r]=[];return(await chrome.storage.local.get(o))[r]}async function i(e,t){const s=await a(t);if(s.error)return s;const r=s+e;await chrome.storage.local.remove([r])}const c={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_SPEECH_PATTERN:"_current_speech_pattern_",CURRENT_MOOD:"_current_mood_",RETARGETING_CALIBRATION:"_retargeting_calibration_",DO_NOT_SHOW_NOTIFICATION_ID:"_do_not_show_",RECORDED_AUDIO_ID:"_recorded_audio_"};async function l(e,t,s,r){const o=await a(r);if(o.error)return o;const n={};n[o+e+t]=s;try{return await chrome.storage.local.set(n),{success:!0}}catch(e){return{error:"unknown"}}}async function d(e,t,s,r=null){const o=await a(s);if(o.error)return o;const n=o+e+t,i={};i[n]=null;const c=await chrome.storage.local.get(i);return null===c[n]?r:c[n]}async function u(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e+t;await chrome.storage.local.remove([o])}async function g(e,t,a,s="id"){const r=await n(e,a);let i=t[s];i||(i=t);const c=r.filter((e=>(e[s]||e)!==i));await o(e,c,a)}async function f(e,t,a){let s=await n(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await u(c.FTAR_SRC_IMG,t.id,a)}await o(e,s,a)}async function h(e,t,s,r){await g(e,s,r),await async function(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.concat(i);return n[o]=c,await chrome.storage.local.set(n),{success:!0}}(t,[s],r)}async function m(e,t,a,s,r="id"){const i=await n(e,s);let c=t[r];c||(c=t);const l=i.filter((e=>(e[r]||e)===c));Object.assign(l[0],a),await o(e,i,s)}function p(e,t){return new Promise((a=>{const o=crypto.randomUUID();n(s.FTAR_BACKGROUND_LIST_ID,t).then((n=>{r(s.FTAR_BACKGROUND_LIST_ID,[o],t).then((s=>{l(c.BACKGROUND_SRC_IMAGE,o,e,t).then((e=>{a(o)}))}))}))}))}async function w(e){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===t)var t=self;"undefined"==typeof chrome&&(t.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const a="flexatar-storage-cache",s=e=>new Request(`https://flexatar-mock-storage/${e}`),r=e=>new URL(e).pathname.slice(1),o=await caches.open(a);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const a=JSON.stringify({value:t}),r=new Response(a,{headers:{"Content-Type":"application/json"}});await o.put(s(e),r)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const a={};if(null==e){const e=(await o.keys()).map((e=>r(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const r=await o.match(s(t));if(r){const e=await r.json();a[t]=e.value}else a[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(a),a},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>o.delete(s(e))));await Promise.all(t)},e&&await e()}}function _(...e){(new Date).toLocaleTimeString()}const I="ftarcache";async function R(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function y(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const E="https://api.flexatar-sdk.com";async function S(e,t){const a=E+"/"+e.id;t||(t=e.token);const s={};try{const e=await v(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:C}:{error:F}}catch(e){return!1}}async function T(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let o;if(_(),t.ftar)o=await fetch(t.ftar,{method:"GET"});else{const a=await k(t.is_myx?G:e,t.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const n=await o.arrayBuffer(),i=await D(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function D(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function P(e,t,a,s=0){const r=a+"_ftarpreview_"+e.id,o=(await chrome.storage.local.get([r]))[r];if(o)return await(await fetch(o)).arrayBuffer();if(e.preview){const t=await A(e,a);if(t)return t}const n=await k(t,e.id,{preview:!0});e.preview=n.preview;return await A(e,a)}async function A(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const r=await s.arrayBuffer(),o=await D(r),n={};return n[a]=o,_(),await chrome.storage.local.set(n),r}async function v(e,t,a,s){const r=await a.getToken();if("no_token"===r)return r;t.headers.Authorization="Bearer "+r;const o=await self.fetch(e,t);return 403!=o.status?o:(s||(s=2),s<=0?o:(s-=1,a.token=null,await v(e,t,a,s)))}const C="unauthorized",F="UNEXPECTED";async function M(e,t){const a=E+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const r=await v(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);if(!r.ok)return 401===r.status?{error:C}:{error:F};return(await r.json()).all}async function k(e,t,a){const s=E+"/list",r={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const n={};n[t]=o;try{const a=await v(s,{method:"POST",headers:r,body:JSON.stringify(n)},e);if(!a.ok)return 401===a.status?{error:C}:{error:F};return(await a.json()).requested[t]}catch(e){}}async function U(t,a,s,r,o){s||(s="");const n=E+"/make",i=await async function(t,a,s,r,o,n,i){const c=await n(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:r})},a);if(!c.ok)return{error:{status:c.status}};const l=await c.json();if(l.block)return{success:!1,reason:l.block};i&&await i(l.id);const d=l.link;if(!await e(d,s))return;let u=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(l.poll,{method:"GET"});if(!a.ok)return u+=1,void(u>10&&(clearInterval(t),e()));const s=await a.json();clearInterval(t),e(s)}),5e3)}))}(n,t,a,s,0,v,o);if(!i)return _(),{error:F};if(i.error)return 401===i.error.status?{error:C}:{error:F};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return r&&(c=r),await k(t,i.id,c)}async function L(e){_();const t=await v(E+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);if("no_token"===t)return{error:C};if(!t.ok)return 401===t.status?{error:C}:{error:F};return await t.json()}class N{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,_(),t}}async function O(e,t,a,s=!0){_();let r=await n(e,a);return r=r.map((e=>{const s={userId:a};return s[t]=e,s})),"myx@amial.com"!==a&&s&&(r=r.concat((await n(e,"myx@amial.com")).map((e=>{const a={userId:"myx@amial.com"};return a[t]=e,a})))),r}async function b(e,t,a,s=!0){let r=[];if("myx@amial.com"===a)t.opts.noCache=!1,r=await q(G,t,a,!1),r=r.reverse(),_();else if(r=await q(e,t,a,!1),r=r.reverse(),s){t.opts.noCache=!1;const e=await q(G,t,"myx@amial.com",!1);r=r.concat(e.reverse())}return r}async function x(e,t){if(!t)return;const a=e+"_ftarlist";let s=await y(a);s.push({id:t}),await R(a,s)}async function B(e){const t=[{caption:"ðŸ’¡ Warm Tone",prompt:"Soft golden light wraps around the face, brightening skin and adding a natural warmth. Subtle highlights on the forehead and cheeks create depth. The eyes gain a gentle amber reflection. The overall mood feels sunlit and inviting."},{caption:"ðŸŒ† Cool Tone",prompt:"A calm blue-gray tone softens the scene, giving the portrait a quiet cinematic feel. The skin tone shifts slightly toward cooler neutrals. Shadows contour the face with precise, modern clarity. Eyes reflect faint steel-blue hues."},{caption:"ðŸŒˆ Color Boost",prompt:"Colors appear more vivid and balanced, with deeper contrasts and sharper definition. Light glances across skin textures, giving life to every detail. Subtle chromatic tones enhance vitality. The effect feels crisp, clean, and refined."}];try{let a;if(e&&(a=await e.load()),a)return a;const s=await fetch("https://api.flexatar-sdk.com/aiprompt");return s.ok?(a=await s.json(),e.save(a),a):t}catch(e){return t}}const G=new N((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken/androidapp");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}())),W=new t,Q=new t;async function q(e,t,a,s=!1){return await W.enqueue((async()=>{const s=a+"_ftarlist";let r=t.opts.noCache?null:await y(s);return _(),r||(_(),r=await M(e,t.opts),r.error?_(r.error):await R(s,r)),r.forEach((e=>{e.userId=a})),r}))}async function K(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function j(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function z(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function V(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function H(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function J(e,t){const a=e+"_FtarCount",s={};s[a]=t,_(),await chrome.storage.local.set(s)}function $(e,t){const[a,s]=e.split(","),r=a.match(/:(.*?);/),o=r?r[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:o})}async function Z(e,t){_();const a=(await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,t))[0],r=E+"/poll",o=await async function(e,t,a,s){const r=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s})},t);return r.ok?await r.json():404===r.status?{status:"in_progress"}:{error:await r.text()}}(r,e,v,a.ftarId);return _(),o}function X(e,t="image/jpeg"){const a=function(e){let t="";const a=new Uint8Array(e),s=a.byteLength;for(let e=0;e<s;e++)t+=String.fromCharCode(a[e]);return ie.btoa(t)}(e);return`data:${t};base64,${a}`}async function Y(t,r,o){const i=await a(null,o);if(!await d(c.IS_QUEUE_IN_PROGRESS,"",i,!0))return void _();const l=await async function(e){const t=await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,e),a=await d(c.IS_QUEUE_IN_PROGRESS,"",e,!0);return _(),(0!==t.length||!a)&&t[0]}(i);if(_(),l)return void _();const u=(await n(s.FTAR_MAKE_QUEUE_LIST_ID,i))[0];if(u){_();const n=await a(null,o);await h(s.FTAR_MAKE_QUEUE_LIST_ID,s.FTAR_PROCESSING_QUEUE_LIST_ID,u,n);const i=E+"/make",l=await async function(e,t,a,s){let r=s?JSON.stringify({aiPrompt:JSON.parse(JSON.parse(s))}):void 0;const o=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:r},t);if(!o.ok)return{error:{type:"unknown",message:o.status}};const n=await o.json();return n.block?{error:{type:"block",reason:n.block}}:n}(i,t,v,u.aiPrompt);if(l.error)return _(),await h(s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_ERROR_LIST_ID,u,n),await f(s.FTAR_ERROR_LIST_ID,5,n),void(r&&r());_(l.id),await m(s.FTAR_PROCESSING_QUEUE_LIST_ID,u.id,{ftarId:l.id},n);const g=await d(c.FTAR_SRC_IMG,u.id,n);if(g){const t=$(g);await e(l.link,t)||await async function(){await h(s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_ERROR_LIST_ID,imgId,currentUserId),await f(s.FTAR_ERROR_LIST_ID,5,currentUserId)}()}}}async function ee(e){const t={successImages:s.FTAR_SUCCESS_LIST_ID,errorImages:s.FTAR_ERROR_LIST_ID,queueImages:s.FTAR_MAKE_QUEUE_LIST_ID},r="currentUserId",o=await a(null,r),i={};for(const[e,a]of Object.entries(t)){_();const t=await n(a,o);_();const s=t.map((async e=>await d(c.FTAR_SRC_IMG,e.id,o)));i[e]=await Promise.all(s)}const l=[s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of l){const t=(await n(e,o)).map((async e=>await d(c.FTAR_SRC_IMG,e.id,o))),a=await Promise.all(t);a&&a.length>0&&i.queueImages.unshift(a[0])}return _(),_(),i.flexatarCount=await H(o),i.isQueueInProgress=await d(c.IS_QUEUE_IN_PROGRESS,"",o,!0),i}const te=new t;function ae(e){if(_(),"undefined"!=typeof document){function t(){document.hidden?e({visible:!1}):e({visible:!0})}document.addEventListener("visibilitychange",t),document.hidden||e({visible:!0})}else self.addEventListener("message",(t=>{t.data.documentState&&e(t.data.documentState)})),self.postMessage({visibilityRequest:!0})}function se(e,t){const a=oe();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(r){r.data&&(_(r.data),r.data.msgID===a&&(s(r.data.payload),e.removeEventListener("message",t)))})),e.postMessage(t)}))}class re{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.animationPatternRequest?this.onAnimationPatternRequest&&this.onAnimationPatternRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=oe();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(r){r.data&&(_(r.data),r.data.msgID===t&&(s(r.data.payload),a.removeEventListener("message",e)))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}async showAnimate(){return await this.sendWithResponse({showAnimate:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async getSpeechPattern(){return await this.sendWithResponse({getSpeechPattern:!0})}async getMood(){return await this.sendWithResponse({getMood:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async setSpeechPattern(e){return await this.sendWithResponse({setSpeechPattern:e})}async setMood(e){return await this.sendWithResponse({setMood:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}async addToFavorite(e){return await this.sendWithResponse({addToFavorite:{value:e}})}async removeFromFavorite(e){return await this.sendWithResponse({removeFromFavorite:{value:e}})}async getFavorite(){return await this.sendWithResponse({getFavorite:!0})}async saveAudioEntry(e){return await this.sendWithResponse({saveAudioEntry:e})}async getRecordedAudioList(e="default"){return await this.sendWithResponse({getRecordedAudioList:e})}async deleteRecordedAudio(e){return await this.sendWithResponse({deleteRecordedAudio:e})}async getRecordedAudio(e){return await this.sendWithResponse({getRecordedAudio:e})}}function oe(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const ne={Manager:class{static clearCurrentUserId(){const e={currentUserId:null};chrome.storage.local.set(e)}constructor(e,t,r=async()=>[],o=!1,n=!1,c=!0){let l;_(),this.userIdKey=()=>"currentUserId";const d=this;n||(_(),l=w((async()=>{_();const e={};e[d.userIdKey()]=null,await chrome.storage.local.set(e)})),this.patchPromise=l),this.defaultBackgroundFn=r,this.managerName=t,this.tokenFn=e,this.needMyxAccount=c,_(),this.token=new N((async()=>await e())),o&&(l||Promise.resolve()).then((async()=>{for(;!d.managerName;)await new Promise((e=>setTimeout(e,200)));const e=await a(null,d.userIdKey());[s.FTAR_ERROR_LIST_ID,s.FTAR_SUCCESS_LIST_ID,s.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{i(t,e)}))})),ae((({visible:e})=>{e?d.setupPolling():d.cancelPolling()}))}cancelPolling(){_();const e=this;e.pollingInterval&&(clearInterval(e.pollingInterval),e.pollingInterval=null)}setupPolling(){const e=this;e.cancelPolling(),_(),e.pollingInterval=setInterval((async()=>{_();const t=await te.enqueue((async()=>await e.getUserInfo()));_();const r=await async function(e,t,r){const o=await a(null,t),i=await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,o);if(_(),0===i.length)return{status:"empty"};const d=i[0];if(d){d.firtsPollingAttemptAt||(_(),d.firtsPollingAttemptAt=Date.now(),await m(s.FTAR_PROCESSING_QUEUE_LIST_ID,d,{firtsPollingAttemptAt:d.firtsPollingAttemptAt},o));const t=await Z(e,o),a=Date.now()-d.firtsPollingAttemptAt;if(_(),t.success){_(d.id),await h(s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_SUCCESS_LIST_ID,d,o),await f(s.FTAR_SUCCESS_LIST_ID,5,o),await b(e,{opts:{}},o,r);const a=X(await P({id:d.ftarId},e,o));return await l(c.FTAR_SRC_IMG,d.id,a,o),{status:"ready",id:t.id}}return!1===t.success||t.error||a>2e5?(await h(s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_ERROR_LIST_ID,d,o),await f(s.FTAR_ERROR_LIST_ID,5,o),{status:"error"}):(_(),{status:"in_progress"})}}("myx@amial.com"===t.user_id?G:e.token,e.userIdKey(),e.needMyxAccount),o=await a(null,e.userIdKey());if("ready"===r.status&&(await x(o,r.id),await async function(e){await J(e,await H(e)-1)}(o),e.ports.forEach((e=>{e.postMessage({newFlexatar:{id:r.id,userId:o}})}))),"ready"===r.status||"error"===r.status){const t=await ee(e.managerName);_(),e.progressPorts.forEach((e=>{e.postMessage({progressLists:t})}))}if(0===(await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,o)).length){_();(await n(s.FTAR_MAKE_QUEUE_LIST_ID,o)).length>0&&(_(),e.ftarQueueDelegate(e.token,(()=>{e.progressPorts.forEach((async t=>{t.postMessage({progressLists:await ee(e.managerName)})}))}),e.userIdKey()))}}),15e3)}showAnimate(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)_(),t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)_(),t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;_(),t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}else if(a.slot1){const e=a.slot1;_(),t.ports.forEach((t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])}))}}}showRetarg(){this.retargPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?(_(),t.addPort(a.managerConnectionPort)):a.mediaPort&&t.onMediaPort(a.mediaPort))}}animPorts=[];showAnim(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}addAnimPort(e){const t=this;this.animPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(_(),a.managerConnectionPort?(_(),t.addPort(a.managerConnectionPort)):a.mediaPort?t.onMediaPort(a.mediaPort):a.animationPatternRequest&&(_(t.ports.length),t.ports.forEach((e=>{e.postMessage(a)}))))}}notificationPorts=[];addNotificationPort(e){this.notificationPorts.push(e),e.onmessage=async e=>{const t=e.data;if(t&&(_(),t.doNotShowOptionChanged)){const e="any_user@world.com";await l(c.DO_NOT_SHOW_NOTIFICATION_ID,t.doNotShowOptionChanged.notificationId,{value:!t.doNotShowOptionChanged.value},e)}}}async showNotification(e,t){let a=await d(c.DO_NOT_SHOW_NOTIFICATION_ID,e,"any_user@world.com",{value:!0});a=a||{value:!0},_(),a.value&&this.notificationPorts.forEach((a=>{a.postMessage({managerPort:!0,notificationText:t,notificationId:e})}))}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const r=a.data;if(!r)return;const o=await te.enqueue((async()=>await t.getUserInfo()));_();const n=o.user_id;if(r.progressLists){_(),r.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await ee(t.managerName);e.postMessage({progressLists:a})}else if(r.pauseMakeQueue)await l(c.IS_QUEUE_IN_PROGRESS,"",!1,n);else if(r.clearMakeQueue){await i(s.FTAR_MAKE_QUEUE_LIST_ID,n);const a=await ee(t.managerName);e.postMessage({progressLists:a})}else r.startMakeQueue&&(await l(c.IS_QUEUE_IN_PROGRESS,"",!0,n),t.ftarQueueDelegate(t.token,(async()=>{const a=await ee(t.managerName);_(),e.postMessage({progressLists:a})}),t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const s="currentUserId";_();const r=await a(null,this.userIdKey());if(r||(this.token.token=null),_(),r&&!t){const e=r+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:r,FtarCount:t}}let o=await L(this.token);_(),o.error&&(o={FtarCount:"100",user_id:"myx@amial.com"});const n=o.user_id,i={};return i[s]=n,await chrome.storage.local.set(i),await J(n,o.FtarCount),o}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await te.enqueue((async()=>await t.getUserInfo()));await se(a,{managerPort:!0}),_(),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=Y;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async o=>{const n=o.data;if(!n)return;await te.enqueue((async()=>await t.getUserInfo()));if(n.imagesList){const e=n.imagesList;_();const o=e.map((e=>({aiPrompt:n.aiPrompt,id:e.id}))),i=await a(null,t.userIdKey()),d="myx@amial.com"===i?G:t.token;await r(s.FTAR_MAKE_QUEUE_LIST_ID,o,i);for(const{dataUrl:t,id:a}of e){await l(c.FTAR_SRC_IMG,a,t,i);_()}_(),t.ftarQueueDelegate(d,(async()=>{t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await ee(t.managerName)})}))}),t.userIdKey()),t.showProgress()}else n.needAuthorize?t.onNeedAuthorize():n.closing?t.lensPorts=t.lensPorts.filter((t=>t!==e)):n.aiPromptsRequest&&(_(),e.postMessage({promptList:await B({load:async()=>{const e=await d("AI_PROMPTS","","no_user");return _(),e},save:async e=>{_(),await l("AI_PROMPTS","",e,"no_user")}})}))}}onNeedAuthorize=()=>{_()};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async o=>{const f=o.data;if(!f)return;_();const h=await te.enqueue((async()=>(_(),await t.getUserInfo())));if(h.error)return _(h.error),void e.postMessage({msgID:f.msgID,payload:h});const w=h.user_id,I={};if(I[w]=t.token,I["myx@amial.com"]=G,_(),f.ftarList){const a=await b(t.token,f,w,t.needMyxAccount);e.postMessage({msgID:f.msgID,payload:a})}else if(f.backgroundsList)Q.enqueue((async()=>{if("empty"===t.managerName)return void e.postMessage({msgID:f.msgID,payload:[]});const a=f.opts??{};let r;if(r=a.id?[{id:a.id,userId:a.userId}]:await O(s.FTAR_BACKGROUND_LIST_ID,"id",w,t.needMyxAccount),!r||0===r.length){_();const e=await t.defaultBackgroundFn();_();for(const t of e)await p(t,w);r=await O(s.FTAR_BACKGROUND_LIST_ID,"id",w,t.needMyxAccount)}const o=[];for(const{id:e,userId:t}of r){const a=await d(c.BACKGROUND_SRC_IMAGE,e,t);o.push([{id:e,userId:t},a])}e.postMessage({msgID:f.msgID,payload:o})}));else if(f.preview){_(f.preview);let t=await P({id:f.preview.id},I[f.preview.userId],f.preview.userId);if(!t)return void e.postMessage({msgID:f.msgID,payload:null});e.postMessage({msgID:f.msgID,payload:t},[t])}else if(f.flexatar){_(f.flexatar);let t=await T(I[f.flexatar.userId],{id:f.flexatar.id,is_myx:!1},f.flexatar.userId);if(_(),!t)return void e.postMessage({msgID:f.msgID,payload:null});f.setAsCurrent&&(_(f.flexatar),await K(f.flexatar,w)),f.setAsCurrentSlot2&&(_(f.flexatar),await j(f.flexatar,w)),_(),e.postMessage({msgID:f.msgID,payload:t},[t])}else if(f.closing)t.ports=t.ports.filter((t=>t!==e)),e.close();else if(f.storeNewBackground){const t=await p(f.storeNewBackground,w);e.postMessage({msgID:f.msgID,payload:{id:t,userId:w}}),e.postMessage({newBackGround:{id:t,userId:w}})}else if(f.getCurrentBkg){let t=await d(c.BACKGROUND_CURRENT_ID,"",w);t||(t=await d(c.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&f.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await d(c.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:f.msgID,payload:t})}else if(f.deleteBackground)g(s.FTAR_BACKGROUND_LIST_ID,f.deleteBackground,w),u(c.BACKGROUND_SRC_IMAGE,f.deleteBackground,w),e.postMessage({msgID:f.msgID,payload:{result:"success"}});else if(f.setCurrentBkg)l(c.BACKGROUND_CURRENT_ID,"",f.setCurrentBkg,w),e.postMessage({msgID:f.msgID,payload:{result:"success"}});else if(f.getSelectedFtar){const t=w+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:f.msgID,payload:{selectedFtar:a}})}else if(f.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(f.setSelectedFtar.value,w),e.postMessage({msgID:f.msgID,payload:{}});else if(f.currentFtarSlot2){f.opts={preview:!0};let a=await z(w);if(!a){const e=await b(t.token,f,w,t.needMyxAccount);await j(e[0],w)}a=await z(w),_(),e.postMessage({msgID:f.msgID,payload:a})}else if(f.currentFtar){f.opts={preview:!0},_();let a=await V(w);if(!a){_();const e=await b(t.token,f,w,t.needMyxAccount);await K(e[0],w)}a=await V(w),_(),e.postMessage({msgID:f.msgID,payload:a})}else if(f.makeFlexatar)_(),this.lensPorts.forEach((async e=>{await se(e,{managerPort:!0}),_(),e.postMessage({imageBuffer:f.buffer},[f.buffer])})),e.postMessage({msgID:f.msgID,payload:{status:"ok"}});else if(f.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await y(a);return s=s.filter((({id:e})=>t!==e)),await R(a,s),{isAuthorized:!0}}(w,f.deleteFlexatar),a="myx@amial.com"===w?(_(),!0):await S({id:f.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(f.deleteFlexatar,w),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(w)),e.postMessage({msgID:f.msgID,payload:{success:a}})}else if(f.userInfo)f.opts?e.postMessage({msgID:f.msgID,payload:await t.getUserInfo(f.opts)}):e.postMessage({msgID:f.msgID,payload:h});else if(f.decrementFtarCount)await J(w,h.FtarCount-1),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.animationPatternResponse)_(f.animationPatternResponse),t.animPorts.forEach((e=>{e.postMessage(f)}));else if(f.effectStateResponse)_(),t.effectPorts.forEach((e=>{e.postMessage(f)}));else if(f.showAnimate)t.showAnimate();else if(f.showRetarg)t.showRetarg();else if(f.showEffects)t.showEffects();else if(f.showProgress)t.showProgress();else if(f.setRetargetingStatus)await l(c.RETARGETING_STATUS,"",f.setRetargetingStatus,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getRetargetingStatus){let t=await d(c.RETARGETING_STATUS,"",w);e.postMessage({msgID:f.msgID,payload:t?t.value:null})}else if(f.setRetargetingCalibration)await l(c.RETARGETING_CALIBRATION,"",f.setRetargetingCalibration,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getRetargetingCalibration){let t=await d(c.RETARGETING_CALIBRATION,"",w);e.postMessage({msgID:f.msgID,payload:t})}else if(f.setViewportSize)await l(c.CURRENT_VIEWPORT_SIZE,"",f.setViewportSize,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getViewportSize){let t=await d(c.CURRENT_VIEWPORT_SIZE,"",w,{width:320,height:640});_(),e.postMessage({msgID:f.msgID,payload:t||{width:640,height:480}})}else if(f.setSpeechPattern)await l(c.CURRENT_SPEECH_PATTERN,"",f.setSpeechPattern,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getSpeechPattern){let t=await d(c.CURRENT_SPEECH_PATTERN,"",w,{value:"calm"});e.postMessage({msgID:f.msgID,payload:t||{value:"calm"}})}else if(f.setMood)await l(c.CURRENT_MOOD,"",f.setMood,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getMood){let t=await d(c.CURRENT_MOOD,"",w,{value:"friendly"});e.postMessage({msgID:f.msgID,payload:t||{value:"friendly"}})}else if(f.getFavorite){const t=await n(s.FTAR_FAV_LIST_ID,w);e.postMessage({msgID:f.msgID,payload:t})}else if(f.removeFromFavorite){const t=f.removeFromFavorite.value;await g(s.FTAR_FAV_LIST_ID,{id:t},w),e.postMessage({msgID:f.msgID,payload:{success:!0}})}else if(f.addToFavorite){const t=f.addToFavorite.value;await async function(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.filter((e=>!i.includes(e)));return c.length>0&&(n[o]=i.concat(c),await chrome.storage.local.set(n)),{success:!0,addedCount:c.length}}(s.FTAR_FAV_LIST_ID,[{id:t}],w),e.postMessage({msgID:f.msgID,payload:{success:!0}})}else if(f.getRecordedAudio){const t=await d(c.RECORDED_AUDIO_ID,f.getRecordedAudio.id,w);e.postMessage({msgID:f.msgID,payload:t})}else if(f.deleteRecordedAudio)await g(s.AUIDIO_RECORD_LIST_ID+"_"+f.deleteRecordedAudio.folder,f.deleteRecordedAudio,w),await u(c.RECORDED_AUDIO_ID,f.deleteRecordedAudio.id,w),e.postMessage({msgID:f.msgID,payload:{success:!0}});else if(f.getRecordedAudioList){const t=await n(s.AUIDIO_RECORD_LIST_ID+"_"+f.getRecordedAudioList,w);e.postMessage({msgID:f.msgID,payload:t})}else if(f.saveAudioEntry){const t=f.saveAudioEntry.folder,a=f.saveAudioEntry.dataUrl;f.saveAudioEntry.dataUrl=void 0,f.saveAudioEntry.folder=void 0,a?(await r(s.AUIDIO_RECORD_LIST_ID+"_"+t,[f.saveAudioEntry],w),await l(c.RECORDED_AUDIO_ID,f.saveAudioEntry.id,a,w)):await m(s.AUIDIO_RECORD_LIST_ID+"_"+t,f.saveAudioEntry.id,f.saveAudioEntry,w),e.postMessage({msgID:f.msgID,payload:{success:!0}})}else if(f.deleteEffectPreset){const t=(await n(s.FTAR_PRESET_LIST_ID,f.deleteEffectPreset.userId)).filter((e=>e.presetId!==f.deleteEffectPreset.presetId));await i(s.FTAR_PRESET_LIST_ID,f.deleteEffectPreset.userId),await r(s.FTAR_PRESET_LIST_ID,t,f.deleteEffectPreset.userId),e.postMessage({msgID:f.msgID,payload:{success:!0}})}else if(f.getEffectPresets){const a=await O(s.FTAR_PRESET_LIST_ID,"presetInfo",w,t.needMyxAccount);e.postMessage({msgID:f.msgID,payload:a})}else if(f.saveEffectPreset)await r(s.FTAR_PRESET_LIST_ID,[f.saveEffectPreset],w),e.postMessage({msgID:f.msgID,payload:{success:{userId:w}}});else if(f.getManagerName)e.postMessage({msgID:f.msgID,payload:t.managerName});else if(f.getUserToken){const a="myx@amial.com"===w?await G.getToken():await t.tokenFn();e.postMessage({msgID:f.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){_(),this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}},ManagerConnection:re,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(I);let r=await s.match(a);if(!r){const o=await k(e,t.id,{ftar:!0});if(r=await fetch(o.ftar,{method:"GET"}),!r.ok)return;const n=await r.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await r.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(I);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const r=await s.arrayBuffer(),o=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,o),r}return await s.arrayBuffer()},flexatarList:M,makeFlexatar:U,deleteFlexatar:S,flexatarEntry:k,userInfo:L,GetToken:N,ERR_UNAUTHORIZED:C,ERR_UNEXPECTED:F};if(void 0===ie)var ie=self;ie.Ftar=ne;const ce=new re,le=Math.floor(200),de=new class{constructor(e){const t=document.createElement("canvas");t.width=e?.width??240,t.height=e?.height??320,t.style.display="none",this.canvas=t,t.flexatarCanvas=!0,document.body.appendChild(t);const a=t.getContext("bitmaprenderer");this.ctx=a;const s=function(e,t,a){const s=new OffscreenCanvas(t,a),r=s.getContext("2d");return r.fillStyle="black",r.fillRect(0,0,t,a),r.fillStyle="white",r.font=`${Math.floor(t/10)}px sans-serif`,r.textAlign="center",r.textBaseline="middle",r.fillText(e,t/2,a/2),s.transferToImageBitmap()}("WARMING UP",t.width,t.height);a.transferFromImageBitmap(s);const r=new MessageChannel;this.mediaPort=r.port2,this.selfPort=r.port1;let o=!0;this.isActive=!0;const n=this;r.port1.onmessage=e=>{e.data&&e.data.frame?(o&&(o=!1,this.#t()),this.isActive&&(a.transferFromImageBitmap(e.data.frame),e.data.frame.close())):e.data&&e.data.cameraFrame?(n.onCameraFrame(e.data.cameraFrame),e.data.cameraFrame.close()):e.data&&e.data.canvasRatio?n.onCanvasRatio&&n.onCanvasRatio(e.data.canvasRatio):e.data&&e.data.log}}setFrame(e){this.ctx.transferFromImageBitmap(e)}get portToSend(){return this.mediaPort}get port(){return this.selfPort}get stream(){return this.canvas.captureStream(30)}#t=()=>{};set onFirstFrame(e){this.#t=e}destroy(){this.selfPort.postMessage({closing:!0}),this.canvas.remove()}bindFrameReceiverFromLandmarker(){this.selfPort.postMessage({bindFrameReceiverFromLandmarker:!0})}unBindFrameReceiverFromLandmarker(){this.selfPort.postMessage({unBindFrameReceiverFromLandmarker:!0})}set size(e){this.canvas.width=e.width,this.canvas.height=e.height}}({width:le,height:le});previewHolder.appendChild(de.canvas),de.canvas.style.display="block",de.canvas.classList.add("mirror-x"),de.onFirstFrame=()=>{de.bindFrameReceiverFromLandmarker()};const ue=document.createElement("span");ue.classList.add("dummy-camera-preview"),previewHolder.appendChild(ue);const ge=document.createElement("button");ge.textContent="ENABLE",calibrateRetarget.disabled=!0,ge.classList.add("camera-enable-button"),ue.appendChild(ge);const fe=document.createElement("canvas");fe.classList.add("mirror-x"),fe.width=1,fe.height=1,ue.appendChild(fe);const he=fe.getContext("bitmaprenderer");let me=0,pe=0;let we,_e,Ie,Re=0,ye=0;function Ee(){window.parent.postMessage({closeWindow:!0,portSelf:_e,instanceId:we},"*",[_e])}de.onCameraFrame=e=>{if(Re!==e.width||ye!==e.height){Re=e.width,ye=e.height;const{width:t,height:a}=function(e,t,a,s){if(![e,t,a,s].every((e=>Number.isFinite(e)&&e>0)))throw new Error("All dimensions must be positive finite numbers.");const r=Math.min(e/a,t/s);return{width:Math.floor(a*r),height:Math.floor(s*r)}}(me,pe,e.width,e.height);fe.width=t,fe.height=a,Se=!0,ge.textContent="DISABLE",calibrateRetarget.disabled=!1}he.transferFromImageBitmap(e)},de.onCanvasRatio=e=>{uiHolder.classList.remove("invisible");const t=le,a=Math.floor(t/e);me=t,pe=a,de.canvas.width=t,de.canvas.height=a,ue.style.width=t+"px",ue.style.height=a+"px"},window.onmessage=e=>{const t=e.data;t&&(t.managerPort?(we=t.instanceId,_e=t.managerPort,_e.postMessage({effectStateRequest:!0}),t.managerPort.postMessage({managerConnectionPort:ce.outPort},[ce.outPort]),t.managerPort.postMessage({mediaPort:de.portToSend},[de.portToSend])):t.closeThisWindow&&Ee())},closeButton.onclick=()=>{de.unBindFrameReceiverFromLandmarker(),de.destroy(),Ee()};let Se=!1;calibrateRetarget.disabled=!0,ce.ready.then((()=>{ge.onclick=()=>{Se?(de.selfPort.postMessage({videoStreamFromCameraStopRequest:!0}),ge.textContent="ENABLE",calibrateRetarget.disabled=!0):(de.selfPort.postMessage({videoStreamFromCameraRequest:Ie}),ge.textContent="DISABLE",calibrateRetarget.disabled=!1),Se=!Se},calibrateRetarget.onclick=()=>{de.selfPort.postMessage({calibrateRetargeting:!0})},async function(e,t){if(!e)throw new Error("Container element is required.");const a=await ce.getRetargetingStatus(),s=document.createElement("select");s.classList.add("camera-select"),s.disabled=!0,e.appendChild(s);try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>e.stop()));const e=await navigator.mediaDevices.enumerateDevices(),r=e.filter((e=>"videoinput"===e.kind));s.innerHTML="",r.forEach(((e,t)=>{const a=document.createElement("option");a.textContent=e.label||`Camera ${t+1}`,a.value=a.textContent,s.appendChild(a)})),s.disabled=!1,s.addEventListener("change",(()=>{"function"==typeof t&&t(s.value)}));let o=r.find((e=>e.label===a));return!o&&r.length>0&&(o=r[0],await ce.setRetargetingStatus({value:o.label})),Ie=o.label,!!o&&(s.value=o.label,"function"==typeof t&&t(o.label),!0)}catch(e){return!1}}(ue,(async e=>{Ie=e,Se&&(de.selfPort.postMessage({videoStreamFromCameraStopRequest:!0}),setTimeout((()=>{de.selfPort.postMessage({videoStreamFromCameraRequest:Ie})}),500))})).then((e=>{const t="undefined"!=typeof MediaStreamTrackProcessor;e||(noCameraSign.classList.remove("invisible"),effectControlLayout.classList.add("invisible")),t||(noTrackProcessorSign.classList.remove("invisible"),effectControlLayout.classList.add("invisible")),uiHolder.classList.remove("invisible")}))}))})();
(()=>{"use strict";async function e(e,t,a,s,r,o,n){const i=await o(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},t);if(!i.ok)return{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const l=c.link;if(!await async function(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),!!(await fetch(e.url,{method:"POST",body:a})).ok}(l,a))return;let f=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return f+=1,void(f>10&&(clearInterval(t),e()));const s=await a.json();clearInterval(t),e(s)}),5e3)}))}class t{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}async function a(e,t="currentUserId"){if(e)return e;const a={};a[t]=null;const s=await chrome.storage.local.get(a);return s?s[t]:{error:"not_authorized"}}const s={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue"};async function r(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o].concat(t);return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function o(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=t;return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function n(e,t){const s=await a(t);if(s.error)return s;const r=s+e,o={};o[r]=[];return(await chrome.storage.local.get(o))[r]}async function i(e,t){const s=await a(t);if(s.error)return s;const r=s+e;await chrome.storage.local.remove([r])}async function c(e,t){const s=await a(t);if(s.error)return s;const r=s+e;(await chrome.storage.local.get([r]))[r]}async function l(e){for(const[t,a]of Object.entries(s))c(a,e)}const f={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",RETARGETING_CALIBRATION:"_retargeting_calibration_"};async function d(e,t,s,r){const o=await a(r);if(o.error)return o;const n={};n[o+e+t]=s;try{return await chrome.storage.local.set(n),{success:!0}}catch(e){return{error:"unknown"}}}async function u(e,t,s,r=null){const o=await a(s);if(o.error)return o;const n=o+e+t,i={};i[n]=null;const c=await chrome.storage.local.get(i);return null===c[n]?r:c[n]}async function g(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e+t;await chrome.storage.local.remove([o])}async function h(e,t,a,s="id"){const r=await n(e,a);let i=t[s];i||(i=t);const c=r.filter((e=>(e[s]||e)!==i));await o(e,c,a)}async function m(e,t,a){let s=await n(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await g(f.FTAR_SRC_IMG,t.id,a)}await o(e,s,a)}async function w(e,t,s,r){await h(e,s,r),await async function(e,t,s){const r=await a(s);if(r.error)return r;const o=r+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.concat(i);return n[o]=c,await chrome.storage.local.set(n),{success:!0}}(t,[s],r)}function p(e,t){return new Promise((a=>{const o=crypto.randomUUID();n(s.FTAR_BACKGROUND_LIST_ID,t).then((n=>{r(s.FTAR_BACKGROUND_LIST_ID,[o],t).then((s=>{d(f.BACKGROUND_SRC_IMAGE,o,e,t).then((e=>{a(o)}))}))}))}))}async function I(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===e)var e=self;"undefined"==typeof chrome&&(e.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const t="flexatar-storage-cache",a=e=>new Request(`https://flexatar-mock-storage/${e}`),s=e=>new URL(e).pathname.slice(1),r=await caches.open(t);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const s=JSON.stringify({value:t}),o=new Response(s,{headers:{"Content-Type":"application/json"}});await r.put(a(e),o)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const o={};if(null==e){const e=(await r.keys()).map((e=>s(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const s=await r.match(a(t));if(s){const e=await s.json();o[t]=e.value}else o[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(o),o},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>r.delete(a(e))));await Promise.all(t)}}}const _="ftarcache";async function E(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function y(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const R="https://api.flexatar-sdk.com";async function S(e,t){const a=R+"/"+e.id;t||(t=e.token);const s={};try{const e=await D(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:k}:{error:C}}catch(e){return!1}}async function v(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let o;if(t.ftar)o=await fetch(t.ftar,{method:"GET"});else{const a=await F(t.is_myx?b:e,t.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const n=await o.arrayBuffer(),i=await T(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function T(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function P(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const r=await s.arrayBuffer(),o=await T(r),n={};return n[a]=o,await chrome.storage.local.set(n),r}async function D(e,t,a,s){t.headers.Authorization="Bearer "+await a.getToken();const r=await fetch(e,t);return 403!=r.status?r:(s||(s=2),s<=0?r:(s-=1,a.token=null,await D(e,t,a,s)))}const k="unauthorized",C="UNEXPECTED";async function M(e,t){const a=R+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const r=await D(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);if(!r.ok)return 401===r.status?{error:k}:{error:C};return(await r.json()).all}async function F(e,t,a){const s=R+"/list",r={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const n={};n[t]=o;try{const a=await D(s,{method:"POST",headers:r,body:JSON.stringify(n)},e);if(!a.ok)return 401===a.status?{error:k}:{error:C};return(await a.json()).requested[t]}catch(e){}}async function L(t,a,s,r,o){s||(s="");const n=R+"/make",i=await e(n,t,a,s,0,D,o);if(!i)return{error:C};if(i.error)return 401===i.error.status?{error:k}:{error:C};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return r&&(c=r),await F(t,i.id,c)}async function A(e){const t=await D(R+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);if(!t.ok)return 401===t.status?{error:k}:{error:C};return await t.json()}class B{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,t}}async function U(e,t,a){let s=await n(e,a);return s=s.map((e=>{const s={userId:a};return s[t]=e,s})),"myx@amial.com"!==a&&(s=s.concat((await n(e,"myx@amial.com")).map((e=>{const a={userId:"myx@amial.com"};return a[t]=e,a})))),s}async function N(e,t,a){let s=[];if("myx@amial.com"===a)t.opts.noCache=!1,s=await G(b,t,a,!1),s=s.reverse();else{s=await G(e,t,a,!1),s=s.reverse(),t.opts.noCache=!1;const r=await G(b,t,"myx@amial.com",!1);s=s.concat(r.reverse())}return s}const b=new B((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}())),x=new t;async function G(e,t,a,s=!1){return await x.enqueue((async()=>{const s=a+"_ftarlist";let r=t.opts.noCache?null:await y(s);return r||(r=await M(e,t.opts),r.error?r.error:await E(s,r)),r.forEach((e=>{e.userId=a})),r}))}async function O(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function Q(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function W(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function q(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function K(e){await z(e,await j(e)-1)}async function j(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function z(e,t){const a=e+"_FtarCount",s={};s[a]=t,await chrome.storage.local.set(s)}async function H(e,t,r){const o=await a(null,r),i=await u(f.FTAR_SRC_IMG,t.id,o);if(i){const a=function(e,t){const[a,s]=e.split(","),r=a.match(/:(.*?);/),o=r?r[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:o})}(i),r=(await w(s.FTAR_MAKE_QUEUE_LIST_ID,s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,t,o),await L(e,a,"noname",{ftar:!0,preview:!0},(async e=>{t.ftarId=e;await w(s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,s.FTAR_PROCESSING_QUEUE_LIST_ID,t,o);l(o)})));if(r.error||r.err){if("queue_limit"===r.reason)return r;const e=await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,o);await w(e.length>0?s.FTAR_PROCESSING_QUEUE_LIST_ID:s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,s.FTAR_ERROR_LIST_ID,t,o),await m(s.FTAR_ERROR_LIST_ID,5,o)}else{await w(s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_SUCCESS_LIST_ID,t,o),await m(s.FTAR_SUCCESS_LIST_ID,5,o);try{await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await y(a);s.push({id:t}),await E(a,s)}(o,r.id),await P(r,o),await v(e,r,o)}catch{}}return r.userId=o,l(o),r}}async function V(e,t,r){const o=await a(null,r),i=await n(s.FTAR_MAKE_QUEUE_LIST_ID,o);if("not_authorized"===i.error)return{error:i.error};const c=await n(s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,o),l=await n(s.FTAR_PROCESSING_QUEUE_LIST_ID,o),d=await u(f.IS_QUEUE_IN_PROGRESS,"",o,!0);if(0!==c.length||0!==l.length||!d)return{};if(i.length>0){const a=await H(e,i[0],r);return t(a),await V(e,t,r)}return{}}async function Z(e){const t={successImages:s.FTAR_SUCCESS_LIST_ID,errorImages:s.FTAR_ERROR_LIST_ID,queueImages:s.FTAR_MAKE_QUEUE_LIST_ID},r="currentUserId",o=await a(null,r),i={};for(const[e,a]of Object.entries(t)){const t=await n(a,o),s=t.map((async e=>await u(f.FTAR_SRC_IMG,e.id,o)));i[e]=await Promise.all(s)}const c=[s.FTAR_PROCESSING_QUEUE_LIST_ID,s.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of c){const t=(await n(e,o)).map((async e=>await u(f.FTAR_SRC_IMG,e.id,o))),a=await Promise.all(t);a&&a.length>0&&i.queueImages.unshift(a[0])}return i.flexatarCount=await j(o),i.isQueueInProgress=await u(f.IS_QUEUE_IN_PROGRESS,"",o,!0),i}const J=new t;function Y(e,t){const a=$();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(r){r.data&&r.data.msgID===a&&(s(r.data.payload),e.removeEventListener("message",t))})),e.postMessage(t)}))}class X{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=$();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(r){r.data&&r.data.msgID===t&&(s(r.data.payload),a.removeEventListener("message",e))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}}function $(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const ee={Manager:class{static clearCurrentUserId(){const e={currentUserId:null};chrome.storage.local.set(e)}constructor(e,t,r=async()=>[],o=!1,n=!1,c=!0){let l;n||(l=I(),this.patchPromise=l),this.defaultBackgroundFn=r,this.managerName=t,this.userIdKey=()=>"currentUserId",this.tokenFn=e,this.needMyxAccount=c,this.token=new B((async()=>await e()));const f=this;o&&(l||Promise.resolve()).then((async()=>{for(;!f.managerName;)await new Promise((e=>setTimeout(e,200)));const e=await a(null,f.userIdKey());[s.FTAR_ERROR_LIST_ID,s.FTAR_SUCCESS_LIST_ID,s.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{i(t,e)}))}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}else if(a.slot1){const e=a.slot1;t.ports.forEach((t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])}))}}}showRetarg(){this.retargPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?t.addPort(a.managerConnectionPort):a.mediaPort&&t.onMediaPort(a.mediaPort))}}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const r=a.data;if(!r)return;const o=await J.enqueue((async()=>await t.getUserInfo())),n=o.user_id;if(r.progressLists){r.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await Z(t.managerName);e.postMessage({progressLists:a})}else if(r.pauseMakeQueue)await d(f.IS_QUEUE_IN_PROGRESS,"",!1,n);else if(r.clearMakeQueue){await i(s.FTAR_MAKE_QUEUE_LIST_ID,n);const a=await Z(t.managerName);e.postMessage({progressLists:a})}else r.startMakeQueue&&(await d(f.IS_QUEUE_IN_PROGRESS,"",!0,n),t.ftarQueueDelegate(t.token,(async a=>{a.err||a.error||(await K(n),t.ports.forEach((e=>{e.postMessage({newFlexatar:a})})));const s=await Z(t.managerName);e.postMessage({progressLists:s})}),t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const a="currentUserId",s={};s[a]=null;const r=(await chrome.storage.local.get(s))[a];if(r||(this.token.token=null),r&&!t){const e=r+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:r,FtarCount:t}}let o=await A(this.token);if(o.error&&(o=await A(b),o.error))return o;const n=o.user_id,i={};return i[a]=n,await chrome.storage.local.set(i),await z(n,o.FtarCount),o}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await J.enqueue((async()=>await t.getUserInfo()));await Y(a,{managerPort:!0}),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=V;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async o=>{const n=o.data;if(!n)return;await J.enqueue((async()=>await t.getUserInfo()));if(n.imagesList){const e=n.imagesList,o=e.map((e=>({id:e.id}))),i=await a(null,t.userIdKey()),c="myx@amial.com"===i?b:t.token;await r(s.FTAR_MAKE_QUEUE_LIST_ID,o,i);for(const{dataUrl:t,id:a}of e){await d(f.FTAR_SRC_IMG,a,t,i)}t.ftarQueueDelegate(c,(async e=>{e.err&&!e.error||(await K(await a(null,t.userIdKey())),e.userId=i,t.ports.forEach((t=>{t.postMessage({newFlexatar:e})}))),t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await Z(t.managerName)})}))}),t.userIdKey()),t.showProgress()}else n.needAuthorize?t.onNeedAuthorize():n.closing&&(t.lensPorts=t.lensPorts.filter((t=>t!==e)))}}onNeedAuthorize=()=>{};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const o=a.data;if(!o)return;const c=await J.enqueue((async()=>await t.getUserInfo()));if(c.error)return void e.postMessage({msgID:o.msgID,payload:c});const l=c.user_id,m={};if(m[l]=t.token,m["myx@amial.com"]=b,o.ftarList){const a=await N(t.token,o,l);e.postMessage({msgID:o.msgID,payload:a})}else if(o.backgroundsList){if("empty"===t.managerName)return void e.postMessage({msgID:o.msgID,payload:[]});const a=o.opts??{};let r;if(r=a.id?[{id:a.id,userId:a.userId}]:await U(s.FTAR_BACKGROUND_LIST_ID,"id",l),!r||0===r.length){const e=await t.defaultBackgroundFn();for(const t of e)await p(t,l);r=await U(s.FTAR_BACKGROUND_LIST_ID,"id",l)}const n=[];for(const{id:e,userId:t}of r){const a=await u(f.BACKGROUND_SRC_IMAGE,e,t);n.push([{id:e,userId:t},a])}e.postMessage({msgID:o.msgID,payload:n})}else if(o.preview){o.preview;let t=await async function(e,t,a){const s=a+"_ftarpreview_"+e.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();if(e.preview){const t=await P(e,a);if(t)return t}const o=await F(t,e.id,{preview:!0});return e.preview=o.preview,await P(e,a)}({id:o.preview.id},m[o.preview.userId],o.preview.userId);if(!t)return void e.postMessage({msgID:o.msgID,payload:null});e.postMessage({msgID:o.msgID,payload:t},[t])}else if(o.flexatar){o.flexatar;let t=await v(m[o.flexatar.userId],{id:o.flexatar.id,is_myx:!1},o.flexatar.userId);if(!t)return void e.postMessage({msgID:o.msgID,payload:null});o.setAsCurrent&&(o.flexatar,await O(o.flexatar,l)),o.setAsCurrentSlot2&&(o.flexatar,await Q(o.flexatar,l)),e.postMessage({msgID:o.msgID,payload:t},[t])}else if(o.closing)t.ports=t.ports.filter((t=>t!==e)),e.close();else if(o.storeNewBackground){const t=await p(o.storeNewBackground,l);e.postMessage({msgID:o.msgID,payload:{id:t,userId:l}}),e.postMessage({newBackGround:{id:t,userId:l}})}else if(o.getCurrentBkg){let t=await u(f.BACKGROUND_CURRENT_ID,"",l);t||(t=await u(f.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&o.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await u(f.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:o.msgID,payload:t})}else if(o.deleteBackground)h(s.FTAR_BACKGROUND_LIST_ID,o.deleteBackground,l),g(f.BACKGROUND_SRC_IMAGE,o.deleteBackground,l),e.postMessage({msgID:o.msgID,payload:{result:"success"}});else if(o.setCurrentBkg)d(f.BACKGROUND_CURRENT_ID,"",o.setCurrentBkg,l),e.postMessage({msgID:o.msgID,payload:{result:"success"}});else if(o.getSelectedFtar){const t=l+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:o.msgID,payload:{selectedFtar:a}})}else if(o.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(o.setSelectedFtar.value,l),e.postMessage({msgID:o.msgID,payload:{}});else if(o.currentFtarSlot2){o.opts={preview:!0};let a=await W(l);if(!a){const e=await N(t.token,o,l);await Q(e[0],l)}a=await W(l),e.postMessage({msgID:o.msgID,payload:a})}else if(o.currentFtar){o.opts={preview:!0};let a=await q(l);if(!a){const e=await N(t.token,o,l);await O(e[0],l)}a=await q(l),e.postMessage({msgID:o.msgID,payload:a})}else if(o.makeFlexatar)this.lensPorts.forEach((async e=>{await Y(e,{managerPort:!0}),e.postMessage({imageBuffer:o.buffer},[o.buffer])})),e.postMessage({msgID:o.msgID,payload:{status:"ok"}});else if(o.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await y(a);return s=s.filter((({id:e})=>t!==e)),await E(a,s),{isAuthorized:!0}}(l,o.deleteFlexatar),a="myx@amial.com"===l||await S({id:o.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(o.deleteFlexatar,l),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(l)),e.postMessage({msgID:o.msgID,payload:{success:a}})}else if(o.userInfo)o.opts?e.postMessage({msgID:o.msgID,payload:await t.getUserInfo(o.opts)}):e.postMessage({msgID:o.msgID,payload:c});else if(o.decrementFtarCount)await z(l,c.FtarCount-1),e.postMessage({msgID:o.msgID,payload:{success:!0}});else if(o.effectStateResponse)t.effectPorts.forEach((e=>{e.postMessage(o)}));else if(o.showRetarg)t.showRetarg();else if(o.showEffects)t.showEffects();else if(o.showProgress)t.showProgress();else if(o.setRetargetingStatus)await d(f.RETARGETING_STATUS,"",o.setRetargetingStatus,l),e.postMessage({msgID:o.msgID,payload:{success:!0}});else if(o.getRetargetingStatus){let t=await u(f.RETARGETING_STATUS,"",l);e.postMessage({msgID:o.msgID,payload:t?t.value:null})}else if(o.setRetargetingCalibration)await d(f.RETARGETING_CALIBRATION,"",o.setRetargetingCalibration,l),e.postMessage({msgID:o.msgID,payload:{success:!0}});else if(o.getRetargetingCalibration){let t=await u(f.RETARGETING_CALIBRATION,"",l);e.postMessage({msgID:o.msgID,payload:t})}else if(o.setViewportSize)await d(f.CURRENT_VIEWPORT_SIZE,"",o.setViewportSize,l),e.postMessage({msgID:o.msgID,payload:{success:!0}});else if(o.getViewportSize){let t=await u(f.CURRENT_VIEWPORT_SIZE,"",l,{width:320,height:640});e.postMessage({msgID:o.msgID,payload:t||{width:640,height:480}})}else if(o.deleteEffectPreset){const t=(await n(s.FTAR_PRESET_LIST_ID,o.deleteEffectPreset.userId)).filter((e=>e.presetId!==o.deleteEffectPreset.presetId));await i(s.FTAR_PRESET_LIST_ID,o.deleteEffectPreset.userId),await r(s.FTAR_PRESET_LIST_ID,t,o.deleteEffectPreset.userId),e.postMessage({msgID:o.msgID,payload:{success:!0}})}else if(o.getEffectPresets){const t=await U(s.FTAR_PRESET_LIST_ID,"presetInfo",l);e.postMessage({msgID:o.msgID,payload:t})}else if(o.saveEffectPreset)await r(s.FTAR_PRESET_LIST_ID,[o.saveEffectPreset],l),e.postMessage({msgID:o.msgID,payload:{success:{userId:l}}});else if(o.getManagerName)e.postMessage({msgID:o.msgID,payload:t.managerName});else if(o.getUserToken){const a="myx@amial.com"===l?await b.getToken():await t.tokenFn();e.postMessage({msgID:o.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}},ManagerConnection:X,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(_);let r=await s.match(a);if(!r){const o=await F(e,t.id,{ftar:!0});if(r=await fetch(o.ftar,{method:"GET"}),!r.ok)return;const n=await r.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await r.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(_);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const r=await s.arrayBuffer(),o=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,o),r}return await s.arrayBuffer()},flexatarList:M,makeFlexatar:L,deleteFlexatar:S,flexatarEntry:F,userInfo:A,GetToken:B,ERR_UNAUTHORIZED:k,ERR_UNEXPECTED:C};if(void 0===te)var te=self;te.Ftar=ee;const ae=new X;let se=window.innerWidth,re=Math.floor(1.1*se/2);window.addEventListener("resize",(function(){se=window.innerWidth,re=Math.floor(1.1*se/2),oe.onCanvasRatio(ne||1)}));const oe=new class{constructor(e){const t=document.createElement("canvas");t.width=e?.width??240,t.height=e?.height??320,t.style.display="none",this.canvas=t,t.flexatarCanvas=!0,document.body.appendChild(t);const a=navigator.userAgent.toLowerCase().includes("firefox"),s=t.getContext(a?"2d":"bitmaprenderer"),r=a?e=>{s.drawImage(e,0,0,t.width,t.height),e.close()}:e=>{s.transferFromImageBitmap(e)};this.ctx=s;const o=function(e,t,a){const s=new OffscreenCanvas(t,a),r=s.getContext("2d");return r.fillStyle="black",r.fillRect(0,0,t,a),r.fillStyle="white",r.font=`${Math.floor(t/10)}px sans-serif`,r.textAlign="center",r.textBaseline="middle",r.fillText(e,t/2,a/2),s.transferToImageBitmap()}("WARMING UP",320,320);r(o);const n=new MessageChannel;this.mediaPort=n.port2,this.selfPort=n.port1;let i=!0;this.isActive=!0;const c=this;n.port1.onmessage=e=>{e.data&&e.data.frame?(i&&(i=!1,this.#t()),this.isActive&&r(e.data.frame)):e.data&&e.data.canvasRatio?c.onCanvasRatio&&c.onCanvasRatio(e.data.canvasRatio):e.data&&e.data.log}}setFrame(e){this.ctx.transferFromImageBitmap(e)}get portToSend(){return this.mediaPort}get port(){return this.selfPort}get stream(){return this.canvas.captureStream(30)}#t=()=>{};set onFirstFrame(e){this.#t=e}destroy(){this.selfPort.postMessage({closing:!0}),this.selfPort.close(),this.canvas.remove()}set size(e){this.canvas.width=e.width,this.canvas.height=e.height}}({width:re,height:re});let ne,ie;function ce(){window.parent.postMessage({closeWindow:!0,portSelf:ie},"*",[ie])}previewHolder.appendChild(oe.canvas),oe.canvas.style.display="block",oe.onCanvasRatio=e=>{ne=e;const t=re,a=Math.floor(t*e);oe.canvas.width=a,oe.canvas.height=t},window.onmessage=e=>{const t=e.data;t&&(t.managerPort?(t.managerPort.onmessage=he,ie=t.managerPort,ie.postMessage({effectStateRequest:!0}),t.managerPort.postMessage({managerConnectionPort:ae.outPort},[ae.outPort]),t.managerPort.postMessage({mediaPort:oe.portToSend},[oe.portToSend])):t.closeThisWindow&&ce())},closeButton.onclick=()=>{oe.destroy(),ce()};let le,fe,de,ue,ge="NO";function he(e){const t=e.data;if(t&&t.effectStateResponse){toggleEffectAnimation.checked=t.effectStateResponse.effectIsAnimated,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed"),effectSlider.value=100*t.effectStateResponse.effectParameter;const e=t.effectStateResponse.currentMode;morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),noEffectButton.classList.remove("active"),t.effectStateResponse.effectIsAnimated&&(effectSlider.disabled=!0),0===e?(noEffectButton.classList.add("active"),ge="NO"):1===e?(morphEffectButton.classList.add("active"),ge="MORPH"):2===e&&(ge="HYBRID",hybridEffectButton.classList.add("active")),ae.ready.then((async()=>{const e=await ae.getList({preview:!0});let a,s=!0;for(const r of e){const e=await ae.getPreview(r),o=new Blob([e],{type:"image/jpg"}),n=URL.createObjectURL(o),{holder:i}=await pe(r,n);t.effectStateResponse.currentEffectFtarId,r.id,t.effectStateResponse.currentEffectFtarId&&t.effectStateResponse.currentEffectFtarId===r.id&&(i.click(),s=!1),a||(a=i)}a&&s&&a.click();const r=await ae.getEffectPresets();for(const{presetInfo:e,userId:t}of r){const{ftarLink1:a,ftarLink2:s,effectType:r,effectVal:o,presetId:n}=e;await me(a,s,r,o,n,t)}}))}}async function me(e,t,a,s,r,o){const n=await Ee(effectPreset,e,t,a,s),i=r;n.userIdPresetBelongs=o,n.onclick=async()=>{le&&le.classList.remove("selected"),le=n,n.classList.add("selected");const r=await ae.getFlexatar(e,!0,!1),o=await ae.getFlexatar(t,!1,!0);let c;ie&&(ie.postMessage({...e,slot1:r},[r]),ie.postMessage({...t,slot2:o},[o])),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),noEffectButton.classList.remove("active"),"MORPH"===a?(ie.postMessage({morphEffect:!0,isEffectMessage:Ie}),morphEffectButton.classList.add("active")):"HYBRID"===a?(ie.postMessage({hybridEffect:!0,isEffectMessage:Ie}),hybridEffectButton.classList.add("active")):(ie.postMessage({noEffect:!0,isEffectMessage:Ie}),noEffectButton.classList.add("active"));try{const e=parseInt(s,10);if(isNaN(e))throw new Error("Parsed effectVal is NaN");effectSlider.value=e,toggleEffectAnimation.checked=!1,ie.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ie}),ie.postMessage({effectParameter:e/100,isEffectMessage:Ie}),effectSlider.classList.remove("cursor-not-allowed"),c=e}catch{effectSlider.classList.add("cursor-not-allowed"),toggleEffectAnimation.checked=!0,c="A",ie.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ie})}ge=a,_e&&_e.remove(),_e=await Ee(presetPlaceHolder,e,t,ge,c),ye("preview_"+("slot1"===Re?e.id:t.id)),trashIcon.disabled=!1,fe=i}}const we={};async function pe(e,t,a){we[e.id]=e;const s=t,r=document.createElement("span");r.className="item-holder";const o=document.createElement("img");o.src=s,o.draggable=!1,o.id="preview_"+e.id,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",r.appendChild(o),r.id=e.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(r,previewListHolder.firstChild):previewListHolder.appendChild(r),r.onclick=async()=>{if(slot1Button.disabled=slot2Button.disabled=!0,de&&de.classList.remove("selected-item"),de=r,r.classList.add("selected-item"),ue&&ue.ftarId===e.id)return void(slot1Button.disabled=slot2Button.disabled=!1);let t;ue={element:r,ftarId:e.id,ftarLink:e},r.appendChild(n);let a=0;for(;!(t||(t=await ae.getFlexatar(e,"slot1"===Re,"slot2"===Re),await new Promise((e=>setTimeout(e,1e3))),a+=1,a>7)););if(ie){const a={...e,slot2:t};a[Re]=t,ie.postMessage(a,[t])}n.remove(),slot1Button.disabled=slot2Button.disabled=!1},ue&&ue.ftarId===e.id&&(ue.element=r,r.click()),{holder:r,previewImg:s}}const Ie=!0;let _e;async function Ee(e,t,a,s,r){const o=document.createElement("span");o.classList.add("preset-line");for(const e of[t,a]){const t=await ae.getPreview(e),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),r=document.createElement("img");r.src=s,o.appendChild(r)}const n=document.createElement("span");return n.className="top-overlay small-font",n.textContent=s+" "+r,o.appendChild(n),e.appendChild(o),o}function ye(e){de&&de.classList.remove("selected-item"),de=document.getElementById(e),de.classList.add("selected-item")}noEffectButton.onclick=()=>{ie.postMessage({noEffect:!0,isEffectMessage:Ie}),noEffectButton.classList.add("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),ge="NO"},morphEffectButton.onclick=()=>{ie.postMessage({morphEffect:!0,isEffectMessage:Ie}),noEffectButton.classList.remove("active"),morphEffectButton.classList.add("active"),hybridEffectButton.classList.remove("active"),ge="MORPH"},hybridEffectButton.onclick=()=>{ie.postMessage({hybridEffect:!0,isEffectMessage:Ie}),noEffectButton.classList.remove("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.add("active"),ge="HYBRID"},toggleEffectAnimation.onchange=()=>{ie.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ie}),effectSlider.disabled=toggleEffectAnimation.checked,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed")},effectSlider.oninput=()=>{ie.postMessage({effectParameter:effectSlider.value/100,isEffectMessage:Ie})},effectTabButton.onclick=()=>{_e&&(effectControls.classList.remove("invisible"),ftarSelectContainer.classList.remove("invisible"),effectPreset.classList.add("invisible"),currentPresetHolder.classList.add("invisible"),effectTabButton.classList.add("active"),presetTabButton.classList.remove("active"),_e.remove(),_e=null)},presetTabButton.onclick=async()=>{if(_e)return;effectControls.classList.add("invisible"),ftarSelectContainer.classList.add("invisible"),effectPreset.classList.remove("invisible"),currentPresetHolder.classList.remove("invisible"),effectTabButton.classList.remove("active"),presetTabButton.classList.add("active");const e=await ae.getCurrentFtar(),t=await ae.getCurrentFtarSlot2();_e=await Ee(presetPlaceHolder,e,t,ge,effectSlider.value)},addPreset.onclick=async()=>{const e=await ae.getCurrentFtar(),t=await ae.getCurrentFtarSlot2(),a=toggleEffectAnimation.checked?"A":effectSlider.value,s={ftarLink1:e,ftarLink2:t,effectType:ge,effectVal:a,presetId:crypto.randomUUID()},{success:r}=await ae.saveEffectPreset(s);me(e,t,ge,a,r.userId)};let Re="slot2";slot1Button.onclick=async()=>{Re="slot1",slot1Button.classList.add("active"),slot2Button.classList.remove("active");ye("preview_"+(await ae.getCurrentFtar()).id)},slot2Button.onclick=async()=>{Re="slot2",slot1Button.classList.remove("active"),slot2Button.classList.add("active");ye("preview_"+(await ae.getCurrentFtarSlot2()).id)},trashIcon.onclick=async()=>{fe&&le?(await ae.deleteEffectPreset({presetId:fe,userId:le.userIdPresetBelongs}),le.remove(),trashIcon.disabled=!0):trashIcon.disabled=!0}})();
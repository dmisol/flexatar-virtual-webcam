(()=>{"use strict";async function t(t,e,a,s,r,o,n){const i=await o(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},e);if(!i.ok)return{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const f=c.link;if(!await async function(t,e){const a=new FormData;return Object.entries(t.fields).forEach((([t,e])=>{a.append(t,e)})),a.append("file",e),!!(await fetch(t.url,{method:"POST",body:a})).ok}(f,a))return;let l=0;return await new Promise((t=>{const e=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return l+=1,void(l>10&&(clearInterval(e),t()));const s=await a.json();clearInterval(e),t(s)}),5e3)}))}async function e(t){const{currentUserId:e}=t?{currentUserId:t}:await chrome.storage.local.get({currentUserId:null});return e||{error:"not_authorized"}}const a={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list"};async function s(t,a,s){const r=await e(s);if(r.error)return r;const o=r+t,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o].concat(a);return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function r(t,a,s){const r=await e(s);if(r.error)return r;const o=r+t,n={};n[o]=[];const i=a;return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function o(t,a){const s=await e(a);if(s.error)return s;const r=s+t,o={};o[r]=[];return(await chrome.storage.local.get(o))[r]}async function n(t){const a=await e();if(a.error)return a;const s=a+t;await chrome.storage.local.remove([s])}async function i(t){const a=await e();if(a.error)return a;const s=a+t;(await chrome.storage.local.get([s]))[s]}async function c(){for(const[t,e]of Object.entries(a))i(e)}const f="_src_img_",l="_is_queue_in_progress_",u="_src_background_",d="_current_id_background_";async function g(t,a,s,r){const o=await e(r);if(o.error)return o;const n={};n[o+t+a]=s;try{return await chrome.storage.local.set(n),{success:!0}}catch(t){return{error:"unknown"}}}async function h(t,a,s){const r=await e(s);if(r.error)return r;const o=r+t+a,n={};n[o]=null;return(await chrome.storage.local.get(n))[o]}async function w(t,a,s){const r=await e(s);if(r.error)return r;const o=r+t+a;await chrome.storage.local.remove([o])}async function m(t,e,a,s="id"){const n=await o(t,a);let i=e[s];i||(i=e);const c=n.filter((t=>(t[s]||t)!==i));await r(t,c,a)}async function p(t,e,a){let s=await o(t,a);if(s.length>e){const t=s.slice(e,s.length);s=s.slice(0,e);for(const e of t)await w(f,e.id,a)}await r(t,s,a)}async function y(t,a,s,r){await m(t,s,r),await async function(t,a,s){const r=await e(s);if(r.error)return r;const o=r+t,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=a.concat(i);return n[o]=c,await chrome.storage.local.set(n),{success:!0}}(a,[s],r)}const _="ftarcache";async function I(t,e){const{strings:a}=await chrome.storage.local.get({strings:{}});a[t]=e,await chrome.storage.local.set({strings:a})}async function E(t){const{strings:e}=await chrome.storage.local.get({strings:{}});return e[t]}const k="https://api.flexatar-sdk.com";async function v(t,e){const a=k+"/"+t.id;e||(e=t.token);const s={};try{const t=await D(a,{method:"DELETE",headers:s},e);return t.ok?t.ok:401===t.status?{error:M}:{error:L}}catch(t){return!1}}async function S(t,e){const a=e+"_ftar_"+t,s=e+"_ftarpreview_"+t;await chrome.storage.local.remove([a,s])}async function R(t,e,a){if("default"===e.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+e.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();{const t="myx@amial.com_ftar_"+e.id,a=(await chrome.storage.local.get([t]))[t];if(a)return await(await fetch(a)).arrayBuffer()}let o;if(e.ftar)o=await fetch(e.ftar,{method:"GET"});else{const a=await B(e.is_myx?O:t,e.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const n=await o.arrayBuffer(),i=await T(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function T(t,e="application/octet-stream"){const a=new Blob([t],{type:e});return new Promise(((t,e)=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=e,s.readAsDataURL(a)}))}async function P(t,e,a,s=0){const r=a+"_ftarpreview_"+t.id,o=(await chrome.storage.local.get([r]))[r];if(o)return await(await fetch(o)).arrayBuffer();{const e="myx@amial.com_ftarpreview_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}return s<8?(await new Promise((t=>setTimeout(t,500))),await P(t,e,a,s+1)):void 0}async function F(t,e){const a=e+"_ftarpreview_"+t.id;let s=await fetch(t.preview,{method:"GET"});if(!s.ok)return;const r=await s.arrayBuffer(),o=await T(r),n={};return n[a]=o,await chrome.storage.local.set(n),r}async function D(t,e,a,s){e.headers.Authorization="Bearer "+await a.getToken();const r=await fetch(t,e);return 403!=r.status?r:(s||(s=2),s<=0?r:(s-=1,a.token=null,await D(t,e,a,s)))}const M="unauthorized",L="UNEXPECTED";async function A(t,e){const a=k+"/list",s=[];e.ftar&&s.push("ftar"),e.preview&&s.push("preview"),e.meta&&s.push("meta");const r=await D(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},t);if(!r.ok)return 401===r.status?{error:M}:{error:L};return(await r.json()).all}async function B(t,e,a){const s=k+"/list",r={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const n={};n[e]=o;try{const a=await D(s,{method:"POST",headers:r,body:JSON.stringify(n)},t);if(!a.ok)return 401===a.status?{error:M}:{error:L};return(await a.json()).requested[e]}catch(t){}}async function x(e,a,s,r,o){s||(s="");const n=k+"/make",i=await t(n,e,a,s,0,D,o);if(!i)return{error:L};if(i.error)return 401===i.error.status?{error:M}:{error:L};if(!i.success){let t=i.reason;return t||(t="bad_photo"),{err:!0,reason:t}}let c={ftar:!0,meta:!0};return r&&(c=r),await B(e,i.id,c)}async function C(t){const e=await D(k+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},t);if(!e.ok&&!e.ok)return 401===e.status?{error:M}:{error:L};return await e.json()}class U{constructor(t){this.getTokenFunc=t}#t;async getToken(){if(this.token)return this.token;let t=this.#t;this.#t||(this.#t=this.getTokenFunc(),t=this.#t);const e=await t;return this.token=e,this.#t=null,e}}async function b(t,e){const a=await async function(t){const e=await new Promise((t=>{chrome.storage.local.get(null,t)}));return Object.keys(e).filter((e=>e.startsWith(t)))}(t),s={};for(const e of a){s[e.replaceAll(t,"")]=e}for(const{id:t}of e)delete s[t];const r=Object.values(s);r.length>0&&await chrome.storage.local.remove(r)}const O=new U((async()=>await async function(){try{const t=await fetch("https://api.flexatar-sdk.com/myxtoken");if(!t.ok)return;const e=await t.json();if(!e.token)return;return e.token}catch(t){return}}()));async function N(t,e,a,s=!1){const r=a+"_ftarlist";async function o(t,a){(async()=>{if(e.opts.preview)for(const e of t){await F(e,a);delete e.preview}})()}let n=e.opts.noCache?null:await E(r);if(e.opts.noCache=void 0,!n&&"myx@amial.com"===a&&s&&(n=await E(r),n||(n=await A(t,e.opts),o(n,a),await I(r,n))),!n){if(s&&("myx@amial.com"===a&&e.opts,n=await A(t,e.opts),n&&n.error))return n;if(n){n=n.reverse(),(async()=>{if(e.opts.preview)for(const t of n){await F(t,a);delete t.preview}})();const t=a+"_ftarpreview_";await b(t,n);const s=a+"_ftar_";await b(s,n),await I(r,n)}else n=[]}if("myx@amial.com"!==a&&s){const t="myx@amial.com_ftarlist";let a=await E(t);if(!a){const s=await async function(){return await A(O,e.opts)}();a=s,o(s,"myx@amial.com"),await I(t,s)}n=n.concat(a)}return n}async function j(t){await chrome.storage.local.remove([t+"_currentFlexatarId"])}async function G(t){await Q(t,await q(t)-1)}async function q(t){const e=t+"_FtarCount";return(await chrome.storage.local.get([e]))[e]}async function Q(t,e){const a=t+"_FtarCount",s={};s[a]=e,await chrome.storage.local.set(s)}async function W(t,s){const r=await e(),o=await h(f,s.id,r);if(o){const e=function(t,e){const[a,s]=t.split(","),r=a.match(/:(.*?);/),o=r?r[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(t=>t.charCodeAt(0)));return new File([i],e,{type:o})}(o),n=await x(t,e,"noname",{ftar:!0,preview:!0},(async t=>{s.ftarId=t;await y(a.FTAR_MAKE_QUEUE_LIST_ID,a.FTAR_PROCESSING_QUEUE_LIST_ID,s,r);c()}));if(n.error||n.err){if(await y(a.FTAR_PROCESSING_QUEUE_LIST_ID,a.FTAR_ERROR_LIST_ID,s,r),await p(a.FTAR_ERROR_LIST_ID,5),"bad_photo"!==n.reason)return await g(l,"",!1),n}else{await y(a.FTAR_PROCESSING_QUEUE_LIST_ID,a.FTAR_SUCCESS_LIST_ID,s,r),await p(a.FTAR_SUCCESS_LIST_ID,5);try{await async function(t,e){if(!e)return;const a=t+"_ftarlist";let s=await E(a);s.unshift({id:e}),await I(a,s)}(r,n.id),await F(n,r),await R(t,n,r)}catch{}}return c(),n}await g(l,"",!1)}async function z(t,e){const s=await o(a.FTAR_MAKE_QUEUE_LIST_ID);if("not_authorized"===s.error)return{error:s.error};const r=await h(l,"");if(s.length>0&&r){return e(await W(t,s[0])),await z(t,e)}return g(l,"",!1),{}}async function K(){const t={successImages:a.FTAR_SUCCESS_LIST_ID,errorImages:a.FTAR_ERROR_LIST_ID,queueImages:a.FTAR_MAKE_QUEUE_LIST_ID},s={};for(const[e,a]of Object.entries(t)){const t=(await o(a)).map((async t=>await h(f,t.id)));s[e]=await Promise.all(t)}const r=(await o(a.FTAR_PROCESSING_QUEUE_LIST_ID)).map((async t=>await h(f,t.id))),n=await Promise.all(r);n&&n.length>0&&s.queueImages.unshift(n[0]);const i=await e();return s.flexatarCount=await q(i),s.isQueueInProgress=await h(l,""),s}const H=new class{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(t){return new Promise(((e,a)=>{this.queue.push({task:t,resolve:e,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:t,resolve:e,reject:a}=this.queue.shift();try{e(await t())}catch(t){a(t)}this.isProcessing=!1,this.processQueue()}};function J(t,e){const a=$();return e.msgID=a,new Promise((s=>{t.addEventListener("message",(function e(r){r.data&&r.data.msgID===a&&(s(r.data.payload),t.removeEventListener("message",e))})),t.postMessage(e)}))}class X{constructor(){const t=new MessageChannel;this.port=t.port1,this.port.start(),this.outPort=t.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},t.port1.onmessage=e=>{e.data&&e.data.handShake?t.port1.postMessage(e.data):e.data&&e.data.newBackGround?this.onNewBackground&&this.onNewBackground(e.data.newBackGround):e.data&&e.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(e.data):e.data&&e.data.slot2?this.onSlot2&&this.onSlot2(e.data):e.data&&e.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(e.data):e.data&&e.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(e.data.newFlexatar)},this.ready=new Promise((e=>{t.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(e(),t.port1.removeEventListener("message",a))}))}))}sendWithResponse(t){const e=$();t.msgID=e;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function t(r){r.data&&r.data.msgID===e&&(s(r.data.payload),a.removeEventListener("message",t))})),a.postMessage(t)}))}async getList(t){return t||(t={}),await this.sendWithResponse({ftarList:!0,opts:t})}async getBackgrounds(t){return t||(t={}),await this.sendWithResponse({backgroundsList:!0,opts:t})}async getPreview(t){return await this.sendWithResponse({preview:t})}async getFlexatar(t,e,a=!0){return await this.sendWithResponse({flexatar:t,is_myx:e,setAsCurrent:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async setCurrentBackground(t){return await this.sendWithResponse({setCurrentBkg:t})}async deleteBackground(t){return await this.sendWithResponse({deleteBackground:t})}async getCurrentBackground(t={id:!0}){return await this.sendWithResponse({getCurrentBkg:t})}async storeNewBackground(t){return await this.sendWithResponse({storeNewBackground:t})}async makeFlexatar(t){const e=await function(t){const e=t.type,a=t.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(t),o.onload=()=>s({buffer:o.result,fileType:e,fileName:a}),o.onerror=t=>r(t)}))}(t);return e.makeFlexatar=!0,await this.sendWithResponse(e,[e.buffer])}async deleteFlexatar(t){return await this.sendWithResponse({deleteFlexatar:t})}async userInfo(t){return await this.sendWithResponse({userInfo:!0,opts:t})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}sendEffectState(t){this.port.postMessage(t)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}}function $(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const Z={Manager:class{constructor(t,e=!1,s=!1,r=!0){let o;s||(o=async function(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===t)var t=self;"undefined"==typeof chrome&&(t.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const e="flexatar-storage-cache",a=t=>new Request(`https://flexatar-mock-storage/${t}`),s=t=>new URL(t).pathname.slice(1),r=await caches.open(e);chrome.storage.local.set=async t=>{const e=Object.entries(t).map((async([t,e])=>{const s=JSON.stringify({value:e}),o=new Response(s,{headers:{"Content-Type":"application/json"}});await r.put(a(t),o)}));await Promise.all(e)},chrome.storage.local.get=async(t,e)=>{const o={};if(null==t){const t=(await r.keys()).map((t=>s(t.url)));return e&&e(t),t}const n=(Array.isArray(t)?t:"object"==typeof t&&null!==t?Object.keys(t):"string"==typeof t?[t]:[]).map((async e=>{const s=await r.match(a(e));if(s){const t=await s.json();o[e]=t.value}else o[e]="object"==typeof t&&null!==t?t[e]:void 0}));return await Promise.all(n),e&&e(o),o},chrome.storage.local.remove=async t=>{const e=(Array.isArray(t)?t:[t]).map((t=>r.delete(a(t))));await Promise.all(e)}}}()),this.tokenFn=t,this.needMyxAccount=r,this.token=new U((async()=>await t())),e&&o.then((()=>{[a.FTAR_ERROR_LIST_ID,a.FTAR_SUCCESS_LIST_ID,a.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{n(t)})),g(l,"",!1)}))}showEffects(){this.effectPorts.forEach((t=>{t.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(t){const e=this;this.effectPorts.push(t),t.onmessage=async t=>{const a=t.data;if(a)if(a.managerConnectionPort)e.addPort(a.managerConnectionPort);else if(a.mediaPort)e.onMediaPort(a.mediaPort);else if(a.isEffectMessage)e.ports.forEach((t=>{t.postMessage(a)}));else if(a.effectStateRequest)e.ports.forEach((t=>{t.postMessage(a)}));else if(a.slot2){const t=a.slot2;e.ports.forEach((e=>{const s=t.slice(0);a.slot2=s,e.postMessage(a,[a.slot2])}))}}}showProgress(){this.progressPorts.forEach((t=>{t.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(t){const s=this;this.progressPorts.push(t),t.onmessage=async r=>{await H.enqueue((async()=>await s.getUserInfo()));const o=r.data;if(o)if(o.progressLists){o.reloadFtarCount&&await s.getUserInfo({noCache:!0});const e=await K();t.postMessage({progressLists:e})}else if(o.pauseMakeQueue)await g(l,"",!1);else if(o.clearMakeQueue){await n(a.FTAR_MAKE_QUEUE_LIST_ID),await n(a.FTAR_PROCESSING_QUEUE_LIST_ID);const e=await K();t.postMessage({progressLists:e})}else o.startMakeQueue&&(await g(l,"",!0),s.ftarQueueDelegate(s.token,(async a=>{a.err||a.error||await G(await e()),s.ports.forEach((t=>{t.postMessage({newFlexatar:a})}));const r=await K();t.postMessage({progressLists:r})})))}}async getUserInfo(t){const e=t&&t.noCache,{currentUserId:a}=await chrome.storage.local.get({currentUserId:null});if(a||(this.token.token=null),a&&!e){const t=a+"_FtarCount",e=(await chrome.storage.local.get([t]))[t];if(null!=e)return{user_id:a,FtarCount:e}}const s=await C(this.token);if(s.error)return s;const r=s.user_id;return await chrome.storage.local.set({currentUserId:r}),await Q(r,s.FtarCount),s}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const t of this.ports){const e=setTimeout((()=>{this.portsMustBeDeleted.push(t),t.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(e),t.removeEventListener("message",a))}t.addEventListener("message",a),t.postMessage({handShake:!0})}}makeFtar(t){const e=this;this.lensPorts.forEach((async a=>{const s=await H.enqueue((async()=>await e.getUserInfo()));await J(a,{managerPort:!0}),s.error?a.postMessage({needAuthorize:!0},[t]):a.postMessage({imageBuffer:t},[t])}))}lensPorts=[];ftarQueueDelegate=z;addFtarLens(t){const r=this;this.lensPorts.push(t),t.onmessage=async o=>{const n=o.data;if(n)if(await H.enqueue((async()=>await r.getUserInfo())),n.imagesList){const t=n.imagesList,o=t.map((t=>({id:t.id})));await s(a.FTAR_MAKE_QUEUE_LIST_ID,o);for(const{dataUrl:e,id:a}of t){await g(f,a,e)}await h(l,"")||(await g(l,"",!0),r.ftarQueueDelegate(r.token,(async t=>{t.err&&!t.error||await G(await e()),r.ports.forEach((e=>{e.postMessage({newFlexatar:t})})),r.progressPorts.forEach((async t=>{t.postMessage({progressLists:await K()})}))}))),r.showProgress()}else n.needAuthorize?r.onNeedAuthorize():n.closing&&(r.lensPorts=r.lensPorts.filter((e=>e!==t)))}}onNeedAuthorize=()=>{};addPort(t){const e=this;for(const t of this.portsMustBeDeleted)e.ports=e.ports.filter((e=>e!==t));this.portsMustBeDeleted=[],this.ports.push(t),t.onmessage=async r=>{const n=r.data;if(!n)return;const i=await H.enqueue((async()=>await e.getUserInfo()));if(i.error)return void t.postMessage({msgID:n.msgID,payload:i});const c=i.user_id;if(n.ftarList){const a=await N(e.token,n,c,e.needMyxAccount);t.postMessage({msgID:n.msgID,payload:a})}else if(n.backgroundsList){const e=n.opts??{};let s;s=e.id?[e.id]:await o(a.FTAR_BACKGROUND_LIST_ID,c);const r=[];for(const t of s){const e=await h(u,t,c);r.push([t,e])}t.postMessage({msgID:n.msgID,payload:r})}else if(n.preview){let a=await P({id:n.preview},e.token,c);if(!a)return void t.postMessage({msgID:n.msgID,payload:null});t.postMessage({msgID:n.msgID,payload:a},[a])}else if(n.flexatar){let e=await R(this.token,{id:n.flexatar,is_myx:n.is_myx},c);if(!e)return void t.postMessage({msgID:n.msgID,payload:null});n.flexatar,n.setAsCurrent&&await async function(t,e){const a={};a[e+"_currentFlexatarId"]=t,await chrome.storage.local.set(a)}(n.flexatar,c),t.postMessage({msgID:n.msgID,payload:e},[e])}else if(n.closing)e.ports=e.ports.filter((e=>e!==t)),t.close();else if(n.storeNewBackground){const e=await function(t,e){return new Promise((r=>{const n=crypto.randomUUID();o(a.FTAR_BACKGROUND_LIST_ID,e).then((o=>{s(a.FTAR_BACKGROUND_LIST_ID,[n],e).then((a=>{g(u,n,t,e).then((t=>{r(n)}))}))}))}))}(n.storeNewBackground,c);t.postMessage({msgID:n.msgID,payload:e}),t.postMessage({newBackGround:e})}else if(n.getCurrentBkg){let e=await h(d,"",c);if(!e){const t=await o(a.FTAR_BACKGROUND_LIST_ID,c);e=t[t.length-1]}e&&n.getCurrentBkg.dataUrl&&(e="no"===e?null:await h(u,e,c)),t.postMessage({msgID:n.msgID,payload:e})}else if(n.deleteBackground)m(a.FTAR_BACKGROUND_LIST_ID,n.deleteBackground,c),w(u,n.deleteBackground,c),t.postMessage({msgID:n.msgID,payload:{result:"success"}});else if(n.setCurrentBkg)g(d,"",n.setCurrentBkg,c),t.postMessage({msgID:n.msgID,payload:{result:"success"}});else if(n.currentFtar){n.opts={preview:!0};const a=await N(e.token,n,c,e.needMyxAccount),[s,r]=await async function(t,e){const a=t+"_currentFlexatarId";let s=(await chrome.storage.local.get([a]))[a];if(0===e.length)return[null,!1];for(const{id:t,is_myx:a}of e)if(t===s)return[s,a];const r={},o=e[0].id;return r[a]=o,await chrome.storage.local.set(r),[o,e[0].is_myx]}(c,a);t.postMessage({msgID:n.msgID,payload:{id:s,is_myx:r}})}else if(n.makeFlexatar)this.lensPorts.forEach((async t=>{await J(t,{managerPort:!0}),t.postMessage({imageBuffer:n.buffer},[n.buffer])})),t.postMessage({msgID:n.msgID,payload:{status:"ok"}});else if(n.deleteFlexatar){const{isAuthorized:e}=await async function(t,e){const a=t+"_ftarlist";let s=await E(a);const r=Object.keys(s).length;if(s=s.filter((({id:t})=>e!==t)),Object.keys(s).length===r){const t="myx@amial.com_ftarlist";let a=await E(t);return a=a.filter((({id:t})=>e!==t)),await I(t,a),{isAuthorized:!1}}return await I(a,s),{isAuthorized:!0}}(c,n.deleteFlexatar);if(e){const e=await v({id:n.deleteFlexatar,token:this.token});e&&(await S(n.deleteFlexatar,c),await j(c)),t.postMessage({msgID:n.msgID,payload:{success:e}})}else await S(n.deleteFlexatar,"myx@amial.com"),await j(c),t.postMessage({msgID:n.msgID,payload:{success:!0}})}else if(n.userInfo)n.opts?t.postMessage({msgID:n.msgID,payload:await e.getUserInfo(n.opts)}):t.postMessage({msgID:n.msgID,payload:i});else if(n.decrementFtarCount)await Q(c,i.FtarCount-1),t.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.effectStateResponse)e.effectPorts.forEach((t=>{t.postMessage(n)}));else if(n.showEffects)e.showEffects();else if(n.showProgress)e.showProgress();else if(n.getUserToken){const a=await e.tokenFn();t.postMessage({msgID:n.msgID,payload:a})}},t.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(t){this.ports.forEach((e=>{e.postMessage({newBackGround:t})}))}},ManagerConnection:X,getFlexatar:async function(t,e){const a="/ftar/"+e.id,s=await caches.open(_);let r=await s.match(a);if(!r){const o=await B(t,e.id,{ftar:!0});if(r=await fetch(o.ftar,{method:"GET"}),!r.ok)return;const n=await r.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await r.arrayBuffer()},getPreview:async function(t){const e="/ftarpreview/"+t.id,a=await caches.open(_);let s=await a.match(e);if(!s){if(s=await fetch(t.preview,{method:"GET"}),!s.ok)return;const r=await s.arrayBuffer(),o=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(e,o),r}return await s.arrayBuffer()},flexatarList:A,makeFlexatar:x,deleteFlexatar:v,flexatarEntry:B,userInfo:C,GetToken:U,ERR_UNAUTHORIZED:M,ERR_UNEXPECTED:L};if(void 0===V)var V=self;V.Ftar=Z;const Y=new X,tt=new class{constructor(t){const e=document.createElement("canvas");e.width=t?.width??240,e.height=t?.height??320,e.style.display="none",this.canvas=e,e.flexatarCanvas=!0,document.body.appendChild(e);const a=e.getContext("bitmaprenderer");this.ctx=a;const s=function(t,e,a){const s=new OffscreenCanvas(e,a),r=s.getContext("2d");return r.fillStyle="black",r.fillRect(0,0,e,a),r.fillStyle="white",r.font=`${Math.floor(e/10)}px sans-serif`,r.textAlign="center",r.textBaseline="middle",r.fillText(t,e/2,a/2),s.transferToImageBitmap()}("WARMING UP",e.width,e.height);a.transferFromImageBitmap(s);const r=new MessageChannel;this.mediaPort=r.port2,this.selfPort=r.port1;let o=!0;this.isActive=!0,r.port1.onmessage=t=>{t.data&&t.data.frame?(o&&(o=!1,this.#e()),this.isActive&&a.transferFromImageBitmap(t.data.frame)):t.data&&t.data.log}}setFrame(t){this.ctx.transferFromImageBitmap(t)}get portToSend(){return this.mediaPort}get port(){return this.selfPort}get stream(){return this.canvas.captureStream(30)}#e=()=>{};set onFirstFrame(t){this.#e=t}destroy(){this.selfPort.postMessage({closing:!0}),this.selfPort.close(),this.canvas.remove()}set size(t){this.canvas.width=t.width,this.canvas.height=t.height}}({width:120,height:160});let et,at,st;function rt(){window.parent.postMessage({closeWindow:!0,portSelf:et},"*",[et])}function ot(t){const e=t.data;if(e&&e.effectStateResponse){toggleEffectAnimation.checked=e.effectStateResponse.effectIsAnimated,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed"),effectSlider.value=100*e.effectStateResponse.effectParameter;const t=e.effectStateResponse.currentMode;morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),noEffectButton.classList.remove("active"),e.effectStateResponse.effectIsAnimated&&(effectSlider.disabled=!0),0===t?noEffectButton.classList.add("active"):1===t?morphEffectButton.classList.add("active"):2===t&&hybridEffectButton.classList.add("active"),Y.ready.then((async()=>{const t=await Y.getList({preview:!0});let a,s=!0;for(const{id:r,is_myx:o}of t){const t=await Y.getPreview(r),n=new Blob([t],{type:"image/jpg"}),i=URL.createObjectURL(n),{holder:c}=await it({id:r,is_myx:o},i);e.effectStateResponse.currentEffectFtarId,e.effectStateResponse.currentEffectFtarId&&e.effectStateResponse.currentEffectFtarId===r&&(c.click(),s=!1),a||(a=c)}a&&s&&a.click()}))}}previewHolder.appendChild(tt.canvas),tt.canvas.style.display="block",window.onmessage=t=>{const e=t.data;e&&(e.managerPort?(e.managerPort.onmessage=ot,et=e.managerPort,et.postMessage({effectStateRequest:!0}),e.managerPort.postMessage({managerConnectionPort:Y.outPort},[Y.outPort]),e.managerPort.postMessage({mediaPort:tt.portToSend},[tt.portToSend])):e.closeThisWindow&&rt())},closeButton.onclick=()=>{tt.destroy(),rt()};const nt={};async function it(t,e,a){nt[t.id]=t;const s=e,r=document.createElement("span");r.className="item-holder";const o=document.createElement("img");o.src=s,o.draggable=!1,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",r.appendChild(o),r.id=t.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(r,previewListHolder.firstChild):previewListHolder.appendChild(r),r.onclick=async()=>{if(at&&at.classList.remove("selected-item"),at=r,r.classList.add("selected-item"),st&&st.ftarId===t.id)return;let e;st={element:r,ftarId:t.id},r.appendChild(n);let a=0;for(;!(e||(e=await Y.getFlexatar(t.id,t.is_myx,!1),await new Promise((t=>setTimeout(t,1e3))),a+=1,a>7)););et&&et.postMessage({slot2:e,id:t.id,is_myx:t.is_myx},[e]),n.remove()},st&&st.ftarId===t.id&&(st.element=r,r.click()),{holder:r,previewImg:s}}const ct=!0;noEffectButton.onclick=()=>{et.postMessage({noEffect:!0,isEffectMessage:ct}),noEffectButton.classList.add("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active")},morphEffectButton.onclick=()=>{et.postMessage({morphEffect:!0,isEffectMessage:ct}),noEffectButton.classList.remove("active"),morphEffectButton.classList.add("active"),hybridEffectButton.classList.remove("active")},hybridEffectButton.onclick=()=>{et.postMessage({hybridEffect:!0,isEffectMessage:ct}),noEffectButton.classList.remove("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.add("active")},toggleEffectAnimation.onchange=()=>{et.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:ct}),effectSlider.disabled=toggleEffectAnimation.checked,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed")},effectSlider.oninput=()=>{et.postMessage({effectParameter:effectSlider.value/100,isEffectMessage:ct})}})();
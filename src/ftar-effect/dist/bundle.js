(()=>{"use strict";async function e(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),(await fetch(e.url,{method:"POST",body:a})).ok?(console.log("ftar send img ok"),!0):(console.error("send img failed"),!1)}class t{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}function a(){console.log("[FTAR_QUEUE_STORAGE]",...arguments)}async function s(e,t="currentUserId"){if(e)return e;const s={};s[t]=null;const o=await chrome.storage.local.get(s);return a("currentUserId",o),o?o[t]:{error:"not_authorized"}}const o={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue",FTAR_FAV_LIST_ID:"_favorite_list",AUIDIO_RECORD_LIST_ID:"_audio_record_list"};async function r(e,t,a){const o=await s(a);if(o.error)return o;const r=o+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r].concat(t);return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function n(e,t,a){const o=await s(a);if(o.error)return o;const r=o+e,n={};n[r]=[];const i=t;return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function i(e,t){const a=await s(t);if(a.error)return a;const o=a+e,r={};return r[o]=[],(await chrome.storage.local.get(r))[o]}async function c(e,t){a("clear list",e);const o=await s(t);if(o.error)return o;const r=o+e;await chrome.storage.local.remove([r]),a("clear list done",r)}const l={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_SPEECH_PATTERN:"_current_speech_pattern_",CURRENT_MOOD:"_current_mood_",RETARGETING_CALIBRATION:"_retargeting_calibration_",DO_NOT_SHOW_NOTIFICATION_ID:"_do_not_show_",RECORDED_AUDIO_ID:"_recorded_audio_"};async function d(e,t,o,r){const n=await s(r);if(n.error)return n;const i={};i[n+e+t]=o;try{return await chrome.storage.local.set(i),{success:!0}}catch(e){return a(e),{error:"unknown"}}}async function f(e,t,a,o=null){const r=await s(a);if(r.error)return r;const n=r+e+t,i={};i[n]=null;const c=await chrome.storage.local.get(i);return null===c[n]?o:c[n]}async function u(e,t,a){const o=await s(a);if(o.error)return o;const r=o+e+t;await chrome.storage.local.remove([r])}async function g(e,t,s,o="id"){const r=await i(e,s);let c=t[o];c||(c=t),a("queueList",r,e);const l=r.filter((e=>(e[o]||e)!==c));a("newList",l),await n(e,l,s)}async function p(e,t,a){let s=await i(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await u(l.FTAR_SRC_IMG,t.id,a)}await n(e,s,a)}async function m(e,t,a,o){await g(e,a,o),await async function(e,t,a){const o=await s(a);if(o.error)return o;const r=o+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r],c=t.concat(i);return n[r]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],o)}async function h(e,t,s,o,r="id"){const c=await i(e,o);let l=t[r];l||(l=t),a("list content",c,e);const d=c.filter((e=>(e[r]||e)===l));a("list with target element",d),Object.assign(d[0],s),await n(e,c,o)}function w(e,t){return new Promise((s=>{const n=crypto.randomUUID();a("background imageId",n),i(o.FTAR_BACKGROUND_LIST_ID,t).then((i=>{a("background list",i),r(o.FTAR_BACKGROUND_LIST_ID,[n],t).then((o=>{a("add to list",o),d(l.BACKGROUND_SRC_IMAGE,n,e,t).then((e=>{a("BACKGROUND_SRC_IMG saved",e),s(n)}))}))}))}))}async function I(e){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===t)var t=self;"undefined"==typeof chrome&&(t.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const a="flexatar-storage-cache",s=e=>new Request(`https://flexatar-mock-storage/${e}`),o=e=>new URL(e).pathname.slice(1),r=await caches.open(a);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const a=JSON.stringify({value:t}),o=new Response(a,{headers:{"Content-Type":"application/json"}});await r.put(s(e),o)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const a={};if(null==e){const e=(await r.keys()).map((e=>o(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const o=await r.match(s(t));if(o){const e=await o.json();a[t]=e.value}else a[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(a),a},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>r.delete(s(e))));console.log("start del keys"),await Promise.all(t),console.log("end del keys")},e&&await e()}}function _(...e){const t=(new Date).toLocaleTimeString();console.log(`[${t}] [FTAR_CONNECTION]`,...e)}const y="ftarcache";async function R(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function E(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const S="https://api.flexatar-sdk.com";async function v(e,t){const a=S+"/"+e.id;t||(t=e.token);const s={};try{const e=await D(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:C}:{error:M}}catch(e){return console.error("Flexatar deletion:",e),!1}}function T(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function P(e,t,a,s=0){const o=a+"_ftarpreview_"+e.id,r=(await chrome.storage.local.get([o]))[o];if(r)return await(await fetch(r)).arrayBuffer();if(e.preview){const t=await A(e,a);if(t)return t}const n=await F(t,e.id,{preview:!0});return e.preview=n.preview,await A(e,a)}async function A(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const o=await s.arrayBuffer(),r=await T(o),n={};return n[a]=r,_("store preview",n),await chrome.storage.local.set(n),o}async function D(e,t,a,s){const o=await a.getToken();if("no_token"===o)return o;t.headers.Authorization="Bearer "+o;const r=await self.fetch(e,t);return 403!=r.status?r:(s||(s=2),s<=0?r:(s-=1,a.token=null,await D(e,t,a,s)))}const C="unauthorized",M="UNEXPECTED";async function k(e,t){const a=S+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const o=await D(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);return o.ok?(await o.json()).all:401===o.status?{error:C}:{error:M}}async function F(e,t,a){const s=S+"/list",o={"Content-Type":"application/json"},r=[];a.ftar&&r.push("ftar"),a.preview&&r.push("preview"),a.meta&&r.push("meta");const n={};n[t]=r;try{const a=await D(s,{method:"POST",headers:o,body:JSON.stringify(n)},e);return a.ok?(await a.json()).requested[t]:401===a.status?{error:C}:{error:M}}catch(e){console.error("Flexatar list failed:",e)}}async function L(e){_("requesting user info from cloud");const t=await D(S+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);return"no_token"===t?{error:C}:t.ok?await t.json():401===t.status?{error:C}:{error:M}}class U{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,_("GetToken",t),t}}async function N(e,t,a,s=!0){_("getListDualUser needMyx",s);let o=await i(e,a);return o=o.map((e=>{const s={userId:a};return s[t]=e,s})),"myx@amial.com"!==a&&s&&(o=o.concat((await i(e,"myx@amial.com")).map((e=>{const a={userId:"myx@amial.com"};return a[t]=e,a})))),o}async function B(e,t,a,s=!0){let o=[];if("myx@amial.com"===a)t.opts.noCache=!1,o=await W(b,t,a,!1),o=o.reverse(),_("ftarList myx",o);else if(o=await W(e,t,a,!1),o=o.reverse(),s){t.opts.noCache=!1;const e=await W(b,t,"myx@amial.com",!1);o=o.concat(e.reverse())}return o}async function O(e){const t=[{caption:"ðŸ’¡ Warm Tone",prompt:"Soft golden light wraps around the face, brightening skin and adding a natural warmth. Subtle highlights on the forehead and cheeks create depth. The eyes gain a gentle amber reflection. The overall mood feels sunlit and inviting."},{caption:"ðŸŒ† Cool Tone",prompt:"A calm blue-gray tone softens the scene, giving the portrait a quiet cinematic feel. The skin tone shifts slightly toward cooler neutrals. Shadows contour the face with precise, modern clarity. Eyes reflect faint steel-blue hues."},{caption:"ðŸŒˆ Color Boost",prompt:"Colors appear more vivid and balanced, with deeper contrasts and sharper definition. Light glances across skin textures, giving life to every detail. Subtle chromatic tones enhance vitality. The effect feels crisp, clean, and refined."}];try{let a;if(e&&(a=await e.load()),a)return a;const s=await fetch("https://api.flexatar-sdk.com/aiprompt");return s.ok?(a=await s.json(),e.save(a),a):t}catch(e){return t}}const b=new U((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken/androidapp");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}())),x=new t,G=new t;async function W(e,t,a,s=!1){return await x.enqueue((async()=>{const s=a+"_ftarlist";let o=t.opts.noCache?null:await E(s);return _("ftar list from storage",o),o||(_("fetching list",a),o=await k(e,t.opts),o.error?_("ftarList.error",o.error):await R(s,o)),o.forEach((e=>{e.userId=a})),o}))}async function q(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function Q(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function j(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function K(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function z(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function H(e,t){const a=e+"_FtarCount",s={};s[a]=t,_("setting ftar count at key",a,"count is",t),await chrome.storage.local.set(s)}async function V(t,a,r){const n=await s(null,r);if(!await f(l.IS_QUEUE_IN_PROGRESS,"",n,!0))return void _("flexatar creation is on pause");const c=await async function(e){const t=await i(o.FTAR_PROCESSING_QUEUE_LIST_ID,e),a=await f(l.IS_QUEUE_IN_PROGRESS,"",e,!0);return _("isQueueInProgress",a,t),(0!==t.length||!a)&&t[0]}(n);if(_("isFlexatarInProgress",c),c)return void _("flexatar in progress");const d=(await i(o.FTAR_MAKE_QUEUE_LIST_ID,n))[0];if(d){_("Start creation of flexatar for image id",d);const n=await s(null,r);await m(o.FTAR_MAKE_QUEUE_LIST_ID,o.FTAR_PROCESSING_QUEUE_LIST_ID,d,n);const i=S+"/make",c=await async function(e,t,a,s){let o=s?JSON.stringify({aiPrompt:JSON.parse(JSON.parse(s))}):void 0;const r=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:o},t);if(!r.ok)return console.log("faild obtain make link",await r.json()),{error:{type:"unknown",message:r.status}};const n=await r.json();return n.block?{error:{type:"block",reason:n.block}}:n}(i,t,D,d.aiPrompt);if(c.error)return _("upload link error"),await m(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_ERROR_LIST_ID,d,n),await p(o.FTAR_ERROR_LIST_ID,5,n),void(a&&a());_("obtained ftar link with id",c.id),await h(o.FTAR_PROCESSING_QUEUE_LIST_ID,d.id,{ftarId:c.id},n);const u=await f(l.FTAR_SRC_IMG,d.id,n);if(u){const t=function(e,t){const[a,s]=e.split(","),o=a.match(/:(.*?);/),r=o?o[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:r})}(u);await e(c.link,t)||await async function(){await m(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_ERROR_LIST_ID,imgId,currentUserId),await p(o.FTAR_ERROR_LIST_ID,5,currentUserId)}()}}}async function J(e){const t={successImages:o.FTAR_SUCCESS_LIST_ID,errorImages:o.FTAR_ERROR_LIST_ID,queueImages:o.FTAR_MAKE_QUEUE_LIST_ID},a="currentUserId",r=await s(null,a),n={};for(const[e,s]of Object.entries(t)){_("user id when loading lists",r,a);const t=await i(s,r);_("loaded list",e,s,t);const o=t.map((async e=>await f(l.FTAR_SRC_IMG,e.id,r)));n[e]=await Promise.all(o)}const c=[o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of c){const t=(await i(e,r)).map((async e=>await f(l.FTAR_SRC_IMG,e.id,r))),a=await Promise.all(t);a&&a.length>0&&n.queueImages.unshift(a[0])}return _("progressLists",n),_("getting ftar count to progress userId",r),n.flexatarCount=await z(r),n.isQueueInProgress=await f(l.IS_QUEUE_IN_PROGRESS,"",r,!0),n}const $=new t;let Z=0;function Y(e){if(_("visibilityTracker","undefined"!=typeof document),"undefined"!=typeof document){function t(){document.hidden?e({visible:!1}):e({visible:!0})}document.addEventListener("visibilitychange",t),document.hidden||e({visible:!0})}else self.addEventListener("message",(t=>{console.log("Worker received:",t.data),t.data.documentState&&e(t.data.documentState)})),self.postMessage({visibilityRequest:!0})}function X(e,t){const a=te();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(o){o.data&&(_("responese",o.data),o.data.msgID===a&&(s(o.data.payload),e.removeEventListener("message",t)))})),e.postMessage(t)}))}class ee{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.animationPatternRequest?this.onAnimationPatternRequest&&this.onAnimationPatternRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=te();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(o){o.data&&(_("responese",o.data),o.data.msgID===t&&(s(o.data.payload),a.removeEventListener("message",e)))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>s({buffer:r.result,fileType:t,fileName:a}),r.onerror=e=>o(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}async showAnimate(){return await this.sendWithResponse({showAnimate:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async getSpeechPattern(){return await this.sendWithResponse({getSpeechPattern:!0})}async getMood(){return await this.sendWithResponse({getMood:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async setSpeechPattern(e){return await this.sendWithResponse({setSpeechPattern:e})}async setMood(e){return await this.sendWithResponse({setMood:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}async addToFavorite(e){return await this.sendWithResponse({addToFavorite:{value:e}})}async removeFromFavorite(e){return await this.sendWithResponse({removeFromFavorite:{value:e}})}async getFavorite(){return await this.sendWithResponse({getFavorite:!0})}async saveAudioEntry(e){return await this.sendWithResponse({saveAudioEntry:e})}async getRecordedAudioList(e="default"){return await this.sendWithResponse({getRecordedAudioList:e})}async deleteRecordedAudio(e){return await this.sendWithResponse({deleteRecordedAudio:e})}async getRecordedAudio(e){return await this.sendWithResponse({getRecordedAudio:e})}}function te(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const ae={Manager:class{static clearCurrentUserId(){chrome.storage.local.set({currentUserId:null})}constructor(e,t,a=async()=>[],r=!1,n=!1,i=!0){let l;_("new instance of manager"),this.userIdKey=()=>"currentUserId";const d=this;n||(_("patching chrome.storage"),l=I((async()=>{_("reseting userId key");const e={};e[d.userIdKey()]=null,await chrome.storage.local.set(e)})),this.patchPromise=l),this.defaultBackgroundFn=a,this.managerName=t,this.tokenFn=e,this.needMyxAccount=i,_("needMyxAccount",i),this.token=new U((async()=>await e())),r&&(l||Promise.resolve()).then((async()=>{for(;!d.managerName;)await new Promise((e=>setTimeout(e,200)));const e=await s(null,d.userIdKey());[o.FTAR_ERROR_LIST_ID,o.FTAR_SUCCESS_LIST_ID,o.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{c(t,e)}))})),Y((({visible:e})=>{e?d.setupPolling():d.cancelPolling()}))}cancelPolling(){_("polling stopped");const e=this;e.pollingInterval&&(clearInterval(e.pollingInterval),e.pollingInterval=null)}setupPolling(){const e=this;e.cancelPolling(),_("polling created flexatar started"),e.pollingInterval=setInterval((async()=>{_("trying to poll flexatar in queue");const t=await $.enqueue((async()=>await e.getUserInfo()));_("user info while polling",t);const a=await async function(e,t,a){const r=await s(null,t),n=await i(o.FTAR_PROCESSING_QUEUE_LIST_ID,r);if(_("ftarListProcessing",n),0===n.length)return{status:"empty"};const c=n[0];if(c){c.firtsPollingAttemptAt||(_("first poll for given ftar"),c.firtsPollingAttemptAt=Date.now(),await h(o.FTAR_PROCESSING_QUEUE_LIST_ID,c,{firtsPollingAttemptAt:c.firtsPollingAttemptAt},r));const t=await async function(e,t){_("checkIfFlexatarReady");const a=(await i(o.FTAR_PROCESSING_QUEUE_LIST_ID,t))[0],s=S+"/poll",r=await async function(e,t,a,s){const o=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s})},t);return o.ok?await o.json():404===o.status?{status:"in_progress"}:{error:await o.text()}}(s,e,D,a.ftarId);return _("pollResult",r),r}(e,r),s=Date.now()-c.firtsPollingAttemptAt;if(_("timeSinceFirstPollingAttempt",s),t.success){_("ftar success with img id",c.id),await m(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_SUCCESS_LIST_ID,c,r),await p(o.FTAR_SUCCESS_LIST_ID,5,r),await B(e,{opts:{}},r,a);const s=function(e,t="image/jpeg"){const a=function(e){let t="";const a=new Uint8Array(e),s=a.byteLength;for(let e=0;e<s;e++)t+=String.fromCharCode(a[e]);return se.btoa(t)}(e);return`data:${t};base64,${a}`}(await P({id:c.ftarId},e,r));return await d(l.FTAR_SRC_IMG,c.id,s,r),{status:"ready",id:t.id}}return!1===t.success||t.error||s>2e5?(await m(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_ERROR_LIST_ID,c,r),await p(o.FTAR_ERROR_LIST_ID,5,r),{status:"error"}):(_("flexatarStatus",t),{status:"in_progress"})}}("myx@amial.com"===t.user_id?b:e.token,e.userIdKey(),e.needMyxAccount),r=await s(null,e.userIdKey());if("ready"===a.status&&(await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await E(a);s.push({id:t}),await R(a,s)}(r,a.id),await async function(e){await H(e,await z(e)-1)}(r),e.ports.forEach((e=>{e.postMessage({newFlexatar:{id:a.id,userId:r}})}))),"ready"===a.status||"error"===a.status){const t=await J(e.managerName);_("sending updated progress list"),e.progressPorts.forEach((e=>{e.postMessage({progressLists:t})}))}0===(await i(o.FTAR_PROCESSING_QUEUE_LIST_ID,r)).length&&(_("found empty processing list"),(await i(o.FTAR_MAKE_QUEUE_LIST_ID,r)).length>0&&(_("found flexatar creation task in queue"),e.ftarQueueDelegate(e.token,(()=>{e.progressPorts.forEach((async t=>{t.postMessage({progressLists:await J(e.managerName)})}))}),e.userIdKey())))}),15e3)}showAnimate(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)_("port from effects"),t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)_("effectStateRequest"),t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;_("slot2"),t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}else if(a.slot1){const e=a.slot1;_("slot2"),t.ports.forEach((t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])}))}}}showRetarg(){this.retargPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?(_("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort&&t.onMediaPort(a.mediaPort))}}animPorts=[];showAnim(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}addAnimPort(e){const t=this;this.animPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(_("animation port message",a),a.managerConnectionPort?(_("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort?t.onMediaPort(a.mediaPort):a.animationPatternRequest&&(_("animationPatternRequest",t.ports.length),t.ports.forEach((e=>{e.postMessage(a)}))))}}notificationPorts=[];addNotificationPort(e){this.notificationPorts.push(e),e.onmessage=async e=>{const t=e.data;if(t&&(_("notifiaction port message",t),t.doNotShowOptionChanged)){const e="any_user@world.com";await d(l.DO_NOT_SHOW_NOTIFICATION_ID,t.doNotShowOptionChanged.notificationId,{value:!t.doNotShowOptionChanged.value},e)}}}async showNotification(e,t){let a=await f(l.DO_NOT_SHOW_NOTIFICATION_ID,e,"any_user@world.com",{value:!0});a=a||{value:!0},_("notification needToBeShown",a),a.value&&this.notificationPorts.forEach((a=>{a.postMessage({managerPort:!0,notificationText:t,notificationId:e})}))}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const r=await $.enqueue((async()=>await t.getUserInfo()));_("addProgressPort userInfoResult",r);const n=r.user_id;if(s.progressLists){_("request progress list"),s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await J(t.managerName);e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await d(l.IS_QUEUE_IN_PROGRESS,"",!1,n);else if(s.clearMakeQueue){await c(o.FTAR_MAKE_QUEUE_LIST_ID,n);const a=await J(t.managerName);e.postMessage({progressLists:a})}else s.startMakeQueue&&(await d(l.IS_QUEUE_IN_PROGRESS,"",!0,n),t.ftarQueueDelegate(t.token,(async()=>{const a=await J(t.managerName);_("sending updated progress list"),e.postMessage({progressLists:a})}),t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const a="currentUserId";_("currentUserIdKey",a);const o=await s(null,this.userIdKey());if(o||(this.token.token=null),_("current user id",o),o&&!t){const e=o+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:o,FtarCount:t}}let r=await L(this.token);_("obtained userInf",r),r.error&&(r={FtarCount:"100",user_id:"myx@amial.com"});const n=r.user_id,i={};return i[a]=n,await chrome.storage.local.set(i),await H(n,r.FtarCount),r}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{console.log("manager port not responding"),this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),console.log("manager port ok"),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await $.enqueue((async()=>await t.getUserInfo()));await X(a,{managerPort:!0}),_("lens port connected and answered"),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=V;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const n=a.data;if(n)if(await $.enqueue((async()=>await t.getUserInfo())),n.imagesList){const e=n.imagesList;_("imagesList",e);const a=e.map((e=>({aiPrompt:n.aiPrompt,id:e.id}))),i=await s(null,t.userIdKey()),c="myx@amial.com"===i?b:t.token;await r(o.FTAR_MAKE_QUEUE_LIST_ID,a,i);for(const{dataUrl:t,id:a}of e)_("FTAR_SRC_IMG saved",await d(l.FTAR_SRC_IMG,a,t,i));_("from ftar lens starting ftar creation"),t.ftarQueueDelegate(c,(async()=>{t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await J(t.managerName)})}))}),t.userIdKey()),t.showProgress()}else n.needAuthorize?t.onNeedAuthorize():n.closing?(t.lensPorts=t.lensPorts.filter((t=>t!==e)),console.log("lens port count",t.lensPorts.length)):n.aiPromptsRequest&&(_("ai prompts responsing"),e.postMessage({promptList:await O({load:async()=>{const e=await f("AI_PROMPTS","","no_user");return _("loading stored prompts"),e},save:async e=>{_("saving loaded prompts"),await d("AI_PROMPTS","",e,"no_user")}})}))}}onNeedAuthorize=()=>{_("need authorize")};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const n=a.data;if(!n)return;_("msg on manager port:",n);const p=await $.enqueue((async()=>(Z++,_("userInfo counter",Z),await t.getUserInfo())));if(p.error)return _("uInfo.error",p.error),void e.postMessage({msgID:n.msgID,payload:p});const m=p.user_id,I={};if(I[m]=t.token,I["myx@amial.com"]=b,_("userId",m),n.ftarList){const a=await B(t.token,n,m,t.needMyxAccount);e.postMessage({msgID:n.msgID,payload:a})}else if(n.backgroundsList)G.enqueue((async()=>{if("empty"===t.managerName)return void e.postMessage({msgID:n.msgID,payload:[]});const a=n.opts??{};let s;if(s=a.id?[{id:a.id,userId:a.userId}]:await N(o.FTAR_BACKGROUND_LIST_ID,"id",m,t.needMyxAccount),!s||0===s.length){_("requestiong default backgrounds");const e=await t.defaultBackgroundFn();_("defaultBackgrounds",e);for(const t of e)await w(t,m);s=await N(o.FTAR_BACKGROUND_LIST_ID,"id",m,t.needMyxAccount)}const r=[];for(const{id:e,userId:t}of s){const a=await f(l.BACKGROUND_SRC_IMAGE,e,t);r.push([{id:e,userId:t},a])}e.postMessage({msgID:n.msgID,payload:r})}));else if(n.preview){_("requesting preview",n.preview);let t=await P({id:n.preview.id},I[n.preview.userId],n.preview.userId);if(!t)return void e.postMessage({msgID:n.msgID,payload:null});console.log("previewBuffer",t),e.postMessage({msgID:n.msgID,payload:t},[t])}else if(n.flexatar){_("msg.flexatar",n.flexatar);let t=await async function(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,o=(await chrome.storage.local.get([s]))[s];if(o)return await(await fetch(o)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let r;if(_("get ftar list element",t),t.ftar)r=await fetch(t.ftar,{method:"GET"});else{const a=await F(t.is_myx?b:e,t.id,{ftar:!0});r=await fetch(a.ftar,{method:"GET"})}if(!r.ok)return;const n=await r.arrayBuffer(),i=await T(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}(I[n.flexatar.userId],{id:n.flexatar.id,is_myx:!1},n.flexatar.userId);if(_("ftar buffer ",t),!t)return void e.postMessage({msgID:n.msgID,payload:null});n.setAsCurrent&&(_("setting current ftar id ",n.flexatar,m),await q(n.flexatar,m)),n.setAsCurrentSlot2&&(_("setting current ftar id ",n.flexatar,m),await Q(n.flexatar,m)),_("sending flexatar data"),e.postMessage({msgID:n.msgID,payload:t},[t])}else if(n.closing)t.ports=t.ports.filter((t=>t!==e)),e.close(),console.log("closing port on ftar manager",t.ports.length);else if(n.storeNewBackground){const t=await w(n.storeNewBackground,m);e.postMessage({msgID:n.msgID,payload:{id:t,userId:m}}),e.postMessage({newBackGround:{id:t,userId:m}})}else if(n.getCurrentBkg){let t=await f(l.BACKGROUND_CURRENT_ID,"",m);t||(t=await f(l.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&n.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await f(l.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:n.msgID,payload:t})}else if(n.deleteBackground)g(o.FTAR_BACKGROUND_LIST_ID,n.deleteBackground,m),u(l.BACKGROUND_SRC_IMAGE,n.deleteBackground,m),e.postMessage({msgID:n.msgID,payload:{result:"success"}});else if(n.setCurrentBkg)d(l.BACKGROUND_CURRENT_ID,"",n.setCurrentBkg,m),e.postMessage({msgID:n.msgID,payload:{result:"success"}});else if(n.getSelectedFtar){const t=m+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:n.msgID,payload:{selectedFtar:a}})}else if(n.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(n.setSelectedFtar.value,m),e.postMessage({msgID:n.msgID,payload:{}});else if(n.currentFtarSlot2){n.opts={preview:!0};let a=await j(m);if(!a){const e=await B(t.token,n,m,t.needMyxAccount);await Q(e[0],m)}a=await j(m),_("get current ftar, id",a),e.postMessage({msgID:n.msgID,payload:a})}else if(n.currentFtar){n.opts={preview:!0},_("obtaining current ftar");let a=await K(m);if(!a){_("no current ftar requesting list");const e=await B(t.token,n,m,t.needMyxAccount);await q(e[0],m)}a=await K(m),_("get current ftar, id",a),e.postMessage({msgID:n.msgID,payload:a})}else if(n.makeFlexatar)_("photo obtained"),this.lensPorts.forEach((async e=>{await X(e,{managerPort:!0}),_("lens port connected and answered"),e.postMessage({imageBuffer:n.buffer},[n.buffer])})),e.postMessage({msgID:n.msgID,payload:{status:"ok"}});else if(n.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await E(a);return s=s.filter((({id:e})=>t!==e)),await R(a,s),{isAuthorized:!0}}(m,n.deleteFlexatar),a="myx@amial.com"===m?(_("no deletion on server"),!0):await v({id:n.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(n.deleteFlexatar,m),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(m)),e.postMessage({msgID:n.msgID,payload:{success:a}})}else if(n.userInfo)n.opts?e.postMessage({msgID:n.msgID,payload:await t.getUserInfo(n.opts)}):e.postMessage({msgID:n.msgID,payload:p});else if(n.decrementFtarCount)await H(m,p.FtarCount-1),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.animationPatternResponse)_("animationPatternResponse",n.animationPatternResponse),t.animPorts.forEach((e=>{e.postMessage(n)}));else if(n.effectStateResponse)_("effectStateResponse"),t.effectPorts.forEach((e=>{e.postMessage(n)}));else if(n.showAnimate)t.showAnimate();else if(n.showRetarg)t.showRetarg();else if(n.showEffects)t.showEffects();else if(n.showProgress)t.showProgress();else if(n.setRetargetingStatus)await d(l.RETARGETING_STATUS,"",n.setRetargetingStatus,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getRetargetingStatus){let t=await f(l.RETARGETING_STATUS,"",m);e.postMessage({msgID:n.msgID,payload:t?t.value:null})}else if(n.setRetargetingCalibration)await d(l.RETARGETING_CALIBRATION,"",n.setRetargetingCalibration,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getRetargetingCalibration){let t=await f(l.RETARGETING_CALIBRATION,"",m);e.postMessage({msgID:n.msgID,payload:t})}else if(n.setViewportSize)await d(l.CURRENT_VIEWPORT_SIZE,"",n.setViewportSize,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getViewportSize){let t=await f(l.CURRENT_VIEWPORT_SIZE,"",m,{width:320,height:640});_("posting vieport size"),e.postMessage({msgID:n.msgID,payload:t||{width:640,height:480}})}else if(n.setSpeechPattern)await d(l.CURRENT_SPEECH_PATTERN,"",n.setSpeechPattern,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getSpeechPattern){let t=await f(l.CURRENT_SPEECH_PATTERN,"",m,{value:"calm"});e.postMessage({msgID:n.msgID,payload:t||{value:"calm"}})}else if(n.setMood)await d(l.CURRENT_MOOD,"",n.setMood,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getMood){let t=await f(l.CURRENT_MOOD,"",m,{value:"friendly"});e.postMessage({msgID:n.msgID,payload:t||{value:"friendly"}})}else if(n.getFavorite){const t=await i(o.FTAR_FAV_LIST_ID,m);e.postMessage({msgID:n.msgID,payload:t})}else if(n.removeFromFavorite){const t=n.removeFromFavorite.value;await g(o.FTAR_FAV_LIST_ID,{id:t},m),e.postMessage({msgID:n.msgID,payload:{success:!0}})}else if(n.addToFavorite){const t=n.addToFavorite.value;await async function(e,t,a){const o=await s(a);if(o.error)return o;const r=o+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r],c=t.filter((e=>!i.includes(e)));return c.length>0&&(n[r]=i.concat(c),await chrome.storage.local.set(n)),{success:!0,addedCount:c.length}}(o.FTAR_FAV_LIST_ID,[{id:t}],m),e.postMessage({msgID:n.msgID,payload:{success:!0}})}else if(n.getRecordedAudio){const t=await f(l.RECORDED_AUDIO_ID,n.getRecordedAudio.id,m);e.postMessage({msgID:n.msgID,payload:t})}else if(n.deleteRecordedAudio)await g(o.AUIDIO_RECORD_LIST_ID+"_"+n.deleteRecordedAudio.folder,n.deleteRecordedAudio,m),await u(l.RECORDED_AUDIO_ID,n.deleteRecordedAudio.id,m),e.postMessage({msgID:n.msgID,payload:{success:!0}});else if(n.getRecordedAudioList){const t=await i(o.AUIDIO_RECORD_LIST_ID+"_"+n.getRecordedAudioList,m);e.postMessage({msgID:n.msgID,payload:t})}else if(n.saveAudioEntry){const t=n.saveAudioEntry.folder,a=n.saveAudioEntry.dataUrl;n.saveAudioEntry.dataUrl=void 0,n.saveAudioEntry.folder=void 0,a?(await r(o.AUIDIO_RECORD_LIST_ID+"_"+t,[n.saveAudioEntry],m),await d(l.RECORDED_AUDIO_ID,n.saveAudioEntry.id,a,m)):await h(o.AUIDIO_RECORD_LIST_ID+"_"+t,n.saveAudioEntry.id,n.saveAudioEntry,m),e.postMessage({msgID:n.msgID,payload:{success:!0}})}else if(n.deleteEffectPreset){const t=(await i(o.FTAR_PRESET_LIST_ID,n.deleteEffectPreset.userId)).filter((e=>e.presetId!==n.deleteEffectPreset.presetId));await c(o.FTAR_PRESET_LIST_ID,n.deleteEffectPreset.userId),await r(o.FTAR_PRESET_LIST_ID,t,n.deleteEffectPreset.userId),e.postMessage({msgID:n.msgID,payload:{success:!0}})}else if(n.getEffectPresets){const a=await N(o.FTAR_PRESET_LIST_ID,"presetInfo",m,t.needMyxAccount);e.postMessage({msgID:n.msgID,payload:a})}else if(n.saveEffectPreset)await r(o.FTAR_PRESET_LIST_ID,[n.saveEffectPreset],m),e.postMessage({msgID:n.msgID,payload:{success:{userId:m}}});else if(n.getManagerName)e.postMessage({msgID:n.msgID,payload:t.managerName});else if(n.getUserToken){const a="myx@amial.com"===m?await b.getToken():await t.tokenFn();e.postMessage({msgID:n.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){_("newBackgroundCreated",e),this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}},ManagerConnection:ee,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(y);let o=await s.match(a);if(!o){const r=await F(e,t.id,{ftar:!0});if(o=await fetch(r.ftar,{method:"GET"}),!o.ok)return;const n=await o.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await o.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(y);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const o=await s.arrayBuffer(),r=new Response(new Uint8Array(o),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,r),o}return await s.arrayBuffer()},flexatarList:k,makeFlexatar:async function(t,a,s,o,r){s||(s="");const n=S+"/make",i=await async function(t,a,s,o,r,n,i){const c=await n(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o})},a);if(!c.ok)return console.log("faild obtain make link",await c.json()),{error:{status:c.status}};const l=await c.json();if(l.block)return{success:!1,reason:l.block};i&&await i(l.id);const d=l.link;if(!await e(d,s))return;let f=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(l.poll,{method:"GET"});if(!a.ok)return f+=1,f>10&&(clearInterval(t),e()),void console.log("ftar not ready");const s=await a.json();console.log("ftar ready",s),clearInterval(t),e(s)}),5e3)}))}(n,t,a,s,0,D,r);if(!i)return _("make ftar unexpected"),{error:M};if(i.error)return 401===i.error.status?{error:C}:{error:M};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return o&&(c=o),await F(t,i.id,c)},deleteFlexatar:v,flexatarEntry:F,userInfo:L,GetToken:U,ERR_UNAUTHORIZED:C,ERR_UNEXPECTED:M};if(void 0===se)var se=self;function oe(){console.log("[FTAR_EFFECT_UI_IFRAME]",...arguments)}se.Ftar=ae;const re=new ee;let ne=window.innerWidth,ie=Math.floor(1.1*ne/2);window.addEventListener("resize",(function(){ne=window.innerWidth,ie=Math.floor(1.1*ne/2),oe("flexatarViewWidth:",ie),ce.onCanvasRatio(le||1)})),console.log("Viewport width in pixels:",ne);const ce=new class{constructor(e){const t=document.createElement("canvas");t.width=e?.width??240,t.height=e?.height??320,t.style.display="none",this.canvas=t,t.flexatarCanvas=!0,document.body.appendChild(t);const a=navigator.userAgent.toLowerCase().includes("firefox"),s=t.getContext(a?"2d":"bitmaprenderer"),o=a?e=>{s.drawImage(e,0,0,t.width,t.height),e.close()}:e=>{s.transferFromImageBitmap(e)};this.ctx=s;const r=function(e,t){const a=new OffscreenCanvas(t,320),s=a.getContext("2d");return s.fillStyle="black",s.fillRect(0,0,t,320),s.fillStyle="white",s.font=`${Math.floor(32)}px sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText("WARMING UP",160,160),a.transferToImageBitmap()}(0,320);o(r);const n=new MessageChannel;this.mediaPort=n.port2,this.selfPort=n.port1;let i=!0;this.isActive=!0;const c=this;n.port1.onmessage=e=>{e.data&&e.data.frame?(i&&(console.log("stream ready"),i=!1,this.#t()),this.isActive&&o(e.data.frame)):e.data&&e.data.canvasRatio?c.onCanvasRatio&&c.onCanvasRatio(e.data.canvasRatio):e.data&&e.data.log&&console.log("[VCAM MEDIA STREAM] msg from port",e.data)}}setFrame(e){this.ctx.transferFromImageBitmap(e)}get portToSend(){return this.mediaPort}get port(){return this.selfPort}get stream(){return this.canvas.captureStream(30)}#t=()=>{};set onFirstFrame(e){this.#t=e}destroy(){this.selfPort.postMessage({closing:!0}),this.selfPort.close(),this.canvas.remove()}set size(e){this.canvas.width=e.width,this.canvas.height=e.height}}({width:ie,height:ie});let le,de,fe;function ue(){window.parent.postMessage({closeWindow:!0,portSelf:de,instanceId:fe},"*",[de])}previewHolder.appendChild(ce.canvas),ce.canvas.style.display="block",ce.onCanvasRatio=e=>{le=e;const t=ie,a=Math.floor(t*e);oe("onCanvasRatio",e,a,t),ce.canvas.width=a,ce.canvas.height=t},window.onmessage=e=>{const t=e.data;t&&(t.managerPort?(fe=t.instanceId,t.managerPort.onmessage=Ie,oe("port obtained"),de=t.managerPort,de.postMessage({effectStateRequest:!0}),de.postMessage({msgID:t.msgID}),t.managerPort.postMessage({managerConnectionPort:re.outPort},[re.outPort]),t.managerPort.postMessage({mediaPort:ce.portToSend},[ce.portToSend]),oe("request progress list")):t.closeThisWindow&&ue())},closeButton.onclick=()=>{ce.destroy(),ue()};let ge,pe,me,he,we="NO";function Ie(e){const t=e.data;if(t&&(oe("from manager",t),t.effectStateResponse)){"fake"===t.effectStateResponse&&(t.effectStateResponse={effectIsAnimated:!1,currentMode:0,effectParameter:.5,currentEffectFtarId:null,currentEffectFtarIsMyx:!1}),toggleEffectAnimation.checked=t.effectStateResponse.effectIsAnimated,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed"),effectSlider.value=100*t.effectStateResponse.effectParameter;const e=t.effectStateResponse.currentMode;morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),noEffectButton.classList.remove("active"),t.effectStateResponse.effectIsAnimated&&(effectSlider.disabled=!0),0===e?(noEffectButton.classList.add("active"),we="NO"):1===e?(morphEffectButton.classList.add("active"),we="MORPH"):2===e&&(we="HYBRID",hybridEffectButton.classList.add("active")),re.ready.then((async()=>{oe("connection to manager ready");const e=await re.getList({preview:!0});let a,s=!0;for(const o of e){const e=await re.getPreview(o),r=new Blob([e],{type:"image/jpg"}),n=URL.createObjectURL(r),{holder:i}=await Re(o,n);oe("compare slot 2",t.effectStateResponse.currentEffectFtarId,o.id),t.effectStateResponse.currentEffectFtarId&&t.effectStateResponse.currentEffectFtarId===o.id&&(i.click(),s=!1),a||(a=i)}a&&s&&a.click();const o=await re.getEffectPresets();oe("presetList",o);for(const{presetInfo:e,userId:t}of o){const{ftarLink1:a,ftarLink2:s,effectType:o,effectVal:r,presetId:n}=e;await _e(a,s,o,r,n,t)}oe("presetList",o)}))}}async function _e(e,t,a,s,o,r){const n=await ve(effectPreset,e,t,a,s),i=o;n.userIdPresetBelongs=r,oe("created element with preset id",i),n.onclick=async()=>{ge&&ge.classList.remove("selected"),ge=n,n.classList.add("selected");const o=await re.getFlexatar(e,!0,!1),r=await re.getFlexatar(t,!1,!0);let c;de&&(de.postMessage({...e,slot1:o},[o]),de.postMessage({...t,slot2:r},[r])),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),noEffectButton.classList.remove("active"),"MORPH"===a?(de.postMessage({morphEffect:!0,isEffectMessage:Ee}),morphEffectButton.classList.add("active")):"HYBRID"===a?(de.postMessage({hybridEffect:!0,isEffectMessage:Ee}),hybridEffectButton.classList.add("active")):(de.postMessage({noEffect:!0,isEffectMessage:Ee}),noEffectButton.classList.add("active"));try{const e=parseInt(s,10);if(isNaN(e))throw new Error("Parsed effectVal is NaN");effectSlider.value=e,toggleEffectAnimation.checked=!1,de.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ee}),de.postMessage({effectParameter:e/100,isEffectMessage:Ee}),effectSlider.classList.remove("cursor-not-allowed"),c=e}catch{effectSlider.classList.add("cursor-not-allowed"),toggleEffectAnimation.checked=!0,c="A",de.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ee})}we=a,Se&&Se.remove(),Se=await ve(presetPlaceHolder,e,t,we,c),Te("preview_"+("slot1"===Pe?e.id:t.id)),trashIcon.disabled=!1,pe=i,oe("setting current preset id",pe)}}const ye={};async function Re(e,t,a){ye[e.id]=e;const s=t,o=document.createElement("span");o.className="item-holder";const r=document.createElement("img");r.src=s,r.draggable=!1,r.id="preview_"+e.id,r.style.cursor="pointer",r.style.display="block",r.style.width="100%",r.style.height="auto",r.style.margin="0px",r.style.padding="0px",r.style.boxSizing="border-box",r.style.lineHeight="0px",r.style.verticalAlign="top",r.style.objectFit="contain",o.appendChild(r),console.log("appending preview image"),o.id=e.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(o,previewListHolder.firstChild):previewListHolder.appendChild(o),o.onclick=async()=>{if(slot1Button.disabled=slot2Button.disabled=!0,me&&me.classList.remove("selected-item"),me=o,o.classList.add("selected-item"),he&&he.ftarId===e.id)return void(slot1Button.disabled=slot2Button.disabled=!1);let t;he={element:o,ftarId:e.id,ftarLink:e},o.appendChild(n);let a=0;for(;!(t||(t=await re.getFlexatar(e,"slot1"===Pe,"slot2"===Pe),await new Promise((e=>setTimeout(e,1e3))),console.log("ftarBuffer",t),a+=1,a>7)););if(de){const a={...e,slot2:t};a[Pe]=t,de.postMessage(a,[t])}n.remove(),slot1Button.disabled=slot2Button.disabled=!1},console.log("selecteFtar",he,e.id),he&&he.ftarId===e.id&&(he.element=o,o.click()),{holder:o,previewImg:s}}const Ee=!0;let Se;async function ve(e,t,a,s,o){const r=document.createElement("span");r.classList.add("preset-line");for(const e of[t,a]){oe("requestPreview",e);const t=await re.getPreview(e),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),o=document.createElement("img");o.src=s,r.appendChild(o)}const n=document.createElement("span");return n.className="top-overlay small-font",n.textContent=s+" "+o,r.appendChild(n),e.appendChild(r),r}function Te(e){me&&me.classList.remove("selected-item"),me=document.getElementById(e),me.classList.add("selected-item")}noEffectButton.onclick=()=>{de.postMessage({noEffect:!0,isEffectMessage:Ee}),noEffectButton.classList.add("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.remove("active"),we="NO"},morphEffectButton.onclick=()=>{de.postMessage({morphEffect:!0,isEffectMessage:Ee}),noEffectButton.classList.remove("active"),morphEffectButton.classList.add("active"),hybridEffectButton.classList.remove("active"),we="MORPH"},hybridEffectButton.onclick=()=>{de.postMessage({hybridEffect:!0,isEffectMessage:Ee}),noEffectButton.classList.remove("active"),morphEffectButton.classList.remove("active"),hybridEffectButton.classList.add("active"),we="HYBRID"},toggleEffectAnimation.onchange=()=>{de.postMessage({isAnimated:{state:toggleEffectAnimation.checked},isEffectMessage:Ee}),effectSlider.disabled=toggleEffectAnimation.checked,toggleEffectAnimation.checked?effectSlider.classList.add("cursor-not-allowed"):effectSlider.classList.remove("cursor-not-allowed")},effectSlider.oninput=()=>{oe("effect changing"),de.postMessage({effectParameter:effectSlider.value/100,isEffectMessage:Ee})},effectTabButton.onclick=()=>{Se&&(effectControls.classList.remove("invisible"),ftarSelectContainer.classList.remove("invisible"),effectPreset.classList.add("invisible"),currentPresetHolder.classList.add("invisible"),effectTabButton.classList.add("active"),presetTabButton.classList.remove("active"),Se.remove(),Se=null)},presetTabButton.onclick=async()=>{if(Se)return;effectControls.classList.add("invisible"),ftarSelectContainer.classList.add("invisible"),effectPreset.classList.remove("invisible"),currentPresetHolder.classList.remove("invisible"),effectTabButton.classList.remove("active"),presetTabButton.classList.add("active");const e=await re.getCurrentFtar(),t=await re.getCurrentFtarSlot2();Se=await ve(presetPlaceHolder,e,t,we,effectSlider.value)},addPreset.onclick=async()=>{const e=await re.getCurrentFtar(),t=await re.getCurrentFtarSlot2(),a=toggleEffectAnimation.checked?"A":effectSlider.value,s={ftarLink1:e,ftarLink2:t,effectType:we,effectVal:a,presetId:crypto.randomUUID()};oe("presetInfo",s);const{success:o}=await re.saveEffectPreset(s);_e(e,t,we,a,o.userId)};let Pe="slot2";slot1Button.onclick=async()=>{Pe="slot1",slot1Button.classList.add("active"),slot2Button.classList.remove("active"),Te("preview_"+(await re.getCurrentFtar()).id)},slot2Button.onclick=async()=>{Pe="slot2",slot1Button.classList.remove("active"),slot2Button.classList.add("active"),Te("preview_"+(await re.getCurrentFtarSlot2()).id)},trashIcon.onclick=async()=>{if(!pe||!ge)return oe("can not delate disabling"),void(trashIcon.disabled=!0);await re.deleteEffectPreset({presetId:pe,userId:ge.userIdPresetBelongs}),ge.remove(),trashIcon.disabled=!0}})();
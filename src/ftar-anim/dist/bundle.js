(()=>{"use strict";async function e(e,t){const a=new FormData;return Object.entries(e.fields).forEach(([e,t])=>{a.append(e,t)}),a.append("file",t),(await fetch(e.url,{method:"POST",body:a})).ok?(console.log("ftar send img ok"),!0):(console.error("send img failed"),!1)}class t{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()})}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}function a(){console.log("[FTAR_QUEUE_STORAGE]",...arguments)}async function s(e,t="currentUserId"){if(e)return e;const s={};s[t]=null;const n=await chrome.storage.local.get(s);return a("currentUserId",n),n?n[t]:{error:"not_authorized"}}const n={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue"};async function o(e,t,a){const n=await s(a);if(n.error)return n;const o=n+e,r={};r[o]=[];const i=(await chrome.storage.local.get(r))[o].concat(t);return r[o]=i,await chrome.storage.local.set(r),{success:!0}}async function r(e,t,a){const n=await s(a);if(n.error)return n;const o=n+e,r={};r[o]=[];const i=t;return r[o]=i,await chrome.storage.local.set(r),{success:!0}}async function i(e,t){const a=await s(t);if(a.error)return a;const n=a+e,o={};return o[n]=[],(await chrome.storage.local.get(o))[n]}async function c(e,t){a("clear list",e);const n=await s(t);if(n.error)return n;const o=n+e;await chrome.storage.local.remove([o]),a("clear list done",o)}const l={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",RETARGETING_CALIBRATION:"_retargeting_calibration_"};async function u(e,t,n,o){const r=await s(o);if(r.error)return r;const i={};i[r+e+t]=n;try{return await chrome.storage.local.set(i),{success:!0}}catch(e){return a(e),{error:"unknown"}}}async function d(e,t,a,n=null){const o=await s(a);if(o.error)return o;const r=o+e+t,i={};i[r]=null;const c=await chrome.storage.local.get(i);return null===c[r]?n:c[r]}async function g(e,t,a){const n=await s(a);if(n.error)return n;const o=n+e+t;await chrome.storage.local.remove([o])}async function f(e,t,s,n="id"){const o=await i(e,s);let c=t[n];c||(c=t),a("queueList",o,e);const l=o.filter(e=>(e[n]||e)!==c);a("newList",l),await r(e,l,s)}async function m(e,t,a){let s=await i(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await g(l.FTAR_SRC_IMG,t.id,a)}await r(e,s,a)}async function p(e,t,a,n){await f(e,a,n),await async function(e,t,a){const n=await s(a);if(n.error)return n;const o=n+e,r={};r[o]=[];const i=(await chrome.storage.local.get(r))[o],c=t.concat(i);return r[o]=c,await chrome.storage.local.set(r),{success:!0}}(t,[a],n)}async function h(e,t,s,n,o="id"){const c=await i(e,n);let l=t[o];l||(l=t),a("list content",c,e);const u=c.filter(e=>(e[o]||e)===l);a("list with target element",u),Object.assign(u[0],s),await r(e,c,n)}function w(e,t){return new Promise(s=>{const r=crypto.randomUUID();a("background imageId",r),i(n.FTAR_BACKGROUND_LIST_ID,t).then(i=>{a("background list",i),o(n.FTAR_BACKGROUND_LIST_ID,[r],t).then(n=>{a("add to list",n),u(l.BACKGROUND_SRC_IMAGE,r,e,t).then(e=>{a("BACKGROUND_SRC_IMG saved",e),s(r)})})})})}async function y(e){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===t)var t=self;"undefined"==typeof chrome&&(t.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const a="flexatar-storage-cache",s=e=>new Request(`https://flexatar-mock-storage/${e}`),n=e=>new URL(e).pathname.slice(1),o=await caches.open(a);chrome.storage.local.set=async e=>{const t=Object.entries(e).map(async([e,t])=>{const a=JSON.stringify({value:t}),n=new Response(a,{headers:{"Content-Type":"application/json"}});await o.put(s(e),n)});await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const a={};if(null==e){const e=(await o.keys()).map(e=>n(e.url));return t&&t(e),e}const r=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map(async t=>{const n=await o.match(s(t));if(n){const e=await n.json();a[t]=e.value}else a[t]="object"==typeof e&&null!==e?e[t]:void 0});return await Promise.all(r),t&&t(a),a},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map(e=>o.delete(s(e)));console.log("start del keys"),await Promise.all(t),console.log("end del keys")},e&&await e()}}function I(...e){const t=(new Date).toLocaleTimeString();console.log(`[${t}] [FTAR_CONNECTION]`,...e)}const _="ftarcache";async function R(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function E(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const P="https://api.flexatar-sdk.com";async function S(e,t){const a=P+"/"+e.id;t||(t=e.token);const s={};try{const e=await v(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:D}:{error:C}}catch(e){return console.error("Flexatar deletion:",e),!1}}function T(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)})}async function A(e,t,a,s=0){const n=a+"_ftarpreview_"+e.id,o=(await chrome.storage.local.get([n]))[n];if(o)return await(await fetch(o)).arrayBuffer();if(e.preview){const t=await k(e,a);if(t)return t}const r=await F(t,e.id,{preview:!0});return e.preview=r.preview,await k(e,a)}async function k(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const n=await s.arrayBuffer(),o=await T(n),r={};return r[a]=o,I("store preview",r),await chrome.storage.local.set(r),n}async function v(e,t,a,s){const n=await a.getToken();if("no_token"===n)return n;t.headers.Authorization="Bearer "+n;const o=await self.fetch(e,t);return 403!=o.status?o:(s||(s=2),s<=0?o:(s-=1,a.token=null,await v(e,t,a,s)))}const D="unauthorized",C="UNEXPECTED";async function M(e,t){const a=P+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const n=await v(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);return n.ok?(await n.json()).all:401===n.status?{error:D}:{error:C}}async function F(e,t,a){const s=P+"/list",n={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const r={};r[t]=o;try{const a=await v(s,{method:"POST",headers:n,body:JSON.stringify(r)},e);return a.ok?(await a.json()).requested[t]:401===a.status?{error:D}:{error:C}}catch(e){console.error("Flexatar list failed:",e)}}async function U(e){I("requesting user info from cloud");const t=await v(P+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);return"no_token"===t?{error:D}:t.ok?await t.json():401===t.status?{error:D}:{error:C}}class L{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,I("GetToken",t),t}}async function N(e,t,a,s=!0){I("getListDualUser needMyx",s);let n=await i(e,a);return n=n.map(e=>{const s={userId:a};return s[t]=e,s}),"myx@amial.com"!==a&&s&&(n=n.concat((await i(e,"myx@amial.com")).map(e=>{const a={userId:"myx@amial.com"};return a[t]=e,a}))),n}async function x(e,t,a,s=!0){let n=[];if("myx@amial.com"===a)t.opts.noCache=!1,n=await q(b,t,a,!1),n=n.reverse(),I("ftarList myx",n);else if(n=await q(e,t,a,!1),n=n.reverse(),s){t.opts.noCache=!1;const e=await q(b,t,"myx@amial.com",!1);n=n.concat(e.reverse())}return n}async function O(e){const t=[{caption:"ðŸ’¡ Warm Tone",prompt:"Soft golden light wraps around the face, brightening skin and adding a natural warmth. Subtle highlights on the forehead and cheeks create depth. The eyes gain a gentle amber reflection. The overall mood feels sunlit and inviting."},{caption:"ðŸŒ† Cool Tone",prompt:"A calm blue-gray tone softens the scene, giving the portrait a quiet cinematic feel. The skin tone shifts slightly toward cooler neutrals. Shadows contour the face with precise, modern clarity. Eyes reflect faint steel-blue hues."},{caption:"ðŸŒˆ Color Boost",prompt:"Colors appear more vivid and balanced, with deeper contrasts and sharper definition. Light glances across skin textures, giving life to every detail. Subtle chromatic tones enhance vitality. The effect feels crisp, clean, and refined."}];try{let a;if(e&&(a=await e.load()),a)return a;const s=await fetch("https://api.flexatar-sdk.com/aiprompt");return s.ok?(a=await s.json(),e.save(a),a):t}catch(e){return t}}const b=new L(async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken/androidapp");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}()),B=new t,G=new t;async function q(e,t,a,s=!1){return await B.enqueue(async()=>{const s=a+"_ftarlist";let n=t.opts.noCache?null:await E(s);return I("ftar list from storage",n),n||(I("fetching list",a),n=await M(e,t.opts),n.error?I("ftarList.error",n.error):await R(s,n)),n.forEach(e=>{e.userId=a}),n})}async function Q(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function W(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function j(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function K(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function z(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function V(e,t){const a=e+"_FtarCount",s={};s[a]=t,I("setting ftar count at key",a,"count is",t),await chrome.storage.local.set(s)}async function J(t,a,o){const r=await s(null,o);if(!await d(l.IS_QUEUE_IN_PROGRESS,"",r,!0))return void I("flexatar creation is on pause");const c=await async function(e){const t=await i(n.FTAR_PROCESSING_QUEUE_LIST_ID,e),a=await d(l.IS_QUEUE_IN_PROGRESS,"",e,!0);return I("isQueueInProgress",a,t),(0!==t.length||!a)&&t[0]}(r);if(I("isFlexatarInProgress",c),c)return void I("flexatar in progress");const u=(await i(n.FTAR_MAKE_QUEUE_LIST_ID,r))[0];if(u){I("Start creation of flexatar for image id",u);const r=await s(null,o);await p(n.FTAR_MAKE_QUEUE_LIST_ID,n.FTAR_PROCESSING_QUEUE_LIST_ID,u,r);const i=P+"/make",c=await async function(e,t,a,s){let n=s?JSON.stringify({aiPrompt:JSON.parse(JSON.parse(s))}):void 0;const o=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:n},t);if(!o.ok)return console.log("faild obtain make link",await o.json()),{error:{type:"unknown",message:o.status}};const r=await o.json();return r.block?{error:{type:"block",reason:r.block}}:r}(i,t,v,u.aiPrompt);if(c.error)return I("upload link error"),await p(n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_ERROR_LIST_ID,u,r),await m(n.FTAR_ERROR_LIST_ID,5,r),void(a&&a());I("obtained ftar link with id",c.id),await h(n.FTAR_PROCESSING_QUEUE_LIST_ID,u.id,{ftarId:c.id},r);const g=await d(l.FTAR_SRC_IMG,u.id,r);if(g){const t=function(e,t){const[a,s]=e.split(","),n=a.match(/:(.*?);/),o=n?n[1]:"application/octet-stream",r=atob(s),i=Uint8Array.from(r,e=>e.charCodeAt(0));return new File([i],t,{type:o})}(g);await e(c.link,t)||await async function(){await p(n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_ERROR_LIST_ID,imgId,currentUserId),await m(n.FTAR_ERROR_LIST_ID,5,currentUserId)}()}}}async function Z(e){const t={successImages:n.FTAR_SUCCESS_LIST_ID,errorImages:n.FTAR_ERROR_LIST_ID,queueImages:n.FTAR_MAKE_QUEUE_LIST_ID},a="currentUserId",o=await s(null,a),r={};for(const[e,s]of Object.entries(t)){I("user id when loading lists",o,a);const t=await i(s,o);I("loaded list",e,s,t);const n=t.map(async e=>await d(l.FTAR_SRC_IMG,e.id,o));r[e]=await Promise.all(n)}const c=[n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of c){const t=(await i(e,o)).map(async e=>await d(l.FTAR_SRC_IMG,e.id,o)),a=await Promise.all(t);a&&a.length>0&&r.queueImages.unshift(a[0])}return I("progressLists",r),I("getting ftar count to progress userId",o),r.flexatarCount=await z(o),r.isQueueInProgress=await d(l.IS_QUEUE_IN_PROGRESS,"",o,!0),r}const $=new t;let H=0;function X(e){if(I("visibilityTracker","undefined"!=typeof document),"undefined"!=typeof document){function t(){document.hidden?e({visible:!1}):e({visible:!0})}document.addEventListener("visibilitychange",t),document.hidden||e({visible:!0})}else self.addEventListener("message",t=>{console.log("Worker received:",t.data),t.data.documentState&&e(t.data.documentState)}),self.postMessage({visibilityRequest:!0})}function Y(e,t){const a=te();return t.msgID=a,new Promise(s=>{e.addEventListener("message",function t(n){n.data&&(I("responese",n.data),n.data.msgID===a&&(s(n.data.payload),e.removeEventListener("message",t)))}),e.postMessage(t)})}class ee{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.animationPatternRequest?this.onAnimationPatternRequest&&this.onAnimationPatternRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise(t=>{e.port1.addEventListener("message",function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))})})}sendWithResponse(e){const t=te();e.msgID=t;const a=this.port;return new Promise(s=>{a.addEventListener("message",function e(n){n.data&&(I("responese",n.data),n.data.msgID===t&&(s(n.data.payload),a.removeEventListener("message",e)))}),a.postMessage(e)})}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise((s,n)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>n(e)})}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}async showAnimate(){return await this.sendWithResponse({showAnimate:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}}function te(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const ae={Manager:class{static clearCurrentUserId(){chrome.storage.local.set({currentUserId:null})}constructor(e,t,a=async()=>[],o=!1,r=!1,i=!0){let l;I("new instance of manager"),this.userIdKey=()=>"currentUserId";const u=this;r||(I("patching chrome.storage"),l=y(async()=>{I("reseting userId key");const e={};e[u.userIdKey()]=null,await chrome.storage.local.set(e)}),this.patchPromise=l),this.defaultBackgroundFn=a,this.managerName=t,this.tokenFn=e,this.needMyxAccount=i,I("needMyxAccount",i),this.token=new L(async()=>await e()),o&&(l||Promise.resolve()).then(async()=>{for(;!u.managerName;)await new Promise(e=>setTimeout(e,200));const e=await s(null,u.userIdKey());[n.FTAR_ERROR_LIST_ID,n.FTAR_SUCCESS_LIST_ID,n.FTAR_PROCESSING_QUEUE_LIST_ID].forEach(t=>{c(t,e)})}),X(({visible:e})=>{e?u.setupPolling():u.cancelPolling()})}cancelPolling(){I("polling stopped");const e=this;e.pollingInterval&&(clearInterval(e.pollingInterval),e.pollingInterval=null)}setupPolling(){const e=this;e.cancelPolling(),I("polling created flexatar started"),e.pollingInterval=setInterval(async()=>{I("trying to poll flexatar in queue");const t=await $.enqueue(async()=>await e.getUserInfo());I("user info while polling",t);const a=await async function(e,t,a){const o=await s(null,t),r=await i(n.FTAR_PROCESSING_QUEUE_LIST_ID,o);if(I("ftarListProcessing",r),0===r.length)return{status:"empty"};const c=r[0];if(c){c.firtsPollingAttemptAt||(I("first poll for given ftar"),c.firtsPollingAttemptAt=Date.now(),await h(n.FTAR_PROCESSING_QUEUE_LIST_ID,c,{firtsPollingAttemptAt:c.firtsPollingAttemptAt},o));const t=await async function(e,t){I("checkIfFlexatarReady");const a=(await i(n.FTAR_PROCESSING_QUEUE_LIST_ID,t))[0],s=P+"/poll",o=await async function(e,t,a,s){const n=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s})},t);return n.ok?await n.json():404===n.status?{status:"in_progress"}:{error:await n.text()}}(s,e,v,a.ftarId);return I("pollResult",o),o}(e,o),s=Date.now()-c.firtsPollingAttemptAt;if(I("timeSinceFirstPollingAttempt",s),t.success){I("ftar success with img id",c.id),await p(n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_SUCCESS_LIST_ID,c,o),await m(n.FTAR_SUCCESS_LIST_ID,5,o),await x(e,{opts:{}},o,a);const s=function(e,t="image/jpeg"){const a=function(e){let t="";const a=new Uint8Array(e),s=a.byteLength;for(let e=0;e<s;e++)t+=String.fromCharCode(a[e]);return se.btoa(t)}(e);return`data:${t};base64,${a}`}(await A({id:c.ftarId},e,o));return await u(l.FTAR_SRC_IMG,c.id,s,o),{status:"ready",id:t.id}}return!1===t.success||t.error||s>2e5?(await p(n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_ERROR_LIST_ID,c,o),await m(n.FTAR_ERROR_LIST_ID,5,o),{status:"error"}):(I("flexatarStatus",t),{status:"in_progress"})}}("myx@amial.com"===t.user_id?b:e.token,e.userIdKey(),e.needMyxAccount),o=await s(null,e.userIdKey());if("ready"===a.status&&(await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await E(a);s.push({id:t}),await R(a,s)}(o,a.id),await async function(e){await V(e,await z(e)-1)}(o),e.ports.forEach(e=>{e.postMessage({newFlexatar:{id:a.id,userId:o}})})),"ready"===a.status||"error"===a.status){const t=await Z(e.managerName);I("sending updated progress list"),e.progressPorts.forEach(e=>{e.postMessage({progressLists:t})})}0===(await i(n.FTAR_PROCESSING_QUEUE_LIST_ID,o)).length&&(I("found empty processing list"),(await i(n.FTAR_MAKE_QUEUE_LIST_ID,o)).length>0&&(I("found flexatar creation task in queue"),e.ftarQueueDelegate(e.token,()=>{e.progressPorts.forEach(async t=>{t.postMessage({progressLists:await Z(e.managerName)})})},e.userIdKey())))},15e3)}showAnimate(){this.animPorts.forEach(e=>{e.postMessage({managerPort:!0})})}showEffects(){this.effectPorts.forEach(e=>{e.postMessage({managerPort:!0})})}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)I("port from effects"),t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach(e=>{e.postMessage(a)});else if(a.effectStateRequest)I("effectStateRequest"),t.ports.forEach(e=>{e.postMessage(a)});else if(a.slot2){const e=a.slot2;I("slot2"),t.ports.forEach(t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])})}else if(a.slot1){const e=a.slot1;I("slot2"),t.ports.forEach(t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])})}}}showRetarg(){this.retargPorts.forEach(e=>{e.postMessage({managerPort:!0})})}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?(I("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort&&t.onMediaPort(a.mediaPort))}}animPorts=[];showAnim(){this.animPorts.forEach(e=>{e.postMessage({managerPort:!0})})}addAnimPort(e){const t=this;this.animPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(I("animation port message",a),a.managerConnectionPort?(I("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort?t.onMediaPort(a.mediaPort):a.animationPatternRequest&&(I("animationPatternRequest",t.ports.length),t.ports.forEach(e=>{e.postMessage(a)})))}}showProgress(){this.progressPorts.forEach(e=>{e.postMessage({managerPort:!0})})}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const o=await $.enqueue(async()=>await t.getUserInfo());I("addProgressPort userInfoResult",o);const r=o.user_id;if(s.progressLists){I("request progress list"),s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await Z(t.managerName);e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await u(l.IS_QUEUE_IN_PROGRESS,"",!1,r);else if(s.clearMakeQueue){await c(n.FTAR_MAKE_QUEUE_LIST_ID,r);const a=await Z(t.managerName);e.postMessage({progressLists:a})}else s.startMakeQueue&&(await u(l.IS_QUEUE_IN_PROGRESS,"",!0,r),t.ftarQueueDelegate(t.token,async()=>{const a=await Z(t.managerName);I("sending updated progress list"),e.postMessage({progressLists:a})},t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const a="currentUserId";I("currentUserIdKey",a);const n=await s(null,this.userIdKey());if(n||(this.token.token=null),I("current user id",n),n&&!t){const e=n+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:n,FtarCount:t}}let o=await U(this.token);I("obtained userInf",o),o.error&&(o={FtarCount:"100",user_id:"myx@amial.com"});const r=o.user_id,i={};return i[a]=r,await chrome.storage.local.set(i),await V(r,o.FtarCount),o}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout(()=>{console.log("manager port not responding"),this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)},5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),console.log("manager port ok"),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach(async a=>{const s=await $.enqueue(async()=>await t.getUserInfo());await Y(a,{managerPort:!0}),I("lens port connected and answered"),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])})}lensPorts=[];ftarQueueDelegate=J;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const r=a.data;if(r)if(await $.enqueue(async()=>await t.getUserInfo()),r.imagesList){const e=r.imagesList;I("imagesList",e);const a=e.map(e=>({aiPrompt:r.aiPrompt,id:e.id})),i=await s(null,t.userIdKey()),c="myx@amial.com"===i?b:t.token;await o(n.FTAR_MAKE_QUEUE_LIST_ID,a,i);for(const{dataUrl:t,id:a}of e)I("FTAR_SRC_IMG saved",await u(l.FTAR_SRC_IMG,a,t,i));I("from ftar lens starting ftar creation"),t.ftarQueueDelegate(c,async()=>{t.progressPorts.forEach(async e=>{e.postMessage({progressLists:await Z(t.managerName)})})},t.userIdKey()),t.showProgress()}else r.needAuthorize?t.onNeedAuthorize():r.closing?(t.lensPorts=t.lensPorts.filter(t=>t!==e),console.log("lens port count",t.lensPorts.length)):r.aiPromptsRequest&&(I("ai prompts responsing"),e.postMessage({promptList:await O({load:async()=>{const e=await d("AI_PROMPTS","","no_user");return I("loading stored prompts"),e},save:async e=>{I("saving loaded prompts"),await u("AI_PROMPTS","",e,"no_user")}})}))}}onNeedAuthorize=()=>{I("need authorize")};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter(t=>t!==e);this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;I("msg on manager port:",s);const r=await $.enqueue(async()=>(H++,I("userInfo counter",H),await t.getUserInfo()));if(r.error)return I("uInfo.error",r.error),void e.postMessage({msgID:s.msgID,payload:r});const m=r.user_id,p={};if(p[m]=t.token,p["myx@amial.com"]=b,I("userId",m),s.ftarList){const a=await x(t.token,s,m,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.backgroundsList)G.enqueue(async()=>{if("empty"===t.managerName)return void e.postMessage({msgID:s.msgID,payload:[]});const a=s.opts??{};let o;if(o=a.id?[{id:a.id,userId:a.userId}]:await N(n.FTAR_BACKGROUND_LIST_ID,"id",m,t.needMyxAccount),!o||0===o.length){I("requestiong default backgrounds");const e=await t.defaultBackgroundFn();I("defaultBackgrounds",e);for(const t of e)await w(t,m);o=await N(n.FTAR_BACKGROUND_LIST_ID,"id",m,t.needMyxAccount)}const r=[];for(const{id:e,userId:t}of o){const a=await d(l.BACKGROUND_SRC_IMAGE,e,t);r.push([{id:e,userId:t},a])}e.postMessage({msgID:s.msgID,payload:r})});else if(s.preview){I("requesting preview",s.preview);let t=await A({id:s.preview.id},p[s.preview.userId],s.preview.userId);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});console.log("previewBuffer",t),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.flexatar){I("msg.flexatar",s.flexatar);let t=await async function(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,n=(await chrome.storage.local.get([s]))[s];if(n)return await(await fetch(n)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let o;if(I("get ftar list element",t),t.ftar)o=await fetch(t.ftar,{method:"GET"});else{const a=await F(t.is_myx?b:e,t.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const r=await o.arrayBuffer(),i=await T(r),c={};return c[s]=i,await chrome.storage.local.set(c),r}(p[s.flexatar.userId],{id:s.flexatar.id,is_myx:!1},s.flexatar.userId);if(I("ftar buffer ",t),!t)return void e.postMessage({msgID:s.msgID,payload:null});s.setAsCurrent&&(I("setting current ftar id ",s.flexatar,m),await Q(s.flexatar,m)),s.setAsCurrentSlot2&&(I("setting current ftar id ",s.flexatar,m),await W(s.flexatar,m)),I("sending flexatar data"),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.closing)t.ports=t.ports.filter(t=>t!==e),e.close(),console.log("closing port on ftar manager",t.ports.length);else if(s.storeNewBackground){const t=await w(s.storeNewBackground,m);e.postMessage({msgID:s.msgID,payload:{id:t,userId:m}}),e.postMessage({newBackGround:{id:t,userId:m}})}else if(s.getCurrentBkg){let t=await d(l.BACKGROUND_CURRENT_ID,"",m);t||(t=await d(l.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&s.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await d(l.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteBackground)f(n.FTAR_BACKGROUND_LIST_ID,s.deleteBackground,m),g(l.BACKGROUND_SRC_IMAGE,s.deleteBackground,m),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.setCurrentBkg)u(l.BACKGROUND_CURRENT_ID,"",s.setCurrentBkg,m),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.getSelectedFtar){const t=m+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:s.msgID,payload:{selectedFtar:a}})}else if(s.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(s.setSelectedFtar.value,m),e.postMessage({msgID:s.msgID,payload:{}});else if(s.currentFtarSlot2){s.opts={preview:!0};let a=await j(m);if(!a){const e=await x(t.token,s,m,t.needMyxAccount);await W(e[0],m)}a=await j(m),I("get current ftar, id",a),e.postMessage({msgID:s.msgID,payload:a})}else if(s.currentFtar){s.opts={preview:!0},I("obtaining current ftar");let a=await K(m);if(!a){I("no current ftar requesting list");const e=await x(t.token,s,m,t.needMyxAccount);await Q(e[0],m)}a=await K(m),I("get current ftar, id",a),e.postMessage({msgID:s.msgID,payload:a})}else if(s.makeFlexatar)I("photo obtained"),this.lensPorts.forEach(async e=>{await Y(e,{managerPort:!0}),I("lens port connected and answered"),e.postMessage({imageBuffer:s.buffer},[s.buffer])}),e.postMessage({msgID:s.msgID,payload:{status:"ok"}});else if(s.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await E(a);return s=s.filter(({id:e})=>t!==e),await R(a,s),{isAuthorized:!0}}(m,s.deleteFlexatar),a="myx@amial.com"===m?(I("no deletion on server"),!0):await S({id:s.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(s.deleteFlexatar,m),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(m)),e.postMessage({msgID:s.msgID,payload:{success:a}})}else if(s.userInfo)s.opts?e.postMessage({msgID:s.msgID,payload:await t.getUserInfo(s.opts)}):e.postMessage({msgID:s.msgID,payload:r});else if(s.decrementFtarCount)await V(m,r.FtarCount-1),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.animationPatternResponse)I("animationPatternResponse",s.animationPatternResponse),t.animPorts.forEach(e=>{e.postMessage(s)});else if(s.effectStateResponse)I("effectStateResponse"),t.effectPorts.forEach(e=>{e.postMessage(s)});else if(s.showAnimate)t.showAnimate();else if(s.showRetarg)t.showRetarg();else if(s.showEffects)t.showEffects();else if(s.showProgress)t.showProgress();else if(s.setRetargetingStatus)await u(l.RETARGETING_STATUS,"",s.setRetargetingStatus,m),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingStatus){let t=await d(l.RETARGETING_STATUS,"",m);e.postMessage({msgID:s.msgID,payload:t?t.value:null})}else if(s.setRetargetingCalibration)await u(l.RETARGETING_CALIBRATION,"",s.setRetargetingCalibration,m),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingCalibration){let t=await d(l.RETARGETING_CALIBRATION,"",m);e.postMessage({msgID:s.msgID,payload:t})}else if(s.setViewportSize)await u(l.CURRENT_VIEWPORT_SIZE,"",s.setViewportSize,m),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getViewportSize){let t=await d(l.CURRENT_VIEWPORT_SIZE,"",m,{width:320,height:640});I("posting vieport size"),e.postMessage({msgID:s.msgID,payload:t||{width:640,height:480}})}else if(s.deleteEffectPreset){const t=(await i(n.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId)).filter(e=>e.presetId!==s.deleteEffectPreset.presetId);await c(n.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId),await o(n.FTAR_PRESET_LIST_ID,t,s.deleteEffectPreset.userId),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.getEffectPresets){const a=await N(n.FTAR_PRESET_LIST_ID,"presetInfo",m,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.saveEffectPreset)await o(n.FTAR_PRESET_LIST_ID,[s.saveEffectPreset],m),e.postMessage({msgID:s.msgID,payload:{success:{userId:m}}});else if(s.getManagerName)e.postMessage({msgID:s.msgID,payload:t.managerName});else if(s.getUserToken){const a="myx@amial.com"===m?await b.getToken():await t.tokenFn();e.postMessage({msgID:s.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){I("newBackgroundCreated",e),this.ports.forEach(t=>{t.postMessage({newBackGround:e})})}},ManagerConnection:ee,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(_);let n=await s.match(a);if(!n){const o=await F(e,t.id,{ftar:!0});if(n=await fetch(o.ftar,{method:"GET"}),!n.ok)return;const r=await n.arrayBuffer(),i=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),r}return await n.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(_);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const n=await s.arrayBuffer(),o=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,o),n}return await s.arrayBuffer()},flexatarList:M,makeFlexatar:async function(t,a,s,n,o){s||(s="");const r=P+"/make",i=await async function(t,a,s,n,o,r,i){const c=await r(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n})},a);if(!c.ok)return console.log("faild obtain make link",await c.json()),{error:{status:c.status}};const l=await c.json();if(l.block)return{success:!1,reason:l.block};i&&await i(l.id);const u=l.link;if(!await e(u,s))return;let d=0;return await new Promise(e=>{const t=setInterval(async()=>{const a=await fetch(l.poll,{method:"GET"});if(!a.ok)return d+=1,d>10&&(clearInterval(t),e()),void console.log("ftar not ready");const s=await a.json();console.log("ftar ready",s),clearInterval(t),e(s)},5e3)})}(r,t,a,s,0,v,o);if(!i)return I("make ftar unexpected"),{error:C};if(i.error)return 401===i.error.status?{error:D}:{error:C};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return n&&(c=n),await F(t,i.id,c)},deleteFlexatar:S,flexatarEntry:F,userInfo:U,GetToken:L,ERR_UNAUTHORIZED:D,ERR_UNEXPECTED:C};if(void 0===se)var se=self;se.Ftar=ae;const ne=[{name:"head rot left right",multiplier:.3,isPositive:!1},{name:"head rot up down",multiplier:-.25,isPositive:!1},{name:"head move left right",multiplier:1,isPositive:!1},{name:"head move up down",multiplier:1,isPositive:!1},{name:"head scale",multiplier:.1,isPositive:!1},{name:"body tilt",multiplier:.2,isPositive:!1},{name:"head tilt",multiplier:1.3,isPositive:!1},{name:"eyes left right",multiplier:1,isPositive:!1},{name:"eyes up down",multiplier:-1,isPositive:!1},{name:"9 ?"},{name:"mouth smile",multiplier:1,isPositive:!0},{name:"brows up",multiplier:1,isPositive:!0},{name:"brows down",multiplier:1,isPositive:!0},{name:"lip up",multiplier:1,isPositive:!0},{name:"lip corner up down",multiplier:1,isPositive:!1},{name:"mouth open",multiplier:.3,isPositive:!0},{name:"lip shrink stretch",multiplier:1,isPositive:!1},{name:"lip tight",multiplier:.5,isPositive:!1}];function oe(e,t,a){lineOverlay.style.left=`${Math.trunc(100*t/a)}%`,e&&e.postMessage({animationPatternRequest:{position:{value:t}}})}function re(){console.log("[FTAR_ANIM_IFRAME]",...arguments)}const ie="position",ce="draw",le="smooth",ue="move";let de="draw";const ge={draw:{name:"âœï¸ DRAW",action:()=>{re("draw pressed"),de=ce}},clear:{name:"âœï¸ CLEAR",action:()=>{re("CLEAR pressed"),_e=new Array(Ie).fill(0),be(),Ee(ve,_e,0,Ie)}},clearAll:{name:"âœï¸ CLEAR ALL",action:async()=>{re("CLEAR pressed"),_e=new Array(Ie).fill(0),be(),Ee(ve,_e,0,Ie);const e=await Oe();for(let t=0;t<e.length;t++){const a=e[t];for(let e=0;e<a.length;e++)a[e]=0}}},smooth:{name:"ðŸ§¼ SMOOTH",action:()=>{re("smooth"),de=le}},move:{name:"MOVE",action:()=>{re("move"),de=ue}},position:{name:"Position",action:()=>{re("position"),de===ie?(de=null,qe.postMessage({animationPatternRequest:{playAnimation:!0}})):de=ie}},download:{name:"download",action:()=>{re("download"),async function(e="animation-patterns.json"){const t=await we,a=JSON.stringify(t),s=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=e,o.click(),URL.revokeObjectURL(n)}()}},upload:{name:"upload",action:()=>{re("upload"),async function(){const e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",e.addEventListener("change",t=>{const a=t.target.files[0];if(!a)return;const s=new FileReader;s.onload=async function(e){try{const t=JSON.parse(e.target.result),a=await we;for(const e of Object.keys(t))a[e]=t[e]}catch(e){console.error("Invalid JSON",e)}},s.readAsText(a),document.body.removeChild(e)}),document.body.appendChild(e),e.click()}()}}};let fe,me=!1,pe=[],he=0;const we=new Promise(e=>{fe=e});let ye;const Ie=300;let _e=new Array(Ie).fill(0);re("currentPattern",_e);let Re={};async function Ee(e,t,a,s,n="red"){Se(e,t,a,s,null,await Pe(a,s),"red")}async function Pe(e,t){const a=["green","blue","yellow"];let s=0;re(Re);const n=await Oe();let o=!0;for(const r of Object.keys(Re)){const i=n.map(e=>e[r]);re(i),Se(ve,i,e,t,r,o,a[s%a.length]),o=!1,s++}return o}function Se(e,t,a,s,n=null,o=!0,r="red"){const i=e.canvas.width,c=e.canvas.height,l=a*i/Ie,u=s*i/Ie-l;o&&e.clearRect(l,0,u,c),e.strokeStyle=r,e.lineWidth=1,e.beginPath();for(let o=a;o<=s;o++){const s=o*i/Ie,r=(t[o]/Te(n)+.5)*c;o===a?e.moveTo(s,r):e.lineTo(s,r)}e.stroke()}function Te(e=null){return-2*ne[e||he].multiplier}function Ae(e){return Math.trunc(e/ke.width*Ie)}const ke=document.getElementById("editableCanvas"),ve=ke.getContext("2d");let De=!1,Ce=0,Me=0;function Fe(){ke.width=ke.clientWidth,ke.height=ke.clientHeight,Ee(ve,_e,0,Ie)}function Ue(e){const t=ke.getBoundingClientRect();return[(e.clientX-t.left)*(ke.width/t.width),(e.clientY-t.top)*(ke.height/t.height)]}window.addEventListener("resize",Fe),Fe();const Le=[.2,.2,.2,.2,.2];let Ne,xe;async function Oe(){const e=await we;return ye||(ye=Object.keys(e)[0]),e[ye]}async function be(e){if(de!==ce&&de!==le&&de!==ue)return;let t=0;re("currentPattern length",_e.length);for(const e of _e)(await Oe())[t][he]=e,t++;if(!e)return;const a={};a[ye]=await Oe(),e.postMessage({animationPatternRequest:{selectedPattern:a}})}ke.addEventListener("mousedown",async e=>{if(De=!0,[Ce,Me]=Ue(e),Ne=Ce,xe=Me,de===ie)oe(qe,Ae(Ce),Ie);else if(de===le){const e=Ae(Ce);let t=e-20,a=e+20;t<0&&(t=0),a>=Ie&&(a=Ie-1),_e=function(e,t,a,s,n=3){const o=e.slice(t,a),r=s.length,i=Math.floor(r/2),c=Array(o.length);for(let e=0;e<o.length;e++){let t=0;for(let a=0;a<r;a++){let n=e+a-i;n<0&&(n=-n),n>=o.length&&(n=o.length-(n-o.length)-1),t+=o[n]*s[a]}c[e]=t}const l=e.slice();for(let a=0;a<c.length;a++){const s=t+a;let o=1;a<n?o=a/n:a>c.length-n-1&&(o=(c.length-1-a)/n),o<0&&(o=0),l[s]=c[a]*o+e[s]*(1-o)}return l}(_e,t,a,Le),Ee(ve,_e,t,a,"red"),be()}}),ke.addEventListener("mousemove",e=>{if(!De)return;const[t,a]=Ue(e);de===ce?((e,t,a,s,n)=>{const o=ne[he].isPositive;let r=t<s?[t,s]:[s,t],i=t<s?[a,n]:[n,a];r=r.map(Ae),i=i.map(e=>Te()*(e/ke.height-.5));const c=r[1]-r[0];if(0===c)i[0]<0&&o?_e[r[0]]=0:_e[r[0]]=i[0];else{const e=i[1]-i[0];for(let t=0;t<=c;t++){let a=t/c*e+i[0];o&&a<0&&(a=0),_e[t+r[0]]=a}}Ee(e,_e,r[0],r[1])})(ve,Ce,Me,t,a):de===ue||de===ie&&oe(qe,Ae(t),Ie),Ce=t,Me=a}),ke.addEventListener("mouseup",e=>{if(De=!1,de===ue){const[t,a]=Ue(e);((e,t,a,s,n)=>{ne[he].isPositive;let o=[t,s],r=[a,n];o=o.map(Ae),r=r.map(e=>Te()*(e/ke.height-.5));const i=o[1]-o[0],c=r[1]-r[0];_e=function(e,t){const a=e.length,s=(t%a+a)%a;return e.slice(-s).concat(e.slice(0,a-s))}(_e,-i),_e=_e.map(e=>e-c),Ee(e,_e,0,Ie)})(ve,Ce,Me,Ne,xe)}else de===ce&&Ee(ve,_e,0,Ie,"red");be(qe)}),ke.addEventListener("mouseleave",()=>{De=!1,be(qe)}),function(){const e=document.getElementById("buttonPanel");for(const t in ge){const a=ge[t],s=document.createElement("button");s.textContent=a.name,s.addEventListener("click",a.action),e.appendChild(s)}}();const Be=new ee;let Ge;Be.ready.then(async()=>{re("connection ready")});let qe,Qe,We=0;async function je(e){const t=e.data;if(t&&t.animationPatternResponse)if(t.animationPatternResponse.patternsDict){re("msg.animationPatternResponse.patternsDict",t.animationPatternResponse.patternsDict),fe(t.animationPatternResponse.patternsDict);const e=document.createElement("select");e.id="animationSlotSelect";const a=t.animationPatternResponse.patternsDict;Object.keys(a).forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}),e.addEventListener("change",async()=>{ye=e.value,qe.postMessage({animationPatternRequest:{changePattern:ye}}),console.log("Selected value:",e.value);const t=await Oe();_e=t.map(e=>e[he]),Ee(ve,_e,0,Ie,"red")}),recordPanel.appendChild(e);const s=await Oe();_e=s.map(e=>e[he]),Ee(ve,_e,0,Ie),function(e){const t=document.getElementById("featureListScrollableAtTheLeftFixedWidth");let a;t.innerHTML="",e.forEach(({name:e,action:s},n)=>{const o=document.createElement("div");o.className="feature-item",o.textContent=e,t.appendChild(o);const r=document.createElement("input");r.type="checkbox",r.addEventListener("change",()=>{console.log("Checkbox state:",r.checked),r.checked?Re[n]=!0:delete Re[n]}),o.appendChild(r),o.onclick=()=>{a&&a.classList.remove("selected"),a=o,o.classList.add("selected"),s()}})}(s[0].map((e,t)=>({name:ne[t].name,action:async()=>{he=t,_e=(await Oe()).map(e=>e[t]),Ee(ve,_e,0,Ie)}})))}else if(t.animationPatternResponse.headMotionState){const e=t.animationPatternResponse.headMotionState;if(e.pop(),me){Ge||(Ge=window.performance.now());const t=window.performance.now()-Ge,a=Math.floor(t/1e3*33);for(let t=We;t<a;t++)pe.length<Ie&&pe.push(e);We=a,pe.length>=Ie&&(me=!1,Ge=null,We=0,async function(e){const t=await we;ye||(ye=Object.keys(t)[0]),t[ye]=e}(pe).then(async()=>{_e=(await Oe()).map(e=>e[he]),Ee(ve,_e,0,Ie),be()})),oe(null,pe.length,Ie)}}}function Ke(){window.parent.postMessage({closeWindow:!0,portSelf:qe,instanceId:Qe},"*",[qe])}window.onmessage=e=>{const t=e.data;t&&(t.managerPort?(Qe=t.instanceId,t.managerPort.onmessage=je,re("port obtained"),qe=t.managerPort,t.managerPort.postMessage({managerConnectionPort:Be.outPort},[Be.outPort]),qe.postMessage({animationPatternRequest:{giveMePatterns:!0}})):t.closeThisWindow&&Ke())},closeButton.onclick=()=>{Ke()},enableRetartgButton.onclick=()=>{Be.showRetarg()},startRecordButton.onclick=()=>{re("startRecordButton"),me=!0,pe=[]}})();
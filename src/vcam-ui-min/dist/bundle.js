(()=>{"use strict";class e{static DROP_PHOTO="DROP PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START";static CANCELED="CANCELED";static SUBSCRIPTION_END="NO SUBSCRIPTION";static DROP_BACKGROUND="DROP BACK GROUND"}const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];function a(e,t){for(const a of t)if(e==a)return!0;return!1}function s(){console.log("[FTAR_QUEUE_STORAGE]",...arguments)}async function o(e){const{currentUserId:t}=e?{currentUserId:e}:await chrome.storage.local.get({currentUserId:null});return t||{error:"not_authorized"}}const r={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list"};async function n(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r].concat(t);return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function i(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=t;return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function c(e,t){const a=await o(t);if(a.error)return a;const s=a+e,r={};return r[s]=[],(await chrome.storage.local.get(r))[s]}async function l(e){s("clear list",e);const t=await o();if(t.error)return t;const a=t+e;await chrome.storage.local.remove([a]),s("clear list done",e)}async function d(e){const t=await o();if(t.error)return t;const a=t+e;s(a,(await chrome.storage.local.get([a]))[a])}async function u(){for(const[e,t]of Object.entries(r))d(t)}const g="_src_img_",f="_is_queue_in_progress_",w="_src_background_",m="_current_id_background_";async function p(e,t,a,r){const n=await o(r);if(n.error)return n;const i={};i[n+e+t]=a;try{return await chrome.storage.local.set(i),{success:!0}}catch(e){return s(e),{error:"unknown"}}}async function h(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e+t,n={};return n[r]=null,(await chrome.storage.local.get(n))[r]}async function y(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e+t;await chrome.storage.local.remove([r])}async function I(e,t,a,o="id"){const r=await c(e,a);let n=t[o];n||(n=t),s("queueList",r,e);const l=r.filter((e=>(e[o]||e)!==n));s("newList",l),await i(e,l,a)}async function k(e,t,a){let s=await c(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await y(g,t.id,a)}await i(e,s,a)}async function v(e,t,a,s){await I(e,a,s),await async function(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r],c=t.concat(i);return n[r]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],s)}function _(){console.log("[FTAR_CONNECTION]",...arguments)}const L="ftarcache";async function T(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function E(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const B="https://api.flexatar-sdk.com";async function R(e,t){const a=B+"/"+e.id;t||(t=e.token);const s={};try{const e=await b(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:F}:{error:S}}catch(e){return console.error("Flexatar deletion:",e),!1}}async function C(e,t,a){if("default"===t.id)return await(await fetch(chrome.runtime.getURL("sandbox/default_ftar.p"))).arrayBuffer();const s=a+"_ftar_"+t.id,o=(await chrome.storage.local.get([s]))[s];if(o)return await(await fetch(o)).arrayBuffer();let r;if(t.ftar)r=await fetch(t.ftar,{method:"GET"});else{const a=await x(e,t.id,{ftar:!0});r=await fetch(a.ftar,{method:"GET"})}if(!r.ok)return;const n=await r.arrayBuffer(),i=await D(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function D(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function P(e,t,a,s=0){const o=a+"_ftarpreview_"+e.id,r=(await chrome.storage.local.get([o]))[o];if(r)return await(await fetch(r)).arrayBuffer();if(!e.preview&&s<5)return await new Promise((e=>setTimeout(e,500))),await P(e,t,a,s+1);let n=await fetch(e.preview,{method:"GET"});if(!n.ok)return;const i=await n.arrayBuffer(),c=await D(i),l={};return l[o]=c,await chrome.storage.local.set(l),i}async function b(e,t,a,s){t.headers.Authorization="Bearer "+await a.getToken();const o=await fetch(e,t);return 403!=o.status?o:(s||(s=2),s<=0?o:(s-=1,a.token=null,await b(e,t,a,s)))}const F="unauthorized",S="UNEXPECTED";async function U(e,t){const a=B+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const o=await b(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);return o.ok?(await o.json()).all:401===o.status?{error:F}:{error:S}}async function x(e,t,a){const s=B+"/list",o={"Content-Type":"application/json"},r=[];a.ftar&&r.push("ftar"),a.preview&&r.push("preview"),a.meta&&r.push("meta");const n={};n[t]=r;try{const a=await b(s,{method:"POST",headers:o,body:JSON.stringify(n)},e);return a.ok?(await a.json()).requested[t]:401===a.status?{error:F}:{error:S}}catch(e){console.error("Flexatar list failed:",e)}}async function O(e,t,a,s,o){a||(a="");const r=B+"/make",n=await async function(e,t,a,s,o,r,n){const i=await r(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},t);if(!i.ok)return console.log("faild obtain make link",await i.json()),{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const l=c.link;if(!await async function(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),(await fetch(e.url,{method:"POST",body:a})).ok?(console.log("ftar send img ok"),!0):(console.error("send img failed"),!1)}(l,a))return;let d=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return d+=1,d>10&&(clearInterval(t),e()),void console.log("ftar not ready");const s=await a.json();console.log("ftar ready",s),clearInterval(t),e(s)}),5e3)}))}(r,e,t,a,0,b,o);if(n.error)return 401===n.error.status?{error:F}:{error:S};if(!n.success){let e=n.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let i={ftar:!0,meta:!0};return s&&(i=s),await x(e,n.id,i)}async function A(e){_("requesting user info from cloud");const t=await b(B+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);return t.ok||t.ok?await t.json():401===t.status?{error:F}:{error:S}}class M{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,t}}async function N(e,t){const a=await async function(e){const t=await new Promise((e=>{chrome.storage.local.get(null,e)}));return Object.keys(t).filter((t=>t.startsWith(e)))}(e),s={};for(const t of a)s[t.replaceAll(e,"")]=t;for(const{id:e}of t)delete s[e];const o=Object.values(s);_("deleting removed res from storage",o),o.length>0&&await chrome.storage.local.remove(o)}async function j(e,t,a){const s=a+"_ftarlist";let o=t.opts.noCache?null:await E(s);if(t.opts.noCache=void 0,!o){if(_("loading list from cloud",t.opts),o=await U(e,t.opts),o&&o.error)return o;if(o){o=o.reverse(),_("ftarList",o),(async()=>{if(t.opts.preview)for(const t of o){const s=await P(t,e,a);console.log("previewBuffer",s),delete t.preview}})(),_("removing keys not in list");const r=a+"_ftarpreview_";await N(r,o),_("removing keys not in list");const n=a+"_ftar_";await N(n,o),_("removing keys end"),await T(s,o)}else o=[]}return o}async function G(e){await H(e,await Q(e)-1)}async function Q(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function H(e,t){const a=e+"_FtarCount",s={};s[a]=t,_("setting ftar count at key",a,"count is",t),await chrome.storage.local.set(s)}async function W(e,t){const a=await c(r.FTAR_MAKE_QUEUE_LIST_ID);if("not_authorized"===a.error)return{error:a.error};_("ftarListToMake",a);const s=await h(f,"");return a.length>0&&s?(t(await async function(e,t){_("make ftar with id",t);const a=await o(),s=await h(g,t.id,a);if(_({imageDataUrl:s}),_({currentUserId:a}),s){const o=function(e){const[t,a]=e.split(","),s=t.match(/:(.*?);/),o=s?s[1]:"application/octet-stream",r=atob(a),n=Uint8Array.from(r,(e=>e.charCodeAt(0)));return new File([n],void 0,{type:o})}(s),n=await O(e,o,"noname",{ftar:!0,preview:!0},(async e=>{_("obtained ftar id"),t.ftarId=e,_("obtained ftar id",e,"move to processing",await v(r.FTAR_MAKE_QUEUE_LIST_ID,r.FTAR_PROCESSING_QUEUE_LIST_ID,t,a)),u()}));if(n.error||n.err){if("bad_photo"!==n.reason)return await p(f,"",!1),n;await v(r.FTAR_PROCESSING_QUEUE_LIST_ID,r.FTAR_ERROR_LIST_ID,t,a),await k(r.FTAR_ERROR_LIST_ID,5)}else{await v(r.FTAR_PROCESSING_QUEUE_LIST_ID,r.FTAR_SUCCESS_LIST_ID,t,a),await k(r.FTAR_SUCCESS_LIST_ID,5);try{await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await E(a);s.unshift({id:t}),await T(a,s)}(a,n.id),await P(n,e,a),await C(e,n,a)}catch{_("fail download after creation")}}return u(),_("flexatar ready",n),n}await p(f,"",!1)}(e,a[0])),await W(e,t)):(p(f,"",!1),{})}async function q(){const e={successImages:r.FTAR_SUCCESS_LIST_ID,errorImages:r.FTAR_ERROR_LIST_ID,queueImages:r.FTAR_MAKE_QUEUE_LIST_ID},t={};for(const[a,s]of Object.entries(e)){const e=(await c(s)).map((async e=>await h(g,e.id)));t[a]=await Promise.all(e)}const a=(await c(r.FTAR_PROCESSING_QUEUE_LIST_ID)).map((async e=>await h(g,e.id))),s=await Promise.all(a);s&&s.length>0&&t.queueImages.unshift(s[0]),_("progressLists",t);const n=await o();return _("getting ftar count to progress userId",n),t.flexatarCount=await Q(n),t.isQueueInProgress=await h(f,""),t}const K=new class{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}};let Y=0;function z(e,t){const a=X();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(o){o.data&&(console.log("responese",o.data),o.data.msgID===a&&(s(o.data.payload),e.removeEventListener("message",t)))})),e.postMessage(t)}))}class J{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=X();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(o){o.data&&(console.log("responese",o.data),o.data.msgID===t&&(s(o.data.payload),a.removeEventListener("message",e)))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e){return await this.sendWithResponse({flexatar:e})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>s({buffer:r.result,fileType:t,fileName:a}),r.onerror=e=>o(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async getToken(){return await this.sendWithResponse({getUserToken:!0})}}function X(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const Z={Manager:class{constructor(e,t=!1,a=!1){let s;a||(s=async function(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===e)var e=self;"undefined"==typeof chrome&&(e.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const t="flexatar-storage-cache",a=e=>new Request(`https://flexatar-mock-storage/${e}`),s=e=>new URL(e).pathname.slice(1),o=await caches.open(t);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const s=JSON.stringify({value:t}),r=new Response(s,{headers:{"Content-Type":"application/json"}});await o.put(a(e),r)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const r={};if(null==e){const e=(await o.keys()).map((e=>s(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const s=await o.match(a(t));if(s){const e=await s.json();r[t]=e.value}else r[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(r),r},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>o.delete(a(e))));console.log("start del keys"),await Promise.all(t),console.log("end del keys")}}}()),this.tokenFn=e,this.token=new M((async()=>await e())),t&&s.then((()=>{[r.FTAR_ERROR_LIST_ID,r.FTAR_SUCCESS_LIST_ID,r.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((e=>{l(e)})),p(f,"",!1)}))}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const s=a.data;if(s)if(s.progressLists){_("request progress list"),s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await q();e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await p(f,"",!1);else if(s.clearMakeQueue){await l(r.FTAR_MAKE_QUEUE_LIST_ID);const t=await q();e.postMessage({progressLists:t})}else s.startMakeQueue&&(await p(f,"",!0),t.ftarQueueDelegate(t.token,(async a=>{a.err||a.error||await G(await o()),t.ports.forEach((e=>{e.postMessage({newFlexatar:a})}));const s=await q();e.postMessage({progressLists:s})})))}}async getUserInfo(e){const t=e&&e.noCache,{currentUserId:a}=await chrome.storage.local.get({currentUserId:null});if(a&&!t){const e=a+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:a,FtarCount:t}}const s=await A(this.token);if(s.error)return s;const o=s.user_id;return await chrome.storage.local.set({currentUserId:o}),await H(o,s.FtarCount),s}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{console.log("manager port not responding"),this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),console.log("manager port ok"),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){this.lensPorts.forEach((async t=>{await z(t,{managerPort:!0}),_("lens port connected and answered"),t.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=W;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const s=a.data;if(s)if(s.imagesList){const e=s.imagesList;_("imagesList",e);const a=e.map((e=>({id:e.id})));await n(r.FTAR_MAKE_QUEUE_LIST_ID,a);for(const{dataUrl:t,id:a}of e)_("FTAR_SRC_IMG saved",await p(g,a,t));await h(f,"")||(await p(f,"",!0),t.ftarQueueDelegate(t.token,(async e=>{e.err&&!e.error||await G(await o()),t.ports.forEach((t=>{t.postMessage({newFlexatar:e})})),t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await q()})}))}))),t.showProgress()}else s.closing&&(t.lensPorts=t.lensPorts.filter((t=>t!==e)),console.log("lens port count",t.lensPorts.length))}}addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const o=a.data;if(!o)return;console.log("msg on manager port:",o);const i=await K.enqueue((async()=>(Y++,console.log("userInfo counter",Y),await t.getUserInfo())));if(i.error)return void e.postMessage({msgID:o.msgID,payload:i});const l=i.user_id;if(o.ftarList){const t=await j(this.token,o,l);_("sending list response",t),e.postMessage({msgID:o.msgID,payload:t})}else if(o.backgroundsList){const t=o.opts??{};let a;a=t.id?[t.id]:await c(r.FTAR_BACKGROUND_LIST_ID,l);const s=[];for(const e of a){const t=await h(w,e,l);s.push([e,t])}e.postMessage({msgID:o.msgID,payload:s})}else if(o.preview){const a=await P({id:o.preview},t.token,l);if(!a)return void e.postMessage({msgID:o.msgID,payload:null});console.log("previewBuffer",a),e.postMessage({msgID:o.msgID,payload:a},[a])}else if(o.flexatar){const t=await C(this.token,{id:o.flexatar},l);if(_("ftar buffer ",t),!t)return void e.postMessage({msgID:o.msgID,payload:null});_("setting current ftar id ",o.flexatar),await async function(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}(o.flexatar,l),e.postMessage({msgID:o.msgID,payload:t},[t])}else if(o.closing)t.ports=t.ports.filter((t=>t!==e)),e.close(),console.log("closing port on ftar manager",t.ports.length);else if(o.storeNewBackground){const t=await function(e,t){return new Promise((a=>{const o=crypto.randomUUID();c(r.FTAR_BACKGROUND_LIST_ID,t).then((i=>{s("background list",i),n(r.FTAR_BACKGROUND_LIST_ID,[o],t).then((r=>{s("add to list",r),p(w,o,e,t).then((e=>{s("BACKGROUND_SRC_IMG saved",e),a(o)}))}))}))}))}(o.storeNewBackground,l);e.postMessage({msgID:o.msgID,payload:t}),e.postMessage({newBackGround:t})}else if(o.getCurrentBkg){let t=await h(m,"",l);if(!t){const e=await c(r.FTAR_BACKGROUND_LIST_ID,l);t=e[e.length-1]}t&&o.getCurrentBkg.dataUrl&&(t="no"===t?null:await h(w,t,l)),e.postMessage({msgID:o.msgID,payload:t})}else if(o.deleteBackground)I(r.FTAR_BACKGROUND_LIST_ID,o.deleteBackground,l),y(w,o.deleteBackground,l),e.postMessage({msgID:o.msgID,payload:{result:"success"}});else if(o.setCurrentBkg)p(m,"",o.setCurrentBkg,l),e.postMessage({msgID:o.msgID,payload:{result:"success"}});else if(o.currentFtar){o.opts={preview:!0};const t=await j(this.token,o,l);_("get current ftar, list",t);const a=await async function(e,t){const a=e+"_currentFlexatarId";let s=(await chrome.storage.local.get([a]))[a];if(0===t.length)return null;for(const{id:e}of t)if(e===s)return _("returning founded id",e),s;const o={},r=t[0].id;return o[a]=r,await chrome.storage.local.set(o),r}(l,t);_("get current ftar, id",a),e.postMessage({msgID:o.msgID,payload:{id:a}})}else if(o.makeFlexatar)_("photo obtained"),this.lensPorts.forEach((async e=>{await z(e,{managerPort:!0}),_("lens port connected and answered"),e.postMessage({imageBuffer:o.buffer},[o.buffer])})),e.postMessage({msgID:o.msgID,payload:{status:"ok"}});else if(o.deleteFlexatar){const t=await R({id:o.deleteFlexatar,token:this.token});t&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.get([a,s])}(o.deleteFlexatar,l),await async function(e,t){const a=e+"_ftarlist";let s=await E(a);s=s.filter((({id:e})=>t!==e)),await T(a,s)}(l,o.deleteFlexatar),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(l)),e.postMessage({msgID:o.msgID,payload:{success:t}})}else if(o.userInfo)o.opts?e.postMessage({msgID:o.msgID,payload:await t.getUserInfo(o.opts)}):e.postMessage({msgID:o.msgID,payload:i});else if(o.decrementFtarCount)await H(l,i.FtarCount-1),e.postMessage({msgID:o.msgID,payload:{success:!0}});else if(o.showProgress)t.showProgress();else if(o.getUserToken){const a=await t.tokenFn();e.postMessage({msgID:o.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){_("newBackgroundCreated",e),this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}},ManagerConnection:J,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(L);let o=await s.match(a);if(!o){const r=await x(e,t.id,{ftar:!0});if(o=await fetch(r.ftar,{method:"GET"}),!o.ok)return;const n=await o.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await o.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(L);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const o=await s.arrayBuffer(),r=new Response(new Uint8Array(o),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,r),o}return await s.arrayBuffer()},flexatarList:U,makeFlexatar:O,deleteFlexatar:R,flexatarEntry:x,userInfo:A,GetToken:M,ERR_UNAUTHORIZED:F,ERR_UNEXPECTED:S};if(void 0===$)var $=self;$.Ftar=Z;const V=J;function ee(){console.log("[FTAR_UI]",...arguments)}console.log("poast getFtarPreview");const te=new V;let ae;function se(){reloadIcon.classList.remove("roating"),plusCircle.classList.add("rotated"),makeTextHolder.textContent=e.SUBSCRIPTION_END}window.parent.postMessage({ftarUIPort:te.outPort},"*",[te.outPort]),new Promise((e=>{window.addEventListener("message",(t=>{t.data&&t.data.flexatarControllerPort?(ee("ftar ui flexatarControllerPort",t.data.flexatarControllerPort),ae=t.data.flexatarControllerPort,e(ae)):t.data&&t.data.closing&&(console.log("iframe controller port close"),ae&&(ae.postMessage({closing:!0}),ae.close(),ae=null),te.close())}))})),confirmButton.onclick=async()=>{confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,Be?noBackgroundButton!==Te&&(await te.deleteBackground(Te.id),Te&&Te.remove(),imageBackgroundContainer.firstElementChild?.click()):await async function(e){return(await te.deleteFlexatar(e)).success}(le.ftarId)&&(le.element.remove(),previewListHolder.children.length>0?previewListHolder.children[0]?.click():(emptyBlock.textContent=e.EMPTY,le.ftarId=null)),trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),ue=!ue},reloadFtarListButton.onclick=async()=>{for(reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");previewListHolder.children.length>0;)previewListHolder.children[0]?.remove();const t=await te.getCurrentFtar();if(t){le={ftarId:t.id};const e=await te.getList({preview:!0,noCache:!0});if(e.error)return void se();for(const{id:t}of e){const e=await te.getPreview(t),a=new Blob([e],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:o}=await de({id:t},s)}}else emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1},trashButton.onclick=()=>{ue?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),ue=!ue},reloadIcon.classList.add("roating"),te.onNewFlexatar=async e=>{if(ee("new flexatar",e),e.error)return;const t=await te.getPreview(e.id),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:o}=await de({id:e.id},s,!0)},te.ready.then((async()=>{const t=await te.getCurrentFtar();if(t.error)se();else{if(ee("page ready, current ftar is",t),t){le={ftarId:t.id};const e=await te.getList({preview:!0});if(ee("ftar list:",e),e.error)return void se();for(const{id:t}of e){const e=await te.getPreview(t),a=new Blob([e],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:o}=await de({id:t},s)}}else ee("setting empt block"),emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating")}})),window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=e.ALLOW_AUDIO;const oe=window.location.search;let re;function ne(e,t){const a=document.createElement("input");re=document.createElement("form"),re.appendChild(a),a.type="file",a.accept="image/*",a.onchange=e=>t(e),e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),ee("on drop",a.dataTransfer),e.classList.remove("hover");const s=a.dataTransfer.files;t({target:{files:s}})}}new URLSearchParams(oe),function(){const s=createFlexatarHolder,o=plusCircle,r=makeTextHolder;r.textContent=e.DROP_PHOTO;const n=makeOverlayElement;let i;ne(s,(async s=>{ee("photo obtained"),i&&(i(),i=null);const c=(o.style.display="none",r.style.display="none",n.style.display="block",()=>{o.style.display="block",r.style.display="block",n.style.display="none"});let l=s.target.files[0];if(!a(l.type,t))return d=e.NOT_PHOTO,o.classList.add("rotated"),r.textContent=d,i=()=>{o.classList.remove("rotated"),r.textContent=e.DROP_PHOTO},void c();var d;const u=await async function(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>s({buffer:r.result,fileType:t,fileName:a}),r.onerror=e=>o(e)}))}(e);return t.makeFtar=!0,await te.makeFlexatar(e)}(l);c(),re.reset(),ee("ftarLink",u)}))}();const ie={};let ce,le;async function de(e,t,a){ie[e.id]=e;const s=t,o=document.createElement("span");o.className="item-holder";const r=document.createElement("img");r.src=s,r.draggable=!1,r.style.cursor="pointer",r.style.display="block",r.style.width="100%",r.style.height="auto",r.style.margin="0px",r.style.padding="0px",r.style.boxSizing="border-box",r.style.lineHeight="0px",r.style.verticalAlign="top",r.style.objectFit="contain",o.appendChild(r),console.log("appending preview image"),o.id=e.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(o,previewListHolder.firstChild):previewListHolder.appendChild(o),o.onclick=async()=>{if(ce&&ce.classList.remove("selected-item"),ce=o,o.classList.add("selected-item"),le.ftarId===e.id)return;le={element:o,ftarId:e.id},o.appendChild(n);const t=await te.getFlexatar(e.id);console.log("ftarBuffer",t),ae&&ae.postMessage({slot1:t,id:e.id},[t]),n.remove()},console.log("selecteFtar",le,e.id),le&&le.ftarId===e.id&&(le.element=o,o.click()),{holder:o,previewImg:s}}trashButton.classList.remove("invisible");let ue=!1;reloadFtarListButton.classList.remove("invisible");let ge,fe,we,me=!1;document.addEventListener("mousedown",(e=>{he&&clearInterval(he),me=!0,ge=e.screenY,fe=window.scrollY}));let pe,he,ye=0,Ie=0,ke=0,ve=!1;function _e(){if(me=!1,ye=0,we&&clearInterval(we),document.body.style.pointerEvents="auto",!ve)return;ve=!1,fe=window.scrollY,Ie=.5*ke,he=setInterval((()=>{fe+=Ie,window.scrollTo(0,fe),Ie*=.9,Math.abs(Ie)<1&&clearInterval(he)}),50);const e=he;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{me&&(e.preventDefault(),pe=ge-e.screenY,!ve&&Math.abs(pe)<10||(ve||(ke=0,we=setInterval((()=>{Ie=pe-ye,ye=pe,ke=.5*(ke+Ie)}),100)),ve=!0,document.body.style.pointerEvents="none",window.scrollTo(0,fe+pe)))})),document.addEventListener("mouseup",_e),document.addEventListener("mouseleave",_e),expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")};const Le=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let Te,Ee=AllEmo;Ee.classList.add("color-emo-selected");for(const e of Le)e.onclick=()=>{Ee.classList.remove("color-emo-selected"),Ee=e,Ee.classList.add("color-emo-selected"),ae&&ae.postMessage({animation:{pattern:e.id}})};AllEmo.onclick=()=>{Ee.classList.remove("color-emo-selected"),Ee=AllEmo,Ee.classList.add("color-emo-selected"),ae&&ae.postMessage({animation:{pattern:null}})};let Be=!1;function Re(e,t,a=!1){const s=document.createElement("img");return s.id=e,s.src=t,s.draggable=!1,s.style.cursor="pointer",s.style.display="block",s.style.width="100%",s.style.height="auto",s.style.margin="0px",s.style.padding="0px",s.style.boxSizing="border-box",s.style.lineHeight="0px",s.style.verticalAlign="top",s.style.objectFit="contain",a?(o=s,(r=noBackgroundButton).nextSibling?r.parentNode.insertBefore(o,r.nextSibling):r.parentNode.appendChild(o)):imageBackgroundContainer.appendChild(s),s.onclick=()=>{Te&&Te.classList.remove("selected-item"),Te=s,s.classList.add("selected-item"),ae&&ae.postMessage({background:t}),te.setCurrentBackground(e)},s;var o,r}expandBkgButton.onclick=async()=>{if(Be)expandBkgButton.classList.add("rot180"),dropBackgroundContainer.classList.add("invisible"),imageBackgroundContainer.querySelectorAll("img").forEach((e=>e.remove())),bkgExpander.classList.remove("full-height");else{expandBkgButton.classList.remove("rot180"),dropBackgroundContainer.classList.remove("invisible"),dropBackgroundText.textContent=e.DROP_BACKGROUND,bkgExpander.classList.add("full-height");const t=(await te.getBackgrounds()).reverse();for(const[e,a]of t)a&&Re(e,a);const a=await te.getCurrentBackground();document.getElementById(a)?document.getElementById(a)?.click():noBackgroundButton.click()}Be=!Be},noBackgroundButton.onclick=()=>{noBackgroundButton.classList.add("selected-item"),Te&&Te.classList.remove("selected-item"),Te=noBackgroundButton,ae&&ae.postMessage({background:!0,no:!0}),te.setCurrentBackground("no")},ne(dropBkgElement,(async e=>{let s=e.target.files[0];if(!a(s.type,t))return;const o=await async function(e,t,a){const s=await createImageBitmap(e),o=new OffscreenCanvas(t,a),r=o.getContext("2d");let n,i,c,l;s.width/s.height>.75?(i=a,n=s.width*(a/s.height),c=-(n-t)/2,l=0):(n=t,i=s.height*(t/s.width),c=0,l=-(i-a)/2),r.drawImage(s,c,l,n,i);const d=await o.convertToBlob();return await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(d)}))}(s,480,640);await te.storeNewBackground(o),ee("photo bkg obtained",s)})),te.onNewBackground=async e=>{ee("new background event",e),Re(e,(await te.getBackgrounds({id:e}))[0][1],!0).click()},ftarLogButton.onclick=e=>{te.showProgress(),ee("show creation log")}})();
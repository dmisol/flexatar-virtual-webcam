(()=>{"use strict";class e{static DROP_PHOTO="DROP PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START";static CANCELED="CANCELED";static SUBSCRIPTION_END="NO SUBSCRIPTION";static DROP_BACKGROUND="DROP BACK GROUND"}const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];function a(e,t){for(const a of t)if(e==a)return!0;return!1}async function s(e,t,a,s,r,o,n){const i=await o(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},t);if(!i.ok)return{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const l=c.link;if(!await async function(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),!!(await fetch(e.url,{method:"POST",body:a})).ok}(l,a))return;let u=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return u+=1,void(u>10&&(clearInterval(t),e()));const s=await a.json();clearInterval(t),e(s)}),5e3)}))}async function r(e){const{currentUserId:t}=e?{currentUserId:e}:await chrome.storage.local.get({currentUserId:null});return t||{error:"not_authorized"}}const o={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list"};async function n(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o].concat(t);return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function i(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=t;return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function c(e,t){const a=await r(t);if(a.error)return a;const s=a+e,o={};o[s]=[];return(await chrome.storage.local.get(o))[s]}async function l(e){const t=await r();if(t.error)return t;const a=t+e;await chrome.storage.local.remove([a])}async function u(e){const t=await r();if(t.error)return t;const a=t+e;(await chrome.storage.local.get([a]))[a]}async function d(){for(const[e,t]of Object.entries(o))u(t)}const g="_src_img_",f="_is_queue_in_progress_",w="_src_background_",m="_current_id_background_";async function p(e,t,a,s){const o=await r(s);if(o.error)return o;const n={};n[o+e+t]=a;try{return await chrome.storage.local.set(n),{success:!0}}catch(e){return{error:"unknown"}}}async function h(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e+t,n={};n[o]=null;return(await chrome.storage.local.get(n))[o]}async function y(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e+t;await chrome.storage.local.remove([o])}async function I(e,t,a,s="id"){const r=await c(e,a);let o=t[s];o||(o=t);const n=r.filter((e=>(e[s]||e)!==o));await i(e,n,a)}async function _(e,t,a){let s=await c(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await y(g,t.id,a)}await i(e,s,a)}async function k(e,t,a,s){await I(e,a,s),await async function(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.concat(i);return n[o]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],s)}const v="ftarcache";async function L(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function T(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const E="https://api.flexatar-sdk.com";async function B(e,t){const a=E+"/"+e.id;t||(t=e.token);const s={};try{const e=await P(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:b}:{error:F}}catch(e){return!1}}async function D(e,t,a){if("default"===t.id)return await(await fetch(chrome.runtime.getURL("sandbox/default_ftar.p"))).arrayBuffer();const s=a+"_ftar_"+t.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();let o;if(t.ftar)o=await fetch(t.ftar,{method:"GET"});else{const a=await U(e,t.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const n=await o.arrayBuffer(),i=await R(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function R(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function C(e,t,a,s=0){const r=a+"_ftarpreview_"+e.id,o=(await chrome.storage.local.get([r]))[r];if(o)return await(await fetch(o)).arrayBuffer();if(!e.preview&&s<5)return await new Promise((e=>setTimeout(e,500))),await C(e,t,a,s+1);let n=await fetch(e.preview,{method:"GET"});if(!n.ok)return;const i=await n.arrayBuffer(),c=await R(i),l={};return l[r]=c,await chrome.storage.local.set(l),i}async function P(e,t,a,s){t.headers.Authorization="Bearer "+await a.getToken();const r=await fetch(e,t);return 403!=r.status?r:(s||(s=2),s<=0?r:(s-=1,a.token=null,await P(e,t,a,s)))}const b="unauthorized",F="UNEXPECTED";async function S(e,t){const a=E+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const r=await P(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);if(!r.ok)return 401===r.status?{error:b}:{error:F};return(await r.json()).all}async function U(e,t,a){const s=E+"/list",r={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const n={};n[t]=o;try{const a=await P(s,{method:"POST",headers:r,body:JSON.stringify(n)},e);if(!a.ok)return 401===a.status?{error:b}:{error:F};return(await a.json()).requested[t]}catch(e){}}async function A(e,t,a,r,o){a||(a="");const n=E+"/make",i=await s(n,e,t,a,0,P,o);if(!i)return{error:F};if(i.error)return 401===i.error.status?{error:b}:{error:F};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return r&&(c=r),await U(e,i.id,c)}async function O(e){const t=await P(E+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);if(!t.ok&&!t.ok)return 401===t.status?{error:b}:{error:F};return await t.json()}class x{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,t}}async function M(e,t){const a=await async function(e){const t=await new Promise((e=>{chrome.storage.local.get(null,e)}));return Object.keys(t).filter((t=>t.startsWith(e)))}(e),s={};for(const t of a){s[t.replaceAll(e,"")]=t}for(const{id:e}of t)delete s[e];const r=Object.values(s);r.length>0&&await chrome.storage.local.remove(r)}async function N(e,t,a){const s=a+"_ftarlist";let r=t.opts.noCache?null:await T(s);if(t.opts.noCache=void 0,!r){if(t.opts,r=await S(e,t.opts),r&&r.error)return r;if(r){r=r.reverse(),(async()=>{if(t.opts.preview)for(const t of r){await C(t,e,a);delete t.preview}})();const o=a+"_ftarpreview_";await M(o,r);const n=a+"_ftar_";await M(n,r),await L(s,r)}else r=[]}return r}async function j(e){await Q(e,await G(e)-1)}async function G(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function Q(e,t){const a=e+"_FtarCount",s={};s[a]=t,await chrome.storage.local.set(s)}async function H(e,t){const a=await r(),s=await h(g,t.id,a);if(s){const r=function(e,t){const[a,s]=e.split(","),r=a.match(/:(.*?);/),o=r?r[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:o})}(s),n=await A(e,r,"noname",{ftar:!0,preview:!0},(async e=>{t.ftarId=e;await k(o.FTAR_MAKE_QUEUE_LIST_ID,o.FTAR_PROCESSING_QUEUE_LIST_ID,t,a);d()}));if(n.error||n.err){if(await k(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_ERROR_LIST_ID,t,a),await _(o.FTAR_ERROR_LIST_ID,5),"bad_photo"!==n.reason)return await p(f,"",!1),n}else{await k(o.FTAR_PROCESSING_QUEUE_LIST_ID,o.FTAR_SUCCESS_LIST_ID,t,a),await _(o.FTAR_SUCCESS_LIST_ID,5);try{await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await T(a);s.unshift({id:t}),await L(a,s)}(a,n.id),await C(n,e,a),await D(e,n,a)}catch{}}return d(),n}await p(f,"",!1)}async function W(e,t){const a=await c(o.FTAR_MAKE_QUEUE_LIST_ID);if("not_authorized"===a.error)return{error:a.error};const s=await h(f,"");if(a.length>0&&s){return t(await H(e,a[0])),await W(e,t)}return p(f,"",!1),{}}async function q(){const e={successImages:o.FTAR_SUCCESS_LIST_ID,errorImages:o.FTAR_ERROR_LIST_ID,queueImages:o.FTAR_MAKE_QUEUE_LIST_ID},t={};for(const[a,s]of Object.entries(e)){const e=(await c(s)).map((async e=>await h(g,e.id)));t[a]=await Promise.all(e)}const a=(await c(o.FTAR_PROCESSING_QUEUE_LIST_ID)).map((async e=>await h(g,e.id))),s=await Promise.all(a);s&&s.length>0&&t.queueImages.unshift(s[0]);const n=await r();return t.flexatarCount=await G(n),t.isQueueInProgress=await h(f,""),t}const K=new class{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}};class z{constructor(e,t=!1,a=!1){let s;a||(s=async function(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===e)var e=self;"undefined"==typeof chrome&&(e.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const t="flexatar-storage-cache",a=e=>new Request(`https://flexatar-mock-storage/${e}`),s=e=>new URL(e).pathname.slice(1),r=await caches.open(t);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const s=JSON.stringify({value:t}),o=new Response(s,{headers:{"Content-Type":"application/json"}});await r.put(a(e),o)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const o={};if(null==e){const e=(await r.keys()).map((e=>s(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const s=await r.match(a(t));if(s){const e=await s.json();o[t]=e.value}else o[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(o),o},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>r.delete(a(e))));await Promise.all(t)}}}()),this.tokenFn=e,this.token=new x((async()=>await e())),t&&s.then((()=>{[o.FTAR_ERROR_LIST_ID,o.FTAR_SUCCESS_LIST_ID,o.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((e=>{l(e)})),p(f,"",!1)}))}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{await K.enqueue((async()=>await t.getUserInfo()));const s=a.data;if(s)if(s.progressLists){s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await q();e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await p(f,"",!1);else if(s.clearMakeQueue){await l(o.FTAR_MAKE_QUEUE_LIST_ID),await l(o.FTAR_PROCESSING_QUEUE_LIST_ID);const t=await q();e.postMessage({progressLists:t})}else s.startMakeQueue&&(await p(f,"",!0),t.ftarQueueDelegate(t.token,(async a=>{a.err||a.error||await j(await r()),t.ports.forEach((e=>{e.postMessage({newFlexatar:a})}));const s=await q();e.postMessage({progressLists:s})})))}}async getUserInfo(e){const t=e&&e.noCache,{currentUserId:a}=await chrome.storage.local.get({currentUserId:null});if(a&&!t){const e=a+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:a,FtarCount:t}}const s=await O(this.token);if(s.error)return s;const r=s.user_id;return await chrome.storage.local.set({currentUserId:r}),await Q(r,s.FtarCount),s}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await K.enqueue((async()=>await t.getUserInfo()));await Y(a,{managerPort:!0}),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=W;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const s=a.data;if(s)if(await K.enqueue((async()=>await t.getUserInfo())),s.imagesList){const e=s.imagesList,a=e.map((e=>({id:e.id})));await n(o.FTAR_MAKE_QUEUE_LIST_ID,a);for(const{dataUrl:t,id:a}of e){await p(g,a,t)}await h(f,"")||(await p(f,"",!0),t.ftarQueueDelegate(t.token,(async e=>{e.err&&!e.error||await j(await r()),t.ports.forEach((t=>{t.postMessage({newFlexatar:e})})),t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await q()})}))}))),t.showProgress()}else s.needAuthorize?t.onNeedAuthorize():s.closing&&(t.lensPorts=t.lensPorts.filter((t=>t!==e)))}}onNeedAuthorize=()=>{};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const r=await K.enqueue((async()=>await t.getUserInfo()));if(r.error)return void e.postMessage({msgID:s.msgID,payload:r});const i=r.user_id;if(s.ftarList){const t=await N(this.token,s,i);e.postMessage({msgID:s.msgID,payload:t})}else if(s.backgroundsList){const t=s.opts??{};let a;a=t.id?[t.id]:await c(o.FTAR_BACKGROUND_LIST_ID,i);const r=[];for(const e of a){const t=await h(w,e,i);r.push([e,t])}e.postMessage({msgID:s.msgID,payload:r})}else if(s.preview){const a=await C({id:s.preview},t.token,i);if(!a)return void e.postMessage({msgID:s.msgID,payload:null});e.postMessage({msgID:s.msgID,payload:a},[a])}else if(s.flexatar){const t=await D(this.token,{id:s.flexatar},i);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});s.flexatar,await async function(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}(s.flexatar,i),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.closing)t.ports=t.ports.filter((t=>t!==e)),e.close();else if(s.storeNewBackground){const t=await function(e,t){return new Promise((a=>{const s=crypto.randomUUID();c(o.FTAR_BACKGROUND_LIST_ID,t).then((r=>{n(o.FTAR_BACKGROUND_LIST_ID,[s],t).then((r=>{p(w,s,e,t).then((e=>{a(s)}))}))}))}))}(s.storeNewBackground,i);e.postMessage({msgID:s.msgID,payload:t}),e.postMessage({newBackGround:t})}else if(s.getCurrentBkg){let t=await h(m,"",i);if(!t){const e=await c(o.FTAR_BACKGROUND_LIST_ID,i);t=e[e.length-1]}t&&s.getCurrentBkg.dataUrl&&(t="no"===t?null:await h(w,t,i)),e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteBackground)I(o.FTAR_BACKGROUND_LIST_ID,s.deleteBackground,i),y(w,s.deleteBackground,i),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.setCurrentBkg)p(m,"",s.setCurrentBkg,i),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.currentFtar){s.opts={preview:!0};const t=await N(this.token,s,i),a=await async function(e,t){const a=e+"_currentFlexatarId";let s=(await chrome.storage.local.get([a]))[a];if(0===t.length)return null;for(const{id:e}of t)if(e===s)return s;const r={},o=t[0].id;return r[a]=o,await chrome.storage.local.set(r),o}(i,t);e.postMessage({msgID:s.msgID,payload:{id:a}})}else if(s.makeFlexatar)this.lensPorts.forEach((async e=>{await Y(e,{managerPort:!0}),e.postMessage({imageBuffer:s.buffer},[s.buffer])})),e.postMessage({msgID:s.msgID,payload:{status:"ok"}});else if(s.deleteFlexatar){const t=await B({id:s.deleteFlexatar,token:this.token});t&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.get([a,s])}(s.deleteFlexatar,i),await async function(e,t){const a=e+"_ftarlist";let s=await T(a);s=s.filter((({id:e})=>t!==e)),await L(a,s)}(i,s.deleteFlexatar),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(i)),e.postMessage({msgID:s.msgID,payload:{success:t}})}else if(s.userInfo)s.opts?e.postMessage({msgID:s.msgID,payload:await t.getUserInfo(s.opts)}):e.postMessage({msgID:s.msgID,payload:r});else if(s.decrementFtarCount)await Q(i,r.FtarCount-1),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.showProgress)t.showProgress();else if(s.getUserToken){const a=await t.tokenFn();e.postMessage({msgID:s.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}}function Y(e,t){const a=X();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(r){r.data&&r.data.msgID===a&&(s(r.data.payload),e.removeEventListener("message",t))})),e.postMessage(t)}))}class J{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=X();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(r){r.data&&r.data.msgID===t&&(s(r.data.payload),a.removeEventListener("message",e))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e){return await this.sendWithResponse({flexatar:e})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async getToken(){return await this.sendWithResponse({getUserToken:!0})}}function X(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const Z={Manager:z,ManagerConnection:J,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(v);let r=await s.match(a);if(!r){const o=await U(e,t.id,{ftar:!0});if(r=await fetch(o.ftar,{method:"GET"}),!r.ok)return;const n=await r.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await r.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(v);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const r=await s.arrayBuffer(),o=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,o),r}return await s.arrayBuffer()},flexatarList:S,makeFlexatar:A,deleteFlexatar:B,flexatarEntry:U,userInfo:O,GetToken:x,ERR_UNAUTHORIZED:b,ERR_UNEXPECTED:F};if(void 0===$)var $=self;$.Ftar=Z;const V=new J;let ee;window.parent.postMessage({ftarUIPort:V.outPort},"*",[V.outPort]);new Promise((e=>{window.addEventListener("message",(t=>{t.data&&t.data.flexatarControllerPort?(t.data.flexatarControllerPort,ee=t.data.flexatarControllerPort,e(ee)):t.data&&t.data.closing&&(ee&&(ee.postMessage({closing:!0}),ee.close(),ee=null),V.close())}))}));function te(){reloadIcon.classList.remove("roating"),plusCircle.classList.add("rotated"),makeTextHolder.textContent=e.SUBSCRIPTION_END}confirmButton.onclick=async()=>{if(confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,Ee)noBackgroundButton!==Le&&(await V.deleteBackground(Le.id),Le&&Le.remove(),imageBackgroundContainer.firstElementChild?.click());else{const t=ce.element;await async function(e){return(await V.deleteFlexatar(e)).success}(ce.ftarId)&&(t.remove(),previewListHolder.children.length>0?t===ce.element&&previewListHolder.children[0]?.click():(ce.ftarId=null,emptyBlock.textContent=e.EMPTY))}trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),ue=!ue},reloadFtarListButton.onclick=async()=>{for(reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");previewListHolder.children.length>0;)previewListHolder.children[0]?.remove();const t=await V.getCurrentFtar();if(t){ce={ftarId:t.id};const e=await V.getList({preview:!0,noCache:!0});if(e.error)return void te();for(const{id:t}of e){const e=await V.getPreview(t),a=new Blob([e],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:r}=await le({id:t},s)}}else emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1},trashButton.onclick=()=>{ue?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),ue=!ue},reloadIcon.classList.add("roating"),V.onNewFlexatar=async e=>{if(e.error)return;const t=await V.getPreview(e.id),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:r}=await le({id:e.id},s,!0)},V.ready.then((async()=>{const t=await V.getCurrentFtar();if(t.error)te();else{if(t){ce={ftarId:t.id};const e=await V.getList({preview:!0});if(e.error)return void te();for(const{id:t}of e){const e=await V.getPreview(t),a=new Blob([e],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:r}=await le({id:t},s)}}else emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating")}}));window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=e.ALLOW_AUDIO;const ae=window.location.search;new URLSearchParams(ae);let se;function re(e,t){const a=document.createElement("input");se=document.createElement("form"),se.appendChild(a),a.type="file",a.accept="image/*",a.onchange=e=>t(e),e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),a.dataTransfer,e.classList.remove("hover");const s=a.dataTransfer.files;t({target:{files:s}})}}async function oe(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFtar=!0,await V.makeFlexatar(e)}!function(){const s=createFlexatarHolder,r=plusCircle,o=makeTextHolder;o.textContent=e.DROP_PHOTO;const n=makeOverlayElement;let i;re(s,(async s=>{let c=s.target.files[0];if(!c)return;i&&(i(),i=null);const l=(r.style.display="none",o.style.display="none",n.style.display="block",()=>{r.style.display="block",o.style.display="block",n.style.display="none"});if(!a(c.type,t))return u=e.NOT_PHOTO,r.classList.add("rotated"),o.textContent=u,i=()=>{r.classList.remove("rotated"),o.textContent=e.DROP_PHOTO},void l();var u;await oe(c);l(),se.reset()}))}();const ne={};let ie,ce;async function le(e,t,a){ne[e.id]=e;const s=t,r=document.createElement("span");r.className="item-holder";const o=document.createElement("img");o.src=s,o.draggable=!1,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",r.appendChild(o),r.id=e.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(r,previewListHolder.firstChild):previewListHolder.appendChild(r),r.onclick=async()=>{if(ie&&ie.classList.remove("selected-item"),ie=r,r.classList.add("selected-item"),ce.ftarId===e.id)return;ce={element:r,ftarId:e.id},r.appendChild(n);const t=await V.getFlexatar(e.id);ee&&ee.postMessage({slot1:t,id:e.id},[t]),n.remove()},ce&&ce.ftarId===e.id&&(ce.element=r,r.click()),{holder:r,previewImg:s}}trashButton.classList.remove("invisible");let ue=!1;reloadFtarListButton.classList.remove("invisible");let de,ge,fe,we=!1;document.addEventListener("mousedown",(e=>{pe&&clearInterval(pe),we=!0,de=e.screenY,ge=window.scrollY}));let me,pe,he=0,ye=0,Ie=0,_e=!1;function ke(){if(we=!1,he=0,fe&&clearInterval(fe),document.body.style.pointerEvents="auto",!_e)return;_e=!1,ge=window.scrollY,ye=.5*Ie,pe=setInterval((()=>{ge+=ye,window.scrollTo(0,ge),ye*=.9,Math.abs(ye)<1&&clearInterval(pe)}),50);const e=pe;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{we&&(e.preventDefault(),me=de-e.screenY,!_e&&Math.abs(me)<10||(_e||(Ie=0,fe=setInterval((()=>{ye=me-he,he=me,Ie=.5*(Ie+ye)}),100)),_e=!0,document.body.style.pointerEvents="none",window.scrollTo(0,ge+me)))})),document.addEventListener("mouseup",ke),document.addEventListener("mouseleave",ke),expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")};const ve=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let Le,Te=AllEmo;Te.classList.add("color-emo-selected");for(const e of ve)e.onclick=()=>{Te.classList.remove("color-emo-selected"),Te=e,Te.classList.add("color-emo-selected"),ee&&ee.postMessage({animation:{pattern:e.id}})};AllEmo.onclick=()=>{Te.classList.remove("color-emo-selected"),Te=AllEmo,Te.classList.add("color-emo-selected"),ee&&ee.postMessage({animation:{pattern:null}})};let Ee=!1;function Be(e,t,a=!1){const s=document.createElement("img");return s.id=e,s.src=t,s.draggable=!1,s.style.cursor="pointer",s.style.display="block",s.style.width="100%",s.style.height="auto",s.style.margin="0px",s.style.padding="0px",s.style.boxSizing="border-box",s.style.lineHeight="0px",s.style.verticalAlign="top",s.style.objectFit="contain",a?function(e,t){if(!t.nextSibling)return void t.parentNode.appendChild(e);t.parentNode.insertBefore(e,t.nextSibling)}(s,noBackgroundButton):imageBackgroundContainer.appendChild(s),s.onclick=()=>{Le&&Le.classList.remove("selected-item"),Le=s,s.classList.add("selected-item"),ee&&ee.postMessage({background:t}),V.setCurrentBackground(e)},s}expandBkgButton.onclick=async()=>{if(Ee)expandBkgButton.classList.add("rot180"),dropBackgroundContainer.classList.add("invisible"),imageBackgroundContainer.querySelectorAll("img").forEach((e=>e.remove())),bkgExpander.classList.remove("full-height");else{expandBkgButton.classList.remove("rot180"),dropBackgroundContainer.classList.remove("invisible"),dropBackgroundText.textContent=e.DROP_BACKGROUND,bkgExpander.classList.add("full-height");const t=(await V.getBackgrounds()).reverse();for(const[e,a]of t)a&&Be(e,a);const a=await V.getCurrentBackground();document.getElementById(a)?document.getElementById(a)?.click():noBackgroundButton.click()}Ee=!Ee},noBackgroundButton.onclick=()=>{noBackgroundButton.classList.add("selected-item"),Le&&Le.classList.remove("selected-item"),Le=noBackgroundButton,ee&&ee.postMessage({background:!0,no:!0}),V.setCurrentBackground("no")},re(dropBkgElement,(async e=>{let s=e.target.files[0];if(!s)return;if(!a(s.type,t))return;const r=await async function(e,t,a){const s=await createImageBitmap(e),r=new OffscreenCanvas(t,a),o=r.getContext("2d"),n=s.width/s.height;let i,c,l,u;n>t/a?(c=a,i=s.width*(a/s.height),l=-(i-t)/2,u=0):(i=t,c=s.height*(t/s.width),l=0,u=-(c-a)/2);o.drawImage(s,l,u,i,c);const d=await r.convertToBlob(),g=await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(d)}));return g}(s,480,640);await V.storeNewBackground(r)})),V.onNewBackground=async e=>{Be(e,(await V.getBackgrounds({id:e}))[0][1],!0).click()},ftarLogButton.onclick=e=>{V.showProgress()}})();
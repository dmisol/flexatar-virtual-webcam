(()=>{"use strict";class e{static DROP_PHOTO="ADD\n PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START";static CANCELED="CANCELED";static SUBSCRIPTION_END="NO SUBSCRIPTION";static DROP_BACKGROUND="ADD BACK GROUND"}const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];function a(e,t){for(const a of t)if(e==a)return!0;return!1}async function s(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),(await fetch(e.url,{method:"POST",body:a})).ok?(console.log("ftar send img ok"),!0):(console.error("send img failed"),!1)}class o{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}function n(){console.log("[FTAR_QUEUE_STORAGE]",...arguments)}async function r(e,t="currentUserId"){if(e)return e;const a={};a[t]=null;const s=await chrome.storage.local.get(a);return n("currentUserId",s),s?s[t]:{error:"not_authorized"}}const i={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue",FTAR_FAV_LIST_ID:"_favorite_list",AUIDIO_RECORD_LIST_ID:"_audio_record_list"};async function c(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o].concat(t);return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function l(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=t;return n[o]=i,await chrome.storage.local.set(n),{success:!0}}async function d(e,t){const a=await r(t);if(a.error)return a;const s=a+e,o={};return o[s]=[],(await chrome.storage.local.get(o))[s]}async function u(e,t){n("clear list",e);const a=await r(t);if(a.error)return a;const s=a+e;await chrome.storage.local.remove([s]),n("clear list done",s)}const g={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_SPEECH_PATTERN:"_current_speech_pattern_",CURRENT_MOOD:"_current_mood_",RETARGETING_CALIBRATION:"_retargeting_calibration_",DO_NOT_SHOW_NOTIFICATION_ID:"_do_not_show_",RECORDED_AUDIO_ID:"_recorded_audio_"};async function f(e,t,a,s){const o=await r(s);if(o.error)return o;const i={};i[o+e+t]=a;try{return await chrome.storage.local.set(i),{success:!0}}catch(e){return n(e),{error:"unknown"}}}async function m(e,t,a,s=null){const o=await r(a);if(o.error)return o;const n=o+e+t,i={};i[n]=null;const c=await chrome.storage.local.get(i);return null===c[n]?s:c[n]}async function p(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e+t;await chrome.storage.local.remove([o])}async function w(e,t,a,s="id"){const o=await d(e,a);let r=t[s];r||(r=t),n("queueList",o,e);const i=o.filter((e=>(e[s]||e)!==r));n("newList",i),await l(e,i,a)}async function h(e,t,a){let s=await d(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await p(g.FTAR_SRC_IMG,t.id,a)}await l(e,s,a)}async function I(e,t,a,s){await w(e,a,s),await async function(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.concat(i);return n[o]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],s)}async function _(e,t,a,s,o="id"){const r=await d(e,s);let i=t[o];i||(i=t),n("list content",r,e);const c=r.filter((e=>(e[o]||e)===i));n("list with target element",c),Object.assign(c[0],a),await l(e,r,s)}function y(e,t){return new Promise((a=>{const s=crypto.randomUUID();n("background imageId",s),d(i.FTAR_BACKGROUND_LIST_ID,t).then((o=>{n("background list",o),c(i.FTAR_BACKGROUND_LIST_ID,[s],t).then((o=>{n("add to list",o),f(g.BACKGROUND_SRC_IMAGE,s,e,t).then((e=>{n("BACKGROUND_SRC_IMG saved",e),a(s)}))}))}))}))}async function R(e){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===t)var t=self;"undefined"==typeof chrome&&(t.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const a="flexatar-storage-cache",s=e=>new Request(`https://flexatar-mock-storage/${e}`),o=e=>new URL(e).pathname.slice(1),n=await caches.open(a);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const a=JSON.stringify({value:t}),o=new Response(a,{headers:{"Content-Type":"application/json"}});await n.put(s(e),o)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const a={};if(null==e){const e=(await n.keys()).map((e=>o(e.url)));return t&&t(e),e}const r=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const o=await n.match(s(t));if(o){const e=await o.json();a[t]=e.value}else a[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(r),t&&t(a),a},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>n.delete(s(e))));console.log("start del keys"),await Promise.all(t),console.log("end del keys")},e&&await e()}}function E(...e){const t=(new Date).toLocaleTimeString();console.log(`[${t}] [FTAR_CONNECTION]`,...e)}const T="ftarcache";async function v(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function S(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const D="https://api.flexatar-sdk.com";async function k(e,t){const a=D+"/"+e.id;t||(t=e.token);const s={};try{const e=await L(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:F}:{error:M}}catch(e){return console.error("Flexatar deletion:",e),!1}}function P(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function A(e,t,a,s=0){const o=a+"_ftarpreview_"+e.id,n=(await chrome.storage.local.get([o]))[o];if(n)return await(await fetch(n)).arrayBuffer();if(e.preview){const t=await C(e,a);if(t)return t}const r=await O(t,e.id,{preview:!0});return e.preview=r.preview,await C(e,a)}async function C(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const o=await s.arrayBuffer(),n=await P(o),r={};return r[a]=n,E("store preview",r),await chrome.storage.local.set(r),o}async function L(e,t,a,s){const o=await a.getToken();if("no_token"===o)return o;t.headers.Authorization="Bearer "+o;const n=await self.fetch(e,t);return 403!=n.status?n:(s||(s=2),s<=0?n:(s-=1,a.token=null,await L(e,t,a,s)))}const F="unauthorized",M="UNEXPECTED";async function U(e,t){const a=D+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const o=await L(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);return o.ok?(await o.json()).all:401===o.status?{error:F}:{error:M}}async function O(e,t,a){const s=D+"/list",o={"Content-Type":"application/json"},n=[];a.ftar&&n.push("ftar"),a.preview&&n.push("preview"),a.meta&&n.push("meta");const r={};r[t]=n;try{const a=await L(s,{method:"POST",headers:o,body:JSON.stringify(r)},e);return a.ok?(await a.json()).requested[t]:401===a.status?{error:F}:{error:M}}catch(e){console.error("Flexatar list failed:",e)}}async function B(e){E("requesting user info from cloud");const t=await L(D+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);return"no_token"===t?{error:F}:t.ok?await t.json():401===t.status?{error:F}:{error:M}}class N{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,E("GetToken",t),t}}async function x(e,t,a,s=!0){E("getListDualUser needMyx",s);let o=await d(e,a);return o=o.map((e=>{const s={userId:a};return s[t]=e,s})),"myx@amial.com"!==a&&s&&(o=o.concat((await d(e,"myx@amial.com")).map((e=>{const a={userId:"myx@amial.com"};return a[t]=e,a})))),o}async function b(e,t,a,s=!0){let o=[];if("myx@amial.com"===a)t.opts.noCache=!1,o=await K(W,t,a,!1),o=o.reverse(),E("ftarList myx",o);else if(o=await K(e,t,a,!1),o=o.reverse(),s){t.opts.noCache=!1;const e=await K(W,t,"myx@amial.com",!1);o=o.concat(e.reverse())}return o}async function G(e){const t=[{caption:"ðŸ’¡ Warm Tone",prompt:"Soft golden light wraps around the face, brightening skin and adding a natural warmth. Subtle highlights on the forehead and cheeks create depth. The eyes gain a gentle amber reflection. The overall mood feels sunlit and inviting."},{caption:"ðŸŒ† Cool Tone",prompt:"A calm blue-gray tone softens the scene, giving the portrait a quiet cinematic feel. The skin tone shifts slightly toward cooler neutrals. Shadows contour the face with precise, modern clarity. Eyes reflect faint steel-blue hues."},{caption:"ðŸŒˆ Color Boost",prompt:"Colors appear more vivid and balanced, with deeper contrasts and sharper definition. Light glances across skin textures, giving life to every detail. Subtle chromatic tones enhance vitality. The effect feels crisp, clean, and refined."}];try{let a;if(e&&(a=await e.load()),a)return a;const s=await fetch("https://api.flexatar-sdk.com/aiprompt");return s.ok?(a=await s.json(),e.save(a),a):t}catch(e){return t}}const W=new N((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken/androidapp");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}())),q=new o,Q=new o;async function K(e,t,a,s=!1){return await q.enqueue((async()=>{const s=a+"_ftarlist";let o=t.opts.noCache?null:await S(s);return E("ftar list from storage",o),o||(E("fetching list",a),o=await U(e,t.opts),o.error?E("ftarList.error",o.error):await v(s,o)),o.forEach((e=>{e.userId=a})),o}))}async function j(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function H(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function z(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function V(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function J(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function Y(e,t){const a=e+"_FtarCount",s={};s[a]=t,E("setting ftar count at key",a,"count is",t),await chrome.storage.local.set(s)}async function Z(e,t,a){const o=await r(null,a);if(!await m(g.IS_QUEUE_IN_PROGRESS,"",o,!0))return void E("flexatar creation is on pause");const n=await async function(e){const t=await d(i.FTAR_PROCESSING_QUEUE_LIST_ID,e),a=await m(g.IS_QUEUE_IN_PROGRESS,"",e,!0);return E("isQueueInProgress",a,t),(0!==t.length||!a)&&t[0]}(o);if(E("isFlexatarInProgress",n),n)return void E("flexatar in progress");const c=(await d(i.FTAR_MAKE_QUEUE_LIST_ID,o))[0];if(c){E("Start creation of flexatar for image id",c);const o=await r(null,a);await I(i.FTAR_MAKE_QUEUE_LIST_ID,i.FTAR_PROCESSING_QUEUE_LIST_ID,c,o);const n=D+"/make",l=await async function(e,t,a,s){let o=s?JSON.stringify({aiPrompt:JSON.parse(JSON.parse(s))}):void 0;const n=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:o},t);if(!n.ok)return console.log("faild obtain make link",await n.json()),{error:{type:"unknown",message:n.status}};const r=await n.json();return r.block?{error:{type:"block",reason:r.block}}:r}(n,e,L,c.aiPrompt);if(l.error)return E("upload link error"),await I(i.FTAR_PROCESSING_QUEUE_LIST_ID,i.FTAR_ERROR_LIST_ID,c,o),await h(i.FTAR_ERROR_LIST_ID,5,o),void(t&&t());E("obtained ftar link with id",l.id),await _(i.FTAR_PROCESSING_QUEUE_LIST_ID,c.id,{ftarId:l.id},o);const d=await m(g.FTAR_SRC_IMG,c.id,o);if(d){const e=function(e,t){const[a,s]=e.split(","),o=a.match(/:(.*?);/),n=o?o[1]:"application/octet-stream",r=atob(s),i=Uint8Array.from(r,(e=>e.charCodeAt(0)));return new File([i],t,{type:n})}(d);await s(l.link,e)||await async function(){await I(i.FTAR_PROCESSING_QUEUE_LIST_ID,i.FTAR_ERROR_LIST_ID,imgId,currentUserId),await h(i.FTAR_ERROR_LIST_ID,5,currentUserId)}()}}}async function $(e){const t={successImages:i.FTAR_SUCCESS_LIST_ID,errorImages:i.FTAR_ERROR_LIST_ID,queueImages:i.FTAR_MAKE_QUEUE_LIST_ID},a="currentUserId",s=await r(null,a),o={};for(const[e,n]of Object.entries(t)){E("user id when loading lists",s,a);const t=await d(n,s);E("loaded list",e,n,t);const r=t.map((async e=>await m(g.FTAR_SRC_IMG,e.id,s)));o[e]=await Promise.all(r)}const n=[i.FTAR_PROCESSING_QUEUE_LIST_ID,i.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of n){const t=(await d(e,s)).map((async e=>await m(g.FTAR_SRC_IMG,e.id,s))),a=await Promise.all(t);a&&a.length>0&&o.queueImages.unshift(a[0])}return E("progressLists",o),E("getting ftar count to progress userId",s),o.flexatarCount=await J(s),o.isQueueInProgress=await m(g.IS_QUEUE_IN_PROGRESS,"",s,!0),o}const X=new o;let ee=0;function te(e){if(E("visibilityTracker","undefined"!=typeof document),"undefined"!=typeof document){function t(){document.hidden?e({visible:!1}):e({visible:!0})}document.addEventListener("visibilitychange",t),document.hidden||e({visible:!0})}else self.addEventListener("message",(t=>{console.log("Worker received:",t.data),t.data.documentState&&e(t.data.documentState)})),self.postMessage({visibilityRequest:!0})}function ae(e,t){const a=oe();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(o){o.data&&(E("responese",o.data),o.data.msgID===a&&(s(o.data.payload),e.removeEventListener("message",t)))})),e.postMessage(t)}))}class se{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.animationPatternRequest?this.onAnimationPatternRequest&&this.onAnimationPatternRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=oe();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(o){o.data&&(E("responese",o.data),o.data.msgID===t&&(s(o.data.payload),a.removeEventListener("message",e)))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const n=new FileReader;n.readAsArrayBuffer(e),n.onload=()=>s({buffer:n.result,fileType:t,fileName:a}),n.onerror=e=>o(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}async showAnimate(){return await this.sendWithResponse({showAnimate:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async getSpeechPattern(){return await this.sendWithResponse({getSpeechPattern:!0})}async getMood(){return await this.sendWithResponse({getMood:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async setSpeechPattern(e){return await this.sendWithResponse({setSpeechPattern:e})}async setMood(e){return await this.sendWithResponse({setMood:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}async addToFavorite(e){return await this.sendWithResponse({addToFavorite:{value:e}})}async removeFromFavorite(e){return await this.sendWithResponse({removeFromFavorite:{value:e}})}async getFavorite(){return await this.sendWithResponse({getFavorite:!0})}async saveAudioEntry(e){return await this.sendWithResponse({saveAudioEntry:e})}async getRecordedAudioList(e="default"){return await this.sendWithResponse({getRecordedAudioList:e})}async deleteRecordedAudio(e){return await this.sendWithResponse({deleteRecordedAudio:e})}async getRecordedAudio(e){return await this.sendWithResponse({getRecordedAudio:e})}}function oe(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const ne={Manager:class{static clearCurrentUserId(){chrome.storage.local.set({currentUserId:null})}constructor(e,t,a=async()=>[],s=!1,o=!1,n=!0){let c;E("new instance of manager"),this.userIdKey=()=>"currentUserId";const l=this;o||(E("patching chrome.storage"),c=R((async()=>{E("reseting userId key");const e={};e[l.userIdKey()]=null,await chrome.storage.local.set(e)})),this.patchPromise=c),this.defaultBackgroundFn=a,this.managerName=t,this.tokenFn=e,this.needMyxAccount=n,E("needMyxAccount",n),this.token=new N((async()=>await e())),s&&(c||Promise.resolve()).then((async()=>{for(;!l.managerName;)await new Promise((e=>setTimeout(e,200)));const e=await r(null,l.userIdKey());[i.FTAR_ERROR_LIST_ID,i.FTAR_SUCCESS_LIST_ID,i.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{u(t,e)}))})),te((({visible:e})=>{e?l.setupPolling():l.cancelPolling()}))}cancelPolling(){E("polling stopped");const e=this;e.pollingInterval&&(clearInterval(e.pollingInterval),e.pollingInterval=null)}setupPolling(){const e=this;e.cancelPolling(),E("polling created flexatar started"),e.pollingInterval=setInterval((async()=>{E("trying to poll flexatar in queue");const t=await X.enqueue((async()=>await e.getUserInfo()));E("user info while polling",t);const a=await async function(e,t,a){const s=await r(null,t),o=await d(i.FTAR_PROCESSING_QUEUE_LIST_ID,s);if(E("ftarListProcessing",o),0===o.length)return{status:"empty"};const n=o[0];if(n){n.firtsPollingAttemptAt||(E("first poll for given ftar"),n.firtsPollingAttemptAt=Date.now(),await _(i.FTAR_PROCESSING_QUEUE_LIST_ID,n,{firtsPollingAttemptAt:n.firtsPollingAttemptAt},s));const t=await async function(e,t){E("checkIfFlexatarReady");const a=(await d(i.FTAR_PROCESSING_QUEUE_LIST_ID,t))[0],s=D+"/poll",o=await async function(e,t,a,s){const o=await a(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s})},t);return o.ok?await o.json():404===o.status?{status:"in_progress"}:{error:await o.text()}}(s,e,L,a.ftarId);return E("pollResult",o),o}(e,s),o=Date.now()-n.firtsPollingAttemptAt;if(E("timeSinceFirstPollingAttempt",o),t.success){E("ftar success with img id",n.id),await I(i.FTAR_PROCESSING_QUEUE_LIST_ID,i.FTAR_SUCCESS_LIST_ID,n,s),await h(i.FTAR_SUCCESS_LIST_ID,5,s),await b(e,{opts:{}},s,a);const o=function(e,t="image/jpeg"){const a=function(e){let t="";const a=new Uint8Array(e),s=a.byteLength;for(let e=0;e<s;e++)t+=String.fromCharCode(a[e]);return re.btoa(t)}(e);return`data:${t};base64,${a}`}(await A({id:n.ftarId},e,s));return await f(g.FTAR_SRC_IMG,n.id,o,s),{status:"ready",id:t.id}}return!1===t.success||t.error||o>2e5?(await I(i.FTAR_PROCESSING_QUEUE_LIST_ID,i.FTAR_ERROR_LIST_ID,n,s),await h(i.FTAR_ERROR_LIST_ID,5,s),{status:"error"}):(E("flexatarStatus",t),{status:"in_progress"})}}("myx@amial.com"===t.user_id?W:e.token,e.userIdKey(),e.needMyxAccount),s=await r(null,e.userIdKey());if("ready"===a.status&&(await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await S(a);s.push({id:t}),await v(a,s)}(s,a.id),await async function(e){await Y(e,await J(e)-1)}(s),e.ports.forEach((e=>{e.postMessage({newFlexatar:{id:a.id,userId:s}})}))),"ready"===a.status||"error"===a.status){const t=await $(e.managerName);E("sending updated progress list"),e.progressPorts.forEach((e=>{e.postMessage({progressLists:t})}))}0===(await d(i.FTAR_PROCESSING_QUEUE_LIST_ID,s)).length&&(E("found empty processing list"),(await d(i.FTAR_MAKE_QUEUE_LIST_ID,s)).length>0&&(E("found flexatar creation task in queue"),e.ftarQueueDelegate(e.token,(()=>{e.progressPorts.forEach((async t=>{t.postMessage({progressLists:await $(e.managerName)})}))}),e.userIdKey())))}),15e3)}showAnimate(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)E("port from effects"),t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)E("effectStateRequest"),t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;E("slot2"),t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}else if(a.slot1){const e=a.slot1;E("slot2"),t.ports.forEach((t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])}))}}}showRetarg(){this.retargPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?(E("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort&&t.onMediaPort(a.mediaPort))}}animPorts=[];showAnim(){this.animPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}addAnimPort(e){const t=this;this.animPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(E("animation port message",a),a.managerConnectionPort?(E("port from retarg"),t.addPort(a.managerConnectionPort)):a.mediaPort?t.onMediaPort(a.mediaPort):a.animationPatternRequest&&(E("animationPatternRequest",t.ports.length),t.ports.forEach((e=>{e.postMessage(a)}))))}}notificationPorts=[];addNotificationPort(e){this.notificationPorts.push(e),e.onmessage=async e=>{const t=e.data;if(t&&(E("notifiaction port message",t),t.doNotShowOptionChanged)){const e="any_user@world.com";await f(g.DO_NOT_SHOW_NOTIFICATION_ID,t.doNotShowOptionChanged.notificationId,{value:!t.doNotShowOptionChanged.value},e)}}}async showNotification(e,t){let a=await m(g.DO_NOT_SHOW_NOTIFICATION_ID,e,"any_user@world.com",{value:!0});a=a||{value:!0},E("notification needToBeShown",a),a.value&&this.notificationPorts.forEach((a=>{a.postMessage({managerPort:!0,notificationText:t,notificationId:e})}))}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const o=await X.enqueue((async()=>await t.getUserInfo()));E("addProgressPort userInfoResult",o);const n=o.user_id;if(s.progressLists){E("request progress list"),s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await $(t.managerName);e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await f(g.IS_QUEUE_IN_PROGRESS,"",!1,n);else if(s.clearMakeQueue){await u(i.FTAR_MAKE_QUEUE_LIST_ID,n);const a=await $(t.managerName);e.postMessage({progressLists:a})}else s.startMakeQueue&&(await f(g.IS_QUEUE_IN_PROGRESS,"",!0,n),t.ftarQueueDelegate(t.token,(async()=>{const a=await $(t.managerName);E("sending updated progress list"),e.postMessage({progressLists:a})}),t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const a="currentUserId";E("currentUserIdKey",a);const s=await r(null,this.userIdKey());if(s||(this.token.token=null),E("current user id",s),s&&!t){const e=s+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:s,FtarCount:t}}let o=await B(this.token);E("obtained userInf",o),o.error&&(o={FtarCount:"100",user_id:"myx@amial.com"});const n=o.user_id,i={};return i[a]=n,await chrome.storage.local.set(i),await Y(n,o.FtarCount),o}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{console.log("manager port not responding"),this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),console.log("manager port ok"),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await X.enqueue((async()=>await t.getUserInfo()));await ae(a,{managerPort:!0}),E("lens port connected and answered"),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=Z;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const s=a.data;if(s)if(await X.enqueue((async()=>await t.getUserInfo())),s.imagesList){const e=s.imagesList;E("imagesList",e);const a=e.map((e=>({aiPrompt:s.aiPrompt,id:e.id}))),o=await r(null,t.userIdKey()),n="myx@amial.com"===o?W:t.token;await c(i.FTAR_MAKE_QUEUE_LIST_ID,a,o);for(const{dataUrl:t,id:a}of e)E("FTAR_SRC_IMG saved",await f(g.FTAR_SRC_IMG,a,t,o));E("from ftar lens starting ftar creation"),t.ftarQueueDelegate(n,(async()=>{t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await $(t.managerName)})}))}),t.userIdKey()),t.showProgress()}else s.needAuthorize?t.onNeedAuthorize():s.closing?(t.lensPorts=t.lensPorts.filter((t=>t!==e)),console.log("lens port count",t.lensPorts.length)):s.aiPromptsRequest&&(E("ai prompts responsing"),e.postMessage({promptList:await G({load:async()=>{const e=await m("AI_PROMPTS","","no_user");return E("loading stored prompts"),e},save:async e=>{E("saving loaded prompts"),await f("AI_PROMPTS","",e,"no_user")}})}))}}onNeedAuthorize=()=>{E("need authorize")};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;E("msg on manager port:",s);const o=await X.enqueue((async()=>(ee++,E("userInfo counter",ee),await t.getUserInfo())));if(o.error)return E("uInfo.error",o.error),void e.postMessage({msgID:s.msgID,payload:o});const n=o.user_id,l={};if(l[n]=t.token,l["myx@amial.com"]=W,E("userId",n),s.ftarList){const a=await b(t.token,s,n,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.backgroundsList)Q.enqueue((async()=>{if("empty"===t.managerName)return void e.postMessage({msgID:s.msgID,payload:[]});const a=s.opts??{};let o;if(o=a.id?[{id:a.id,userId:a.userId}]:await x(i.FTAR_BACKGROUND_LIST_ID,"id",n,t.needMyxAccount),!o||0===o.length){E("requestiong default backgrounds");const e=await t.defaultBackgroundFn();E("defaultBackgrounds",e);for(const t of e)await y(t,n);o=await x(i.FTAR_BACKGROUND_LIST_ID,"id",n,t.needMyxAccount)}const r=[];for(const{id:e,userId:t}of o){const a=await m(g.BACKGROUND_SRC_IMAGE,e,t);r.push([{id:e,userId:t},a])}e.postMessage({msgID:s.msgID,payload:r})}));else if(s.preview){E("requesting preview",s.preview);let t=await A({id:s.preview.id},l[s.preview.userId],s.preview.userId);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});console.log("previewBuffer",t),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.flexatar){E("msg.flexatar",s.flexatar);let t=await async function(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,o=(await chrome.storage.local.get([s]))[s];if(o)return await(await fetch(o)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let n;if(E("get ftar list element",t),t.ftar)n=await fetch(t.ftar,{method:"GET"});else{const a=await O(t.is_myx?W:e,t.id,{ftar:!0});n=await fetch(a.ftar,{method:"GET"})}if(!n.ok)return;const r=await n.arrayBuffer(),i=await P(r),c={};return c[s]=i,await chrome.storage.local.set(c),r}(l[s.flexatar.userId],{id:s.flexatar.id,is_myx:!1},s.flexatar.userId);if(E("ftar buffer ",t),!t)return void e.postMessage({msgID:s.msgID,payload:null});s.setAsCurrent&&(E("setting current ftar id ",s.flexatar,n),await j(s.flexatar,n)),s.setAsCurrentSlot2&&(E("setting current ftar id ",s.flexatar,n),await H(s.flexatar,n)),E("sending flexatar data"),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.closing)t.ports=t.ports.filter((t=>t!==e)),e.close(),console.log("closing port on ftar manager",t.ports.length);else if(s.storeNewBackground){const t=await y(s.storeNewBackground,n);e.postMessage({msgID:s.msgID,payload:{id:t,userId:n}}),e.postMessage({newBackGround:{id:t,userId:n}})}else if(s.getCurrentBkg){let t=await m(g.BACKGROUND_CURRENT_ID,"",n);t||(t=await m(g.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&s.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await m(g.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteBackground)w(i.FTAR_BACKGROUND_LIST_ID,s.deleteBackground,n),p(g.BACKGROUND_SRC_IMAGE,s.deleteBackground,n),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.setCurrentBkg)f(g.BACKGROUND_CURRENT_ID,"",s.setCurrentBkg,n),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.getSelectedFtar){const t=n+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:s.msgID,payload:{selectedFtar:a}})}else if(s.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(s.setSelectedFtar.value,n),e.postMessage({msgID:s.msgID,payload:{}});else if(s.currentFtarSlot2){s.opts={preview:!0};let a=await z(n);if(!a){const e=await b(t.token,s,n,t.needMyxAccount);await H(e[0],n)}a=await z(n),E("get current ftar, id",a),e.postMessage({msgID:s.msgID,payload:a})}else if(s.currentFtar){s.opts={preview:!0},E("obtaining current ftar");let a=await V(n);if(!a){E("no current ftar requesting list");const e=await b(t.token,s,n,t.needMyxAccount);await j(e[0],n)}a=await V(n),E("get current ftar, id",a),e.postMessage({msgID:s.msgID,payload:a})}else if(s.makeFlexatar)E("photo obtained"),this.lensPorts.forEach((async e=>{await ae(e,{managerPort:!0}),E("lens port connected and answered"),e.postMessage({imageBuffer:s.buffer},[s.buffer])})),e.postMessage({msgID:s.msgID,payload:{status:"ok"}});else if(s.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await S(a);return s=s.filter((({id:e})=>t!==e)),await v(a,s),{isAuthorized:!0}}(n,s.deleteFlexatar),a="myx@amial.com"===n?(E("no deletion on server"),!0):await k({id:s.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(s.deleteFlexatar,n),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(n)),e.postMessage({msgID:s.msgID,payload:{success:a}})}else if(s.userInfo)s.opts?e.postMessage({msgID:s.msgID,payload:await t.getUserInfo(s.opts)}):e.postMessage({msgID:s.msgID,payload:o});else if(s.decrementFtarCount)await Y(n,o.FtarCount-1),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.animationPatternResponse)E("animationPatternResponse",s.animationPatternResponse),t.animPorts.forEach((e=>{e.postMessage(s)}));else if(s.effectStateResponse)E("effectStateResponse"),t.effectPorts.forEach((e=>{e.postMessage(s)}));else if(s.showAnimate)t.showAnimate();else if(s.showRetarg)t.showRetarg();else if(s.showEffects)t.showEffects();else if(s.showProgress)t.showProgress();else if(s.setRetargetingStatus)await f(g.RETARGETING_STATUS,"",s.setRetargetingStatus,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingStatus){let t=await m(g.RETARGETING_STATUS,"",n);e.postMessage({msgID:s.msgID,payload:t?t.value:null})}else if(s.setRetargetingCalibration)await f(g.RETARGETING_CALIBRATION,"",s.setRetargetingCalibration,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingCalibration){let t=await m(g.RETARGETING_CALIBRATION,"",n);e.postMessage({msgID:s.msgID,payload:t})}else if(s.setViewportSize)await f(g.CURRENT_VIEWPORT_SIZE,"",s.setViewportSize,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getViewportSize){let t=await m(g.CURRENT_VIEWPORT_SIZE,"",n,{width:320,height:640});E("posting vieport size"),e.postMessage({msgID:s.msgID,payload:t||{width:640,height:480}})}else if(s.setSpeechPattern)await f(g.CURRENT_SPEECH_PATTERN,"",s.setSpeechPattern,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getSpeechPattern){let t=await m(g.CURRENT_SPEECH_PATTERN,"",n,{value:"calm"});e.postMessage({msgID:s.msgID,payload:t||{value:"calm"}})}else if(s.setMood)await f(g.CURRENT_MOOD,"",s.setMood,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getMood){let t=await m(g.CURRENT_MOOD,"",n,{value:"friendly"});e.postMessage({msgID:s.msgID,payload:t||{value:"friendly"}})}else if(s.getFavorite){const t=await d(i.FTAR_FAV_LIST_ID,n);e.postMessage({msgID:s.msgID,payload:t})}else if(s.removeFromFavorite){const t=s.removeFromFavorite.value;await w(i.FTAR_FAV_LIST_ID,{id:t},n),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.addToFavorite){const t=s.addToFavorite.value;await async function(e,t,a){const s=await r(a);if(s.error)return s;const o=s+e,n={};n[o]=[];const i=(await chrome.storage.local.get(n))[o],c=t.filter((e=>!i.includes(e)));return c.length>0&&(n[o]=i.concat(c),await chrome.storage.local.set(n)),{success:!0,addedCount:c.length}}(i.FTAR_FAV_LIST_ID,[{id:t}],n),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.getRecordedAudio){const t=await m(g.RECORDED_AUDIO_ID,s.getRecordedAudio.id,n);e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteRecordedAudio)await w(i.AUIDIO_RECORD_LIST_ID+"_"+s.deleteRecordedAudio.folder,s.deleteRecordedAudio,n),await p(g.RECORDED_AUDIO_ID,s.deleteRecordedAudio.id,n),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRecordedAudioList){const t=await d(i.AUIDIO_RECORD_LIST_ID+"_"+s.getRecordedAudioList,n);e.postMessage({msgID:s.msgID,payload:t})}else if(s.saveAudioEntry){const t=s.saveAudioEntry.folder,a=s.saveAudioEntry.dataUrl;s.saveAudioEntry.dataUrl=void 0,s.saveAudioEntry.folder=void 0,a?(await c(i.AUIDIO_RECORD_LIST_ID+"_"+t,[s.saveAudioEntry],n),await f(g.RECORDED_AUDIO_ID,s.saveAudioEntry.id,a,n)):await _(i.AUIDIO_RECORD_LIST_ID+"_"+t,s.saveAudioEntry.id,s.saveAudioEntry,n),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.deleteEffectPreset){const t=(await d(i.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId)).filter((e=>e.presetId!==s.deleteEffectPreset.presetId));await u(i.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId),await c(i.FTAR_PRESET_LIST_ID,t,s.deleteEffectPreset.userId),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.getEffectPresets){const a=await x(i.FTAR_PRESET_LIST_ID,"presetInfo",n,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.saveEffectPreset)await c(i.FTAR_PRESET_LIST_ID,[s.saveEffectPreset],n),e.postMessage({msgID:s.msgID,payload:{success:{userId:n}}});else if(s.getManagerName)e.postMessage({msgID:s.msgID,payload:t.managerName});else if(s.getUserToken){const a="myx@amial.com"===n?await W.getToken():await t.tokenFn();e.postMessage({msgID:s.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){E("newBackgroundCreated",e),this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}},ManagerConnection:se,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(T);let o=await s.match(a);if(!o){const n=await O(e,t.id,{ftar:!0});if(o=await fetch(n.ftar,{method:"GET"}),!o.ok)return;const r=await o.arrayBuffer(),i=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),r}return await o.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(T);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const o=await s.arrayBuffer(),n=new Response(new Uint8Array(o),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,n),o}return await s.arrayBuffer()},flexatarList:U,makeFlexatar:async function(e,t,a,o,n){a||(a="");const r=D+"/make",i=await async function(e,t,a,o,n,r,i){const c=await r(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o})},t);if(!c.ok)return console.log("faild obtain make link",await c.json()),{error:{status:c.status}};const l=await c.json();if(l.block)return{success:!1,reason:l.block};i&&await i(l.id);const d=l.link;if(!await s(d,a))return;let u=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(l.poll,{method:"GET"});if(!a.ok)return u+=1,u>10&&(clearInterval(t),e()),void console.log("ftar not ready");const s=await a.json();console.log("ftar ready",s),clearInterval(t),e(s)}),5e3)}))}(r,e,t,a,0,L,n);if(!i)return E("make ftar unexpected"),{error:M};if(i.error)return 401===i.error.status?{error:F}:{error:M};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return o&&(c=o),await O(e,i.id,c)},deleteFlexatar:k,flexatarEntry:O,userInfo:B,GetToken:N,ERR_UNAUTHORIZED:F,ERR_UNEXPECTED:M};if(void 0===re)var re=self;re.Ftar=ne;const ie=se;function ce(){console.log("[FTAR_UI]",...arguments)}console.log("poast getFtarPreview");const le=new ie;let de;le.onEffectMessage=e=>{de.postMessage(e)},le.onSlot2=e=>{de.postMessage(e,[e.slot2])},le.onSlot1=e=>{ce("slot1 from effect",e.ftarLink1),de.postMessage(e,[e.slot1])},le.onEffectStateRequest=e=>{ce("effectStateRequest"),ue.then((t=>{t.postMessage(e)}))},le.onAnimationPatternRequest=e=>{ce("onAnimationPatternRequest"),ue.then((t=>{t.postMessage(e)}))},window.parent.postMessage({ftarUIPort:le.outPort},"*",[le.outPort]),ce("posting ftarUIPortUnauthorized port");const ue=new Promise((e=>{window.addEventListener("message",(t=>{t.data&&t.data.flexatarControllerPort?(ce("ftar ui flexatarControllerPort",t.data.flexatarControllerPort),de=t.data.flexatarControllerPort,de.onmessage=e=>{const t=e.data;t&&(t.effectStateResponse?(ce("effectStateResponse"),le.sendEffectState(t)):t.animationPatternResponse&&(ce("animationPatternResponse",t),le.sendEffectState(t)))},e(de)):t.data&&t.data.clickFlexatarCreation?he.click():t.data&&t.data.closing&&(console.log("iframe controller port close"),de&&(de.postMessage({closing:!0}),de.close(),de=null),le.close())}))}));function ge(e,t){const a=e.findIndex(t);if(-1===a)return null;const s=e[a];return e.splice(a,1),s}async function fe(t,a){const s=await le.getFavorite();ce("favList",s);const o=[];let n=await le.getList({preview:!0,noCache:t});for(const e of s){const t=ge(n,(t=>t.id===e.id));ce("matchFound",t),t&&o.push(t)}if(n=o.reverse().concat(n),n.error)return reloadIcon.classList.remove("roating"),void(makeTextHolder.textContent=e.SUBSCRIPTION_END);ce("selectedFtar",a);for(const e of n){ce(e);const t=await le.getPreview(e),s=new Blob([t],{type:"image/jpg"}),o=URL.createObjectURL(s),{holder:n}=await ve(e,o,null,a.id,le)}}async function me(e){for(reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");previewListHolder.children.length>0;)previewListHolder.children[0]?.remove();let t=await le.getCurrentFtar();await fe(e,t),reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1}confirmButton.onclick=async()=>{if(confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,Ge)noBackgroundButton!==xe&&(await le.deleteBackground(xe.id),xe&&xe.remove(),imageBackgroundContainer.firstElementChild?.click());else{const t=Re;await async function(e){return(await Ee.deleteFlexatar(e)).success}(ye)&&(t.remove(),previewListHolder.children.length>0?t===Re&&previewListHolder.children[0]?.click():(ye=null,emptyBlock.textContent=e.EMPTY))}trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),Se=!Se},reloadFtarListButton.onclick=async()=>{ce("reload clicked"),await me(!0)},trashButton.onclick=()=>{Se?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),Se=!Se},reloadIcon.classList.add("roating"),le.onNewFlexatar=async e=>{if(ce("new flexatar",e),e.error)return;const t=await le.getPreview(e),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:o}=await ve(e,s,!0,e.id,le)},Promise.all([le.ready]).then((async()=>{let e=await le.getCurrentFtar();await fe(!1,e),reloadIcon.classList.remove("roating")})),window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=e.ALLOW_AUDIO;const pe=window.location.search;function we(e,t){const a=document.createElement("input"),s=document.createElement("form");return s.appendChild(a),a.type="file",a.accept="image/*",a.capture="user",a.onchange=e=>{t(e),s.reset()},e.onclick=()=>{ce("clicked on drop zone"),a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),ce("on drop",a.dataTransfer),e.classList.remove("hover");const o=a.dataTransfer.files;t({target:{files:o}}),s.reset()},a}new URLSearchParams(pe);const he=function(){const s=createFlexatarHolder,o=makeTextHolder;o.textContent=e.DROP_PHOTO;const n=makeOverlayElement;let r;return ce("setting up flexatar create button"),we(s,(async s=>{let i=s.target.files[0];if(!i)return;ce("photo obtained"),r&&(r(),r=null);const c=(o.style.display="none",n.style.display="block",()=>{o.style.display="block",n.style.display="none"});if(!a(i.type,t))return l=e.NOT_PHOTO,o.textContent=l,r=()=>{o.textContent=e.DROP_PHOTO},void c();var l;ce("ftarLink",await async function(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const n=new FileReader;n.readAsArrayBuffer(e),n.onload=()=>s({buffer:n.result,fileType:t,fileName:a}),n.onerror=e=>o(e)}))}(e);return t.makeFtar=!0,await le.makeFlexatar(e)}(i)),c()}))}(),Ie={};let _e,ye,Re,Ee,Te=!1;async function ve(e,t,a,s,o){Ie[e.id]=e;const n=t,r=document.createElement("span");r.className="item-holder";const i=document.createElement("img");i.src=n,i.draggable=!1,i.style.cursor="pointer",i.style.display="block",i.style.width="100%",i.style.height="auto",i.style.margin="0px",i.style.padding="0px",i.style.boxSizing="border-box",i.style.lineHeight="0px",i.style.verticalAlign="top",i.style.objectFit="contain",r.appendChild(i),console.log("appending preview image"),r.id=e.id;const c=document.createElement("span");return c.className="loader",a?previewListHolder.insertBefore(r,previewListHolder.firstChild):previewListHolder.appendChild(r),r.onclick=async()=>{likeButton.disabled=!0,_e&&_e.classList.remove("selected-item"),_e=r,r.classList.add("selected-item"),ye=e.id,Re=r,Ee=o,r.appendChild(c);const t=await le.getFlexatar(e,!0);console.log("ftarBuffer",t),de&&(de.postMessage({slot1:t,id:e.id},[t]),de.postMessage({noEffect:!0})),c.remove(),likeButton.disabled=!1,0===(await le.getFavorite()).filter((t=>t.id===e.id)).length?(likeButton.classList.remove("like-selected"),Te=!1,trashButton.disabled=!1):(likeButton.classList.add("like-selected"),Te=!0,trashButton.disabled=!0)},s===e.id&&(Re=r,s&&r.click()),{holder:r,previewImg:n}}trashButton.classList.remove("invisible");let Se=!1;reloadFtarListButton.classList.remove("invisible");let De,ke,Pe,Ae=!1;document.addEventListener("mousedown",(e=>{Le&&clearInterval(Le),Ae=!0,De=e.screenY,ke=window.scrollY}));let Ce,Le,Fe=0,Me=0,Ue=0,Oe=!1;function Be(){if(Ae=!1,Fe=0,Pe&&clearInterval(Pe),document.body.style.pointerEvents="auto",!Oe)return;Oe=!1,ke=window.scrollY,Me=.5*Ue,Le=setInterval((()=>{ke+=Me,window.scrollTo(0,ke),Me*=.9,Math.abs(Me)<1&&clearInterval(Le)}),50);const e=Le;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{Ae&&(e.preventDefault(),Ce=De-e.screenY,!Oe&&Math.abs(Ce)<10||(Oe||(Ue=0,Pe=setInterval((()=>{Me=Ce-Fe,Fe=Ce,Ue=.5*(Ue+Me)}),100)),Oe=!0,document.body.style.pointerEvents="none",window.scrollTo(0,ke+Ce)))})),document.addEventListener("mouseup",Be),document.addEventListener("mouseleave",Be),emotionText.onclick=expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")};const Ne=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let xe,be=AllEmo;be.classList.add("color-emo-selected");for(const e of Ne)e.onclick=()=>{be.classList.remove("color-emo-selected"),be=e,be.classList.add("color-emo-selected"),de&&de.postMessage({animation:{pattern:e.id}})};AllEmo.onclick=()=>{be.classList.remove("color-emo-selected"),be=AllEmo,be.classList.add("color-emo-selected"),de&&de.postMessage({animation:{pattern:null}})};let Ge=!1;function We(e,t,a,s=!1){ce("addBackgroundItem ",e);const o=document.createElement("img");return o.id=e.id,o.src=t,o.draggable=!1,o.style.cursor="pointer",o.style.display="block",o.style.width="100%",o.style.height="auto",o.style.margin="0px",o.style.padding="0px",o.style.boxSizing="border-box",o.style.lineHeight="0px",o.style.verticalAlign="top",o.style.objectFit="contain",s?(n=o,(r=noBackgroundButton).nextSibling?r.parentNode.insertBefore(n,r.nextSibling):r.parentNode.appendChild(n)):imageBackgroundContainer.appendChild(o),o.onclick=async()=>{xe&&xe.classList.remove("selected-item"),xe=o,o.classList.add("selected-item"),de&&de.postMessage({background:t}),ce("setting current background",e),le.setCurrentBackground(e)},o;var n,r}backgroundText.onclick=expandBkgButton.onclick=async()=>{Ge?(expandBkgButton.classList.add("rot180"),dropBackgroundContainer.classList.add("invisible"),imageBackgroundContainer.querySelectorAll("img").forEach((e=>e.remove())),bkgExpander.classList.remove("full-height")):(expandBkgButton.classList.remove("rot180"),dropBackgroundContainer.classList.remove("invisible"),dropBackgroundText.textContent=e.DROP_BACKGROUND,bkgExpander.classList.add("full-height"),async function(){const e=(await le.getBackgrounds()).reverse();let t=await le.getCurrentBackground();t||(await le.setCurrentBackground(e[0][0]),t=await le.getCurrentBackground());for(const[t,a]of e)ce("background list element id",t),We(t,a);ce("currentBackground",t);const a=document.getElementById(t.id);ce("currentSelected",a),a?a.click():noBackgroundButton.click()}()),Ge=!Ge},noBackgroundButton.onclick=()=>{noBackgroundButton.classList.add("selected-item"),xe&&xe.classList.remove("selected-item"),xe=noBackgroundButton,de&&de.postMessage({background:!0,no:!0}),le.setCurrentBackground("no")},we(dropBkgElement,(async e=>{let s=e.target.files[0];if(!s)return;if(!a(s.type,t))return;const o=await async function(e,t,a){const s=await createImageBitmap(e),o=new OffscreenCanvas(t,a),n=o.getContext("2d");let r,i,c,l;s.width/s.height>.75?(i=a,r=s.width*(a/s.height),c=-(r-t)/2,l=0):(r=t,i=s.height*(t/s.width),c=0,l=-(i-a)/2),n.drawImage(s,c,l,r,i);const d=await o.convertToBlob();return await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(d)}))}(s,480,640);await le.storeNewBackground(o),ce("photo bkg obtained",s)})),le.onNewBackground=async e=>{ce("new background event",e),We(e,(await le.getBackgrounds(e))[0][1],0,!0).click()},ftarLogButton.onclick=e=>{le.showProgress(),ce("show creation log")},effectsButton.onclick=()=>{le.showEffects()},retargetingButton.onclick=()=>{le.showRetarg()},animateButton.onclick=()=>{le.showAnimate()},likeButton.onclick=async()=>{Te?(ce("remove from fav clciked"),likeButton.classList.remove("like-selected"),await le.removeFromFavorite(ye),Te=!1):(ce("add to fav clciked"),likeButton.classList.add("like-selected"),await le.addToFavorite(ye)),await me(!1)}})();
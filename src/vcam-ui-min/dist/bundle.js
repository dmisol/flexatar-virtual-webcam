(()=>{"use strict";class e{static DROP_PHOTO="ADD\n PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START";static CANCELED="CANCELED";static SUBSCRIPTION_END="NO SUBSCRIPTION";static DROP_BACKGROUND="ADD BACK GROUND"}const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];function a(e,t){for(const a of t)if(e==a)return!0;return!1}async function s(e,t,a,s,o,r,n){const i=await r(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},t);if(!i.ok)return{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const l=c.link;if(!await async function(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),!!(await fetch(e.url,{method:"POST",body:a})).ok}(l,a))return;let u=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return u+=1,void(u>10&&(clearInterval(t),e()));const s=await a.json();clearInterval(t),e(s)}),5e3)}))}async function o(e){const{currentUserId:t}=e?{currentUserId:e}:await chrome.storage.local.get({currentUserId:null});return t||{error:"not_authorized"}}const r={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list"};async function n(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r].concat(t);return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function i(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=t;return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function c(e,t){const a=await o(t);if(a.error)return a;const s=a+e,r={};r[s]=[];return(await chrome.storage.local.get(r))[s]}async function l(e){const t=await o();if(t.error)return t;const a=t+e;await chrome.storage.local.remove([a])}async function u(e){const t=await o();if(t.error)return t;const a=t+e;(await chrome.storage.local.get([a]))[a]}async function d(){for(const[e,t]of Object.entries(r))u(t)}const f="_src_img_",g="_is_queue_in_progress_",w="_src_background_",m="_current_id_background_";async function p(e,t,a,s){const r=await o(s);if(r.error)return r;const n={};n[r+e+t]=a;try{return await chrome.storage.local.set(n),{success:!0}}catch(e){return{error:"unknown"}}}async function h(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e+t,n={};n[r]=null;return(await chrome.storage.local.get(n))[r]}async function y(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e+t;await chrome.storage.local.remove([r])}async function _(e,t,a,s="id"){const o=await c(e,a);let r=t[s];r||(r=t);const n=o.filter((e=>(e[s]||e)!==r));await i(e,n,a)}async function I(e,t,a){let s=await c(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await y(f,t.id,a)}await i(e,s,a)}async function k(e,t,a,s){await _(e,a,s),await async function(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r],c=t.concat(i);return n[r]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],s)}const v="ftarcache";async function E(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function L(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const T="https://api.flexatar-sdk.com";async function B(e,t){const a=T+"/"+e.id;t||(t=e.token);const s={};try{const e=await S(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:b}:{error:F}}catch(e){return!1}}async function D(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}async function R(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,o=(await chrome.storage.local.get([s]))[s];if(o)return await(await fetch(o)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let r;if(t.ftar)r=await fetch(t.ftar,{method:"GET"});else{const a=await M(t.is_myx?G:e,t.id,{ftar:!0});r=await fetch(a.ftar,{method:"GET"})}if(!r.ok)return;const n=await r.arrayBuffer(),i=await P(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function P(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function C(e,t,a,s=0){const o=a+"_ftarpreview_"+e.id,r=(await chrome.storage.local.get([o]))[o];if(r)return await(await fetch(r)).arrayBuffer();{const t="myx@amial.com_ftarpreview_"+e.id,a=(await chrome.storage.local.get([t]))[t];if(a)return await(await fetch(a)).arrayBuffer()}return s<8?(await new Promise((e=>setTimeout(e,500))),await C(e,t,a,s+1)):void 0}async function x(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const o=await s.arrayBuffer(),r=await P(o),n={};return n[a]=r,await chrome.storage.local.set(n),o}async function S(e,t,a,s){t.headers.Authorization="Bearer "+await a.getToken();const o=await fetch(e,t);return 403!=o.status?o:(s||(s=2),s<=0?o:(s-=1,a.token=null,await S(e,t,a,s)))}const b="unauthorized",F="UNEXPECTED";async function A(e,t){const a=T+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const o=await S(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);if(!o.ok)return 401===o.status?{error:b}:{error:F};return(await o.json()).all}async function M(e,t,a){const s=T+"/list",o={"Content-Type":"application/json"},r=[];a.ftar&&r.push("ftar"),a.preview&&r.push("preview"),a.meta&&r.push("meta");const n={};n[t]=r;try{const a=await S(s,{method:"POST",headers:o,body:JSON.stringify(n)},e);if(!a.ok)return 401===a.status?{error:b}:{error:F};return(await a.json()).requested[t]}catch(e){}}async function U(e,t,a,o,r){a||(a="");const n=T+"/make",i=await s(n,e,t,a,0,S,r);if(!i)return{error:F};if(i.error)return 401===i.error.status?{error:b}:{error:F};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return o&&(c=o),await M(e,i.id,c)}async function O(e){const t=await S(T+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);if(!t.ok&&!t.ok)return 401===t.status?{error:b}:{error:F};return await t.json()}class N{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,t}}async function j(e,t){const a=await async function(e){const t=await new Promise((e=>{chrome.storage.local.get(null,e)}));return Object.keys(t).filter((t=>t.startsWith(e)))}(e),s={};for(const t of a){s[t.replaceAll(e,"")]=t}for(const{id:e}of t)delete s[e];const o=Object.values(s);o.length>0&&await chrome.storage.local.remove(o)}const G=new N((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}()));async function q(e,t,a,s=!1){const o=a+"_ftarlist";async function r(e,a){(async()=>{if(t.opts.preview)for(const t of e){await x(t,a);delete t.preview}})()}let n=t.opts.noCache?null:await L(o);if(t.opts.noCache=void 0,!n&&"myx@amial.com"===a&&s&&(n=await L(o),n||(n=await A(e,t.opts),r(n,a),await E(o,n))),!n){if(s&&("myx@amial.com"===a&&t.opts,n=await A(e,t.opts),n&&n.error))return n;if(n){n=n.reverse(),(async()=>{if(t.opts.preview)for(const e of n){await x(e,a);delete e.preview}})();const e=a+"_ftarpreview_";await j(e,n);const s=a+"_ftar_";await j(s,n),await E(o,n)}else n=[]}if("myx@amial.com"!==a&&s){const e="myx@amial.com_ftarlist";let a=await L(e);if(!a){const s=await async function(){return await A(G,t.opts)}();a=s,r(s,"myx@amial.com"),await E(e,s)}n=n.concat(a)}return n}async function Q(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}async function H(e){await K(e,await W(e)-1)}async function W(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function K(e,t){const a=e+"_FtarCount",s={};s[a]=t,await chrome.storage.local.set(s)}async function z(e,t){const a=await o(),s=await h(f,t.id,a);if(s){const o=function(e,t){const[a,s]=e.split(","),o=a.match(/:(.*?);/),r=o?o[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:r})}(s),n=await U(e,o,"noname",{ftar:!0,preview:!0},(async e=>{t.ftarId=e;await k(r.FTAR_MAKE_QUEUE_LIST_ID,r.FTAR_PROCESSING_QUEUE_LIST_ID,t,a);d()}));if(n.error||n.err){if(await k(r.FTAR_PROCESSING_QUEUE_LIST_ID,r.FTAR_ERROR_LIST_ID,t,a),await I(r.FTAR_ERROR_LIST_ID,5),"bad_photo"!==n.reason)return await p(g,"",!1),n}else{await k(r.FTAR_PROCESSING_QUEUE_LIST_ID,r.FTAR_SUCCESS_LIST_ID,t,a),await I(r.FTAR_SUCCESS_LIST_ID,5);try{await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await L(a);s.unshift({id:t}),await E(a,s)}(a,n.id),await x(n,a),await R(e,n,a)}catch{}}return d(),n}await p(g,"",!1)}async function Y(e,t){const a=await c(r.FTAR_MAKE_QUEUE_LIST_ID);if("not_authorized"===a.error)return{error:a.error};const s=await h(g,"");if(a.length>0&&s){return t(await z(e,a[0])),await Y(e,t)}return p(g,"",!1),{}}async function J(){const e={successImages:r.FTAR_SUCCESS_LIST_ID,errorImages:r.FTAR_ERROR_LIST_ID,queueImages:r.FTAR_MAKE_QUEUE_LIST_ID},t={};for(const[a,s]of Object.entries(e)){const e=(await c(s)).map((async e=>await h(f,e.id)));t[a]=await Promise.all(e)}const a=(await c(r.FTAR_PROCESSING_QUEUE_LIST_ID)).map((async e=>await h(f,e.id))),s=await Promise.all(a);s&&s.length>0&&t.queueImages.unshift(s[0]);const n=await o();return t.flexatarCount=await W(n),t.isQueueInProgress=await h(g,""),t}const X=new class{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}};class Z{constructor(e,t=!1,a=!1,s=!1){let o;a||(o=async function(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===e)var e=self;"undefined"==typeof chrome&&(e.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const t="flexatar-storage-cache",a=e=>new Request(`https://flexatar-mock-storage/${e}`),s=e=>new URL(e).pathname.slice(1),o=await caches.open(t);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const s=JSON.stringify({value:t}),r=new Response(s,{headers:{"Content-Type":"application/json"}});await o.put(a(e),r)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const r={};if(null==e){const e=(await o.keys()).map((e=>s(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const s=await o.match(a(t));if(s){const e=await s.json();r[t]=e.value}else r[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(r),r},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>o.delete(a(e))));await Promise.all(t)}}}()),this.tokenFn=e,this.needMyxAccount=s,this.token=new N((async()=>await e())),t&&o.then((()=>{[r.FTAR_ERROR_LIST_ID,r.FTAR_SUCCESS_LIST_ID,r.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((e=>{l(e)})),p(g,"",!1)}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}}}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{await X.enqueue((async()=>await t.getUserInfo()));const s=a.data;if(s)if(s.progressLists){s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await J();e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await p(g,"",!1);else if(s.clearMakeQueue){await l(r.FTAR_MAKE_QUEUE_LIST_ID),await l(r.FTAR_PROCESSING_QUEUE_LIST_ID);const t=await J();e.postMessage({progressLists:t})}else s.startMakeQueue&&(await p(g,"",!0),t.ftarQueueDelegate(t.token,(async a=>{a.err||a.error||await H(await o()),t.ports.forEach((e=>{e.postMessage({newFlexatar:a})}));const s=await J();e.postMessage({progressLists:s})})))}}async getUserInfo(e){const t=e&&e.noCache,{currentUserId:a}=await chrome.storage.local.get({currentUserId:null});if(a||(this.token.token=null),a&&!t){const e=a+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:a,FtarCount:t}}const s=await O(this.token);if(s.error)return s;const o=s.user_id;return await chrome.storage.local.set({currentUserId:o}),await K(o,s.FtarCount),s}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await X.enqueue((async()=>await t.getUserInfo()));await $(a,{managerPort:!0}),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=Y;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const s=a.data;if(s)if(await X.enqueue((async()=>await t.getUserInfo())),s.imagesList){const e=s.imagesList,a=e.map((e=>({id:e.id})));await n(r.FTAR_MAKE_QUEUE_LIST_ID,a);for(const{dataUrl:t,id:a}of e){await p(f,a,t)}await h(g,"")||(await p(g,"",!0),t.ftarQueueDelegate(t.token,(async e=>{e.err&&!e.error||await H(await o()),t.ports.forEach((t=>{t.postMessage({newFlexatar:e})})),t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await J()})}))}))),t.showProgress()}else s.needAuthorize?t.onNeedAuthorize():s.closing&&(t.lensPorts=t.lensPorts.filter((t=>t!==e)))}}onNeedAuthorize=()=>{};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const o=await X.enqueue((async()=>await t.getUserInfo()));if(o.error)return void e.postMessage({msgID:s.msgID,payload:o});const i=o.user_id;if(s.ftarList){const a=await q(t.token,s,i,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.backgroundsList){const t=s.opts??{};let a;a=t.id?[t.id]:await c(r.FTAR_BACKGROUND_LIST_ID,i);const o=[];for(const e of a){const t=await h(w,e,i);o.push([e,t])}e.postMessage({msgID:s.msgID,payload:o})}else if(s.preview){let a=await C({id:s.preview},t.token,i);if(!a)return void e.postMessage({msgID:s.msgID,payload:null});e.postMessage({msgID:s.msgID,payload:a},[a])}else if(s.flexatar){let t=await R(this.token,{id:s.flexatar,is_myx:s.is_myx},i);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});s.flexatar,s.setAsCurrent&&await async function(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}(s.flexatar,i),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.closing)t.ports=t.ports.filter((t=>t!==e)),e.close();else if(s.storeNewBackground){const t=await function(e,t){return new Promise((a=>{const s=crypto.randomUUID();c(r.FTAR_BACKGROUND_LIST_ID,t).then((o=>{n(r.FTAR_BACKGROUND_LIST_ID,[s],t).then((o=>{p(w,s,e,t).then((e=>{a(s)}))}))}))}))}(s.storeNewBackground,i);e.postMessage({msgID:s.msgID,payload:t}),e.postMessage({newBackGround:t})}else if(s.getCurrentBkg){let t=await h(m,"",i);if(!t){const e=await c(r.FTAR_BACKGROUND_LIST_ID,i);t=e[e.length-1]}t&&s.getCurrentBkg.dataUrl&&(t="no"===t?null:await h(w,t,i)),e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteBackground)_(r.FTAR_BACKGROUND_LIST_ID,s.deleteBackground,i),y(w,s.deleteBackground,i),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.setCurrentBkg)p(m,"",s.setCurrentBkg,i),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.currentFtar){s.opts={preview:!0};const a=await q(t.token,s,i,t.needMyxAccount),[o,r]=await async function(e,t){const a=e+"_currentFlexatarId";let s=(await chrome.storage.local.get([a]))[a];if(0===t.length)return[null,!1];for(const{id:e,is_myx:a}of t)if(e===s)return[s,a];const o={},r=t[0].id;return o[a]=r,await chrome.storage.local.set(o),[r,t[0].is_myx]}(i,a);e.postMessage({msgID:s.msgID,payload:{id:o,is_myx:r}})}else if(s.makeFlexatar)this.lensPorts.forEach((async e=>{await $(e,{managerPort:!0}),e.postMessage({imageBuffer:s.buffer},[s.buffer])})),e.postMessage({msgID:s.msgID,payload:{status:"ok"}});else if(s.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await L(a);const o=Object.keys(s).length;if(s=s.filter((({id:e})=>t!==e)),Object.keys(s).length===o){const e="myx@amial.com_ftarlist";let a=await L(e);return a=a.filter((({id:e})=>t!==e)),await E(e,a),{isAuthorized:!1}}return await E(a,s),{isAuthorized:!0}}(i,s.deleteFlexatar);if(t){const t=await B({id:s.deleteFlexatar,token:this.token});t&&(await D(s.deleteFlexatar,i),await Q(i)),e.postMessage({msgID:s.msgID,payload:{success:t}})}else await D(s.deleteFlexatar,"myx@amial.com"),await Q(i),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.userInfo)s.opts?e.postMessage({msgID:s.msgID,payload:await t.getUserInfo(s.opts)}):e.postMessage({msgID:s.msgID,payload:o});else if(s.decrementFtarCount)await K(i,o.FtarCount-1),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.effectStateResponse)t.effectPorts.forEach((e=>{e.postMessage(s)}));else if(s.showEffects)t.showEffects();else if(s.showProgress)t.showProgress();else if(s.getUserToken){const a=await t.tokenFn();e.postMessage({msgID:s.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}}function $(e,t){const a=ee();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(o){o.data&&o.data.msgID===a&&(s(o.data.payload),e.removeEventListener("message",t))})),e.postMessage(t)}))}class V{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=ee();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(o){o.data&&o.data.msgID===t&&(s(o.data.payload),a.removeEventListener("message",e))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t,a=!0){return await this.sendWithResponse({flexatar:e,is_myx:t,setAsCurrent:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>s({buffer:r.result,fileType:t,fileName:a}),r.onerror=e=>o(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}}function ee(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const te={Manager:Z,ManagerConnection:V,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(v);let o=await s.match(a);if(!o){const r=await M(e,t.id,{ftar:!0});if(o=await fetch(r.ftar,{method:"GET"}),!o.ok)return;const n=await o.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await o.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(v);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const o=await s.arrayBuffer(),r=new Response(new Uint8Array(o),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,r),o}return await s.arrayBuffer()},flexatarList:A,makeFlexatar:U,deleteFlexatar:B,flexatarEntry:M,userInfo:O,GetToken:N,ERR_UNAUTHORIZED:b,ERR_UNEXPECTED:F};if(void 0===ae)var ae=self;ae.Ftar=te;const se=new V;let oe;se.onEffectMessage=e=>{oe.postMessage(e)},se.onSlot2=e=>{e.slot2,oe.postMessage(e,[e.slot2])},se.onEffectStateRequest=e=>{re.then((t=>{t.postMessage(e)}))},window.parent.postMessage({ftarUIPort:se.outPort},"*",[se.outPort]);const re=new Promise((e=>{window.addEventListener("message",(t=>{t.data&&t.data.flexatarControllerPort?(t.data.flexatarControllerPort,oe=t.data.flexatarControllerPort,oe.onmessage=e=>{const t=e.data;t&&t.effectStateResponse&&se.sendEffectState(t)},e(oe)):t.data&&t.data.closing&&(oe&&(oe.postMessage({closing:!0}),oe.close(),oe=null),se.close())}))}));function ne(){reloadIcon.classList.remove("roating"),plusCircle.classList.add("rotated"),makeTextHolder.textContent=e.SUBSCRIPTION_END}confirmButton.onclick=async()=>{if(confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,Ce)noBackgroundButton!==Re&&(await se.deleteBackground(Re.id),Re&&Re.remove(),imageBackgroundContainer.firstElementChild?.click());else{const t=ge.element;await async function(e){return(await se.deleteFlexatar(e)).success}(ge.ftarId)&&(t.remove(),previewListHolder.children.length>0?t===ge.element&&previewListHolder.children[0]?.click():(ge.ftarId=null,emptyBlock.textContent=e.EMPTY))}trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),me=!me},reloadFtarListButton.onclick=async()=>{for(reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");previewListHolder.children.length>0;)previewListHolder.children[0]?.remove();const t=await se.getCurrentFtar();if(t){ge={ftarId:t.id};const e=await se.getList({preview:!0,noCache:!0});if(e.error)return void ne();for(const{id:t,is_myx:a}of e){const e=await se.getPreview(t),s=new Blob([e],{type:"image/jpg"}),o=URL.createObjectURL(s),{holder:r}=await we({id:t,is_myx:a},o)}}else emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1},trashButton.onclick=()=>{me?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),me=!me},reloadIcon.classList.add("roating"),se.onNewFlexatar=async e=>{if(e.error)return;const t=await se.getPreview(e.id),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:o}=await we({id:e.id,is_myx:e.is_myx},s,!0)},se.ready.then((async()=>{const t=await se.getCurrentFtar();if(t.error)ne();else{if(t){ge={ftarId:t.id};const e=await se.getList({preview:!0});if(e.error)return void ne();for(const{id:t,is_myx:a}of e){const e=await se.getPreview(t),s=new Blob([e],{type:"image/jpg"}),o=URL.createObjectURL(s),{holder:r}=await we({id:t,is_myx:a},o)}}else emptyBlock.textContent=e.EMPTY;reloadIcon.classList.remove("roating")}}));window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=e.ALLOW_AUDIO;const ie=window.location.search;new URLSearchParams(ie);let ce;function le(e,t){const a=document.createElement("input");ce=document.createElement("form"),ce.appendChild(a),a.type="file",a.accept="image/*",a.onchange=e=>t(e),e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),a.dataTransfer,e.classList.remove("hover");const s=a.dataTransfer.files;t({target:{files:s}})}}async function ue(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,o)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>s({buffer:r.result,fileType:t,fileName:a}),r.onerror=e=>o(e)}))}(e);return t.makeFtar=!0,await se.makeFlexatar(e)}!function(){const s=createFlexatarHolder,o=plusCircle,r=makeTextHolder;r.textContent=e.DROP_PHOTO;const n=makeOverlayElement;let i;le(s,(async s=>{let c=s.target.files[0];if(!c)return;i&&(i(),i=null);const l=(o.style.display="none",r.style.display="none",n.style.display="block",()=>{o.style.display="block",r.style.display="block",n.style.display="none"});if(!a(c.type,t))return u=e.NOT_PHOTO,o.classList.add("rotated"),r.textContent=u,i=()=>{o.classList.remove("rotated"),r.textContent=e.DROP_PHOTO},void l();var u;await ue(c);l(),ce.reset()}))}();const de={};let fe,ge;async function we(e,t,a){de[e.id]=e;const s=t,o=document.createElement("span");o.className="item-holder";const r=document.createElement("img");r.src=s,r.draggable=!1,r.style.cursor="pointer",r.style.display="block",r.style.width="100%",r.style.height="auto",r.style.margin="0px",r.style.padding="0px",r.style.boxSizing="border-box",r.style.lineHeight="0px",r.style.verticalAlign="top",r.style.objectFit="contain",o.appendChild(r),o.id=e.id;const n=document.createElement("span");return n.className="loader",a?previewListHolder.insertBefore(o,previewListHolder.firstChild):previewListHolder.appendChild(o),o.onclick=async()=>{if(fe&&fe.classList.remove("selected-item"),fe=o,o.classList.add("selected-item"),ge.ftarId===e.id)return;ge={element:o,ftarId:e.id},o.appendChild(n);const t=await se.getFlexatar(e.id,e.is_myx);oe&&oe.postMessage({slot1:t,id:e.id},[t]),n.remove()},ge&&ge.ftarId===e.id&&(ge.element=o,o.click()),{holder:o,previewImg:s}}trashButton.classList.remove("invisible");let me=!1;reloadFtarListButton.classList.remove("invisible");let pe,he,ye,_e=!1;document.addEventListener("mousedown",(e=>{ke&&clearInterval(ke),_e=!0,pe=e.screenY,he=window.scrollY}));let Ie,ke,ve=0,Ee=0,Le=0,Te=!1;function Be(){if(_e=!1,ve=0,ye&&clearInterval(ye),document.body.style.pointerEvents="auto",!Te)return;Te=!1,he=window.scrollY,Ee=.5*Le,ke=setInterval((()=>{he+=Ee,window.scrollTo(0,he),Ee*=.9,Math.abs(Ee)<1&&clearInterval(ke)}),50);const e=ke;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{_e&&(e.preventDefault(),Ie=pe-e.screenY,!Te&&Math.abs(Ie)<10||(Te||(Le=0,ye=setInterval((()=>{Ee=Ie-ve,ve=Ie,Le=.5*(Le+Ee)}),100)),Te=!0,document.body.style.pointerEvents="none",window.scrollTo(0,he+Ie)))})),document.addEventListener("mouseup",Be),document.addEventListener("mouseleave",Be),expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")};const De=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let Re,Pe=AllEmo;Pe.classList.add("color-emo-selected");for(const e of De)e.onclick=()=>{Pe.classList.remove("color-emo-selected"),Pe=e,Pe.classList.add("color-emo-selected"),oe&&oe.postMessage({animation:{pattern:e.id}})};AllEmo.onclick=()=>{Pe.classList.remove("color-emo-selected"),Pe=AllEmo,Pe.classList.add("color-emo-selected"),oe&&oe.postMessage({animation:{pattern:null}})};let Ce=!1;function xe(e,t,a=!1){const s=document.createElement("img");return s.id=e,s.src=t,s.draggable=!1,s.style.cursor="pointer",s.style.display="block",s.style.width="100%",s.style.height="auto",s.style.margin="0px",s.style.padding="0px",s.style.boxSizing="border-box",s.style.lineHeight="0px",s.style.verticalAlign="top",s.style.objectFit="contain",a?function(e,t){if(!t.nextSibling)return void t.parentNode.appendChild(e);t.parentNode.insertBefore(e,t.nextSibling)}(s,noBackgroundButton):imageBackgroundContainer.appendChild(s),s.onclick=()=>{Re&&Re.classList.remove("selected-item"),Re=s,s.classList.add("selected-item"),oe&&oe.postMessage({background:t}),se.setCurrentBackground(e)},s}expandBkgButton.onclick=async()=>{if(Ce)expandBkgButton.classList.add("rot180"),dropBackgroundContainer.classList.add("invisible"),imageBackgroundContainer.querySelectorAll("img").forEach((e=>e.remove())),bkgExpander.classList.remove("full-height");else{expandBkgButton.classList.remove("rot180"),dropBackgroundContainer.classList.remove("invisible"),dropBackgroundText.textContent=e.DROP_BACKGROUND,bkgExpander.classList.add("full-height");const t=(await se.getBackgrounds()).reverse();for(const[e,a]of t)a&&xe(e,a);const a=await se.getCurrentBackground();document.getElementById(a)?document.getElementById(a)?.click():noBackgroundButton.click()}Ce=!Ce},noBackgroundButton.onclick=()=>{noBackgroundButton.classList.add("selected-item"),Re&&Re.classList.remove("selected-item"),Re=noBackgroundButton,oe&&oe.postMessage({background:!0,no:!0}),se.setCurrentBackground("no")},le(dropBkgElement,(async e=>{let s=e.target.files[0];if(!s)return;if(!a(s.type,t))return;const o=await async function(e,t,a){const s=await createImageBitmap(e),o=new OffscreenCanvas(t,a),r=o.getContext("2d"),n=s.width/s.height;let i,c,l,u;n>t/a?(c=a,i=s.width*(a/s.height),l=-(i-t)/2,u=0):(i=t,c=s.height*(t/s.width),l=0,u=-(c-a)/2);r.drawImage(s,l,u,i,c);const d=await o.convertToBlob(),f=await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(d)}));return f}(s,480,640);await se.storeNewBackground(o)})),se.onNewBackground=async e=>{xe(e,(await se.getBackgrounds({id:e}))[0][1],!0).click()},ftarLogButton.onclick=e=>{se.showProgress()},effectsButton.onclick=()=>{se.showEffects()}})();
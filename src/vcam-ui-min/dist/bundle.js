(()=>{"use strict";class e{static DROP_PHOTO="ADD\n PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START";static CANCELED="CANCELED";static SUBSCRIPTION_END="NO SUBSCRIPTION";static DROP_BACKGROUND="ADD BACK GROUND"}const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];function a(e,t){for(const a of t)if(e==a)return!0;return!1}async function s(e,t,a,s,r,o,n){const i=await o(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})},t);if(!i.ok)return{error:{status:i.status}};const c=await i.json();if(c.block)return{success:!1,reason:c.block};n&&await n(c.id);const l=c.link;if(!await async function(e,t){const a=new FormData;return Object.entries(e.fields).forEach((([e,t])=>{a.append(e,t)})),a.append("file",t),!!(await fetch(e.url,{method:"POST",body:a})).ok}(l,a))return;let u=0;return await new Promise((e=>{const t=setInterval((async()=>{const a=await fetch(c.poll,{method:"GET"});if(!a.ok)return u+=1,void(u>10&&(clearInterval(t),e()));const s=await a.json();clearInterval(t),e(s)}),5e3)}))}class r{constructor(){this.queue=[],this.isProcessing=!1}async enqueue(e){return new Promise(((t,a)=>{this.queue.push({task:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{task:e,resolve:t,reject:a}=this.queue.shift();try{t(await e())}catch(e){a(e)}this.isProcessing=!1,this.processQueue()}}async function o(e,t="currentUserId"){if(e)return e;const a={};a[t]=null;const s=await chrome.storage.local.get(a);return s?s[t]:{error:"not_authorized"}}const n={FTAR_MAKE_QUEUE_LIST_ID:"_make_queue",FTAR_PROCESSING_QUEUE_LIST_ID:"_processing_queue",FTAR_ERROR_LIST_ID:"_error_queue",FTAR_SUCCESS_LIST_ID:"_success_queue",FTAR_BACKGROUND_LIST_ID:"_background_list",FTAR_PRESET_LIST_ID:"_preset_list",FTAR_SENDING_REQUEST_QUEUE_LIST_ID:"_sending_request_queue"};async function i(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r].concat(t);return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function c(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=t;return n[r]=i,await chrome.storage.local.set(n),{success:!0}}async function l(e,t){const a=await o(t);if(a.error)return a;const s=a+e,r={};r[s]=[];return(await chrome.storage.local.get(r))[s]}async function u(e,t){const a=await o(t);if(a.error)return a;const s=a+e;await chrome.storage.local.remove([s])}async function d(e,t){const a=await o(t);if(a.error)return a;const s=a+e;(await chrome.storage.local.get([s]))[s]}async function g(e){for(const[t,a]of Object.entries(n))d(a,e)}const f={FTAR_SRC_IMG:"_src_img_",IS_QUEUE_IN_PROGRESS:"_is_queue_in_progress_",BACKGROUND_SRC_IMAGE:"_src_background_",BACKGROUND_CURRENT_ID:"_current_id_background_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",CURRENT_VIEWPORT_SIZE:"_current_viewport_size_",RETARGETING_CALIBRATION:"_retargeting_calibration_"};async function w(e,t,a,s){const r=await o(s);if(r.error)return r;const n={};n[r+e+t]=a;try{return await chrome.storage.local.set(n),{success:!0}}catch(e){return{error:"unknown"}}}async function m(e,t,a,s=null){const r=await o(a);if(r.error)return r;const n=r+e+t,i={};i[n]=null;const c=await chrome.storage.local.get(i);return null===c[n]?s:c[n]}async function p(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e+t;await chrome.storage.local.remove([r])}async function h(e,t,a,s="id"){const r=await l(e,a);let o=t[s];o||(o=t);const n=r.filter((e=>(e[s]||e)!==o));await c(e,n,a)}async function I(e,t,a){let s=await l(e,a);if(s.length>t){const e=s.slice(t,s.length);s=s.slice(0,t);for(const t of e)await p(f.FTAR_SRC_IMG,t.id,a)}await c(e,s,a)}async function _(e,t,a,s){await h(e,a,s),await async function(e,t,a){const s=await o(a);if(s.error)return s;const r=s+e,n={};n[r]=[];const i=(await chrome.storage.local.get(n))[r],c=t.concat(i);return n[r]=c,await chrome.storage.local.set(n),{success:!0}}(t,[a],s)}function y(e,t){return new Promise((a=>{const s=crypto.randomUUID();l(n.FTAR_BACKGROUND_LIST_ID,t).then((r=>{i(n.FTAR_BACKGROUND_LIST_ID,[s],t).then((r=>{w(f.BACKGROUND_SRC_IMAGE,s,e,t).then((e=>{a(s)}))}))}))}))}async function E(){if("undefined"==typeof chrome||void 0===chrome.runtime||void 0===chrome.runtime.id){if(void 0===e)var e=self;"undefined"==typeof chrome&&(e.chrome={}),chrome.storage||(chrome.storage={}),chrome.storage.local||(chrome.storage.local={});const t="flexatar-storage-cache",a=e=>new Request(`https://flexatar-mock-storage/${e}`),s=e=>new URL(e).pathname.slice(1),r=await caches.open(t);chrome.storage.local.set=async e=>{const t=Object.entries(e).map((async([e,t])=>{const s=JSON.stringify({value:t}),o=new Response(s,{headers:{"Content-Type":"application/json"}});await r.put(a(e),o)}));await Promise.all(t)},chrome.storage.local.get=async(e,t)=>{const o={};if(null==e){const e=(await r.keys()).map((e=>s(e.url)));return t&&t(e),e}const n=(Array.isArray(e)?e:"object"==typeof e&&null!==e?Object.keys(e):"string"==typeof e?[e]:[]).map((async t=>{const s=await r.match(a(t));if(s){const e=await s.json();o[t]=e.value}else o[t]="object"==typeof e&&null!==e?e[t]:void 0}));return await Promise.all(n),t&&t(o),o},chrome.storage.local.remove=async e=>{const t=(Array.isArray(e)?e:[e]).map((e=>r.delete(a(e))));await Promise.all(t)}}}const R="ftarcache";async function T(e,t){const{strings:a}=await chrome.storage.local.get({strings:{}});a[e]=t,await chrome.storage.local.set({strings:a})}async function S(e){const{strings:t}=await chrome.storage.local.get({strings:{}});return t[e]}const k="https://api.flexatar-sdk.com";async function D(e,t){const a=k+"/"+e.id;t||(t=e.token);const s={};try{const e=await L(a,{method:"DELETE",headers:s},t);return e.ok?e.ok:401===e.status?{error:A}:{error:B}}catch(e){return!1}}async function v(e,t,a){if("default"===t.id)return await(await fetch("https://flexatar-sdk.com/files/default_ftar.p")).arrayBuffer();const s=a+"_ftar_"+t.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();{const e="myx@amial.com_ftar_"+t.id,a=(await chrome.storage.local.get([e]))[e];if(a)return await(await fetch(a)).arrayBuffer()}let o;if(t.ftar)o=await fetch(t.ftar,{method:"GET"});else{const a=await F(t.is_myx?G:e,t.id,{ftar:!0});o=await fetch(a.ftar,{method:"GET"})}if(!o.ok)return;const n=await o.arrayBuffer(),i=await C(n),c={};return c[s]=i,await chrome.storage.local.set(c),n}function C(e,t="application/octet-stream"){const a=new Blob([e],{type:t});return new Promise(((e,t)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.onerror=t,s.readAsDataURL(a)}))}async function P(e,t){const a=t+"_ftarpreview_"+e.id;let s=await fetch(e.preview,{method:"GET"});if(!s.ok)return;const r=await s.arrayBuffer(),o=await C(r),n={};return n[a]=o,await chrome.storage.local.set(n),r}async function L(e,t,a,s){t.headers.Authorization="Bearer "+await a.getToken();const r=await fetch(e,t);return 403!=r.status?r:(s||(s=2),s<=0?r:(s-=1,a.token=null,await L(e,t,a,s)))}const A="unauthorized",B="UNEXPECTED";async function U(e,t){const a=k+"/list",s=[];t.ftar&&s.push("ftar"),t.preview&&s.push("preview"),t.meta&&s.push("meta");const r=await L(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({all:s})},e);if(!r.ok)return 401===r.status?{error:A}:{error:B};return(await r.json()).all}async function F(e,t,a){const s=k+"/list",r={"Content-Type":"application/json"},o=[];a.ftar&&o.push("ftar"),a.preview&&o.push("preview"),a.meta&&o.push("meta");const n={};n[t]=o;try{const a=await L(s,{method:"POST",headers:r,body:JSON.stringify(n)},e);if(!a.ok)return 401===a.status?{error:A}:{error:B};return(await a.json()).requested[t]}catch(e){}}async function M(e,t,a,r,o){a||(a="");const n=k+"/make",i=await s(n,e,t,a,0,L,o);if(!i)return{error:B};if(i.error)return 401===i.error.status?{error:A}:{error:B};if(!i.success){let e=i.reason;return e||(e="bad_photo"),{err:!0,reason:e}}let c={ftar:!0,meta:!0};return r&&(c=r),await F(e,i.id,c)}async function N(e){const t=await L(k+"/info",{method:"GET",headers:{"Content-Type":"application/json"}},e);if(!t.ok)return 401===t.status?{error:A}:{error:B};return await t.json()}class x{constructor(e){this.getTokenFunc=e}#e;async getToken(){if(this.token)return this.token;let e=this.#e;this.#e||(this.#e=this.getTokenFunc(),e=this.#e);const t=await e;return this.token=t,this.#e=null,t}}async function O(e,t,a,s=!0){let r=await l(e,a);return r=r.map((e=>{const s={userId:a};return s[t]=e,s})),"myx@amial.com"!==a&&s&&(r=r.concat((await l(e,"myx@amial.com")).map((e=>{const a={userId:"myx@amial.com"};return a[t]=e,a})))),r}async function b(e,t,a,s=!0){let r=[];if("myx@amial.com"===a)t.opts.noCache=!1,r=await W(G,t,a,!1),r=r.reverse();else if(r=await W(e,t,a,!1),r=r.reverse(),s){t.opts.noCache=!1;const e=await W(G,t,"myx@amial.com",!1);r=r.concat(e.reverse())}return r}const G=new x((async()=>await async function(){try{const e=await fetch("https://api.flexatar-sdk.com/myxtoken");if(!e.ok)return;const t=await e.json();if(!t.token)return;return t.token}catch(e){return}}())),Q=new r;async function W(e,t,a,s=!1){return await Q.enqueue((async()=>{const s=a+"_ftarlist";let r=t.opts.noCache?null:await S(s);return r||(r=await U(e,t.opts),r.error?r.error:await T(s,r)),r.forEach((e=>{e.userId=a})),r}))}async function K(e,t){const a={};a[t+"_currentFlexatarId"]=e,await chrome.storage.local.set(a)}async function j(e,t){const a={};a[t+"_currentFlexatarIdSlot2"]=e,await chrome.storage.local.set(a)}async function q(e){const t=e+"_currentFlexatarIdSlot2";return(await chrome.storage.local.get([t]))[t]}async function H(e){const t=e+"_currentFlexatarId";return(await chrome.storage.local.get([t]))[t]}async function z(e){await Y(e,await V(e)-1)}async function V(e){const t=e+"_FtarCount";return(await chrome.storage.local.get([t]))[t]}async function Y(e,t){const a=e+"_FtarCount",s={};s[a]=t,await chrome.storage.local.set(s)}async function J(e,t,a){const s=await o(null,a),r=await m(f.FTAR_SRC_IMG,t.id,s);if(r){const a=function(e,t){const[a,s]=e.split(","),r=a.match(/:(.*?);/),o=r?r[1]:"application/octet-stream",n=atob(s),i=Uint8Array.from(n,(e=>e.charCodeAt(0)));return new File([i],t,{type:o})}(r),o=(await _(n.FTAR_MAKE_QUEUE_LIST_ID,n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,t,s),await M(e,a,"noname",{ftar:!0,preview:!0},(async e=>{t.ftarId=e;await _(n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,n.FTAR_PROCESSING_QUEUE_LIST_ID,t,s);g(s)})));if(o.error||o.err){if("queue_limit"===o.reason)return o;const e=await l(n.FTAR_PROCESSING_QUEUE_LIST_ID,s);await _(e.length>0?n.FTAR_PROCESSING_QUEUE_LIST_ID:n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,n.FTAR_ERROR_LIST_ID,t,s),await I(n.FTAR_ERROR_LIST_ID,5,s)}else{await _(n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_SUCCESS_LIST_ID,t,s),await I(n.FTAR_SUCCESS_LIST_ID,5,s);try{await async function(e,t){if(!t)return;const a=e+"_ftarlist";let s=await S(a);s.push({id:t}),await T(a,s)}(s,o.id),await P(o,s),await v(e,o,s)}catch{}}return o.userId=s,g(s),o}}async function Z(e,t,a){const s=await o(null,a),r=await l(n.FTAR_MAKE_QUEUE_LIST_ID,s);if("not_authorized"===r.error)return{error:r.error};const i=await l(n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID,s),c=await l(n.FTAR_PROCESSING_QUEUE_LIST_ID,s),u=await m(f.IS_QUEUE_IN_PROGRESS,"",s,!0);if(0!==i.length||0!==c.length||!u)return{};if(r.length>0){const s=await J(e,r[0],a);return t(s),await Z(e,t,a)}return{}}async function X(e){const t={successImages:n.FTAR_SUCCESS_LIST_ID,errorImages:n.FTAR_ERROR_LIST_ID,queueImages:n.FTAR_MAKE_QUEUE_LIST_ID},a="currentUserId",s=await o(null,a),r={};for(const[e,a]of Object.entries(t)){const t=await l(a,s),o=t.map((async e=>await m(f.FTAR_SRC_IMG,e.id,s)));r[e]=await Promise.all(o)}const i=[n.FTAR_PROCESSING_QUEUE_LIST_ID,n.FTAR_SENDING_REQUEST_QUEUE_LIST_ID];for(const e of i){const t=(await l(e,s)).map((async e=>await m(f.FTAR_SRC_IMG,e.id,s))),a=await Promise.all(t);a&&a.length>0&&r.queueImages.unshift(a[0])}return r.flexatarCount=await V(s),r.isQueueInProgress=await m(f.IS_QUEUE_IN_PROGRESS,"",s,!0),r}const $=new r;class ee{static clearCurrentUserId(){const e={currentUserId:null};chrome.storage.local.set(e)}constructor(e,t,a=async()=>[],s=!1,r=!1,i=!0){let c;r||(c=E(),this.patchPromise=c),this.defaultBackgroundFn=a,this.managerName=t,this.userIdKey=()=>"currentUserId",this.tokenFn=e,this.needMyxAccount=i,this.token=new x((async()=>await e()));const l=this;s&&(c||Promise.resolve()).then((async()=>{for(;!l.managerName;)await new Promise((e=>setTimeout(e,200)));const e=await o(null,l.userIdKey());[n.FTAR_ERROR_LIST_ID,n.FTAR_SUCCESS_LIST_ID,n.FTAR_PROCESSING_QUEUE_LIST_ID].forEach((t=>{u(t,e)}))}))}showEffects(){this.effectPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}effectPorts=[];addEffectPort(e){const t=this;this.effectPorts.push(e),e.onmessage=async e=>{const a=e.data;if(a)if(a.managerConnectionPort)t.addPort(a.managerConnectionPort);else if(a.mediaPort)t.onMediaPort(a.mediaPort);else if(a.isEffectMessage)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.effectStateRequest)t.ports.forEach((e=>{e.postMessage(a)}));else if(a.slot2){const e=a.slot2;t.ports.forEach((t=>{const s=e.slice(0);a.slot2=s,t.postMessage(a,[a.slot2])}))}else if(a.slot1){const e=a.slot1;t.ports.forEach((t=>{const s=e.slice(0);a.slot1=s,t.postMessage(a,[a.slot1])}))}}}showRetarg(){this.retargPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}retargPorts=[];addRetargPort(e){const t=this;this.retargPorts.push(e),e.onmessage=async e=>{const a=e.data;a&&(a.managerConnectionPort?t.addPort(a.managerConnectionPort):a.mediaPort&&t.onMediaPort(a.mediaPort))}}showProgress(){this.progressPorts.forEach((e=>{e.postMessage({managerPort:!0})}))}progressPorts=[];addProgressPort(e){const t=this;this.progressPorts.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const r=await $.enqueue((async()=>await t.getUserInfo())),o=r.user_id;if(s.progressLists){s.reloadFtarCount&&await t.getUserInfo({noCache:!0});const a=await X(t.managerName);e.postMessage({progressLists:a})}else if(s.pauseMakeQueue)await w(f.IS_QUEUE_IN_PROGRESS,"",!1,o);else if(s.clearMakeQueue){await u(n.FTAR_MAKE_QUEUE_LIST_ID,o);const a=await X(t.managerName);e.postMessage({progressLists:a})}else s.startMakeQueue&&(await w(f.IS_QUEUE_IN_PROGRESS,"",!0,o),t.ftarQueueDelegate(t.token,(async a=>{a.err||a.error||(await z(o),t.ports.forEach((e=>{e.postMessage({newFlexatar:a})})));const s=await X(t.managerName);e.postMessage({progressLists:s})}),t.userIdKey()))}}async getUserInfo(e){const t=e&&e.noCache;this.patchPromise&&await this.patchPromise;const a="currentUserId",s={};s[a]=null;const r=(await chrome.storage.local.get(s))[a];if(r||(this.token.token=null),r&&!t){const e=r+"_FtarCount",t=(await chrome.storage.local.get([e]))[e];if(null!=t)return{user_id:r,FtarCount:t}}let o=await N(this.token);if(o.error&&(o=await N(G),o.error))return o;const n=o.user_id,i={};return i[a]=n,await chrome.storage.local.set(i),await Y(n,o.FtarCount),o}ports=[];portsMustBeDeleted=[];async handShakePorts(){for(const e of this.ports){const t=setTimeout((()=>{this.portsMustBeDeleted.push(e),e.removeEventListener("message",a)}),5e3);function a(s){s.data&&s.data.handShake&&(clearTimeout(t),e.removeEventListener("message",a))}e.addEventListener("message",a),e.postMessage({handShake:!0})}}makeFtar(e){const t=this;this.lensPorts.forEach((async a=>{const s=await $.enqueue((async()=>await t.getUserInfo()));await te(a,{managerPort:!0}),s.error?a.postMessage({needAuthorize:!0},[e]):a.postMessage({imageBuffer:e},[e])}))}lensPorts=[];ftarQueueDelegate=Z;addFtarLens(e){const t=this;this.lensPorts.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;await $.enqueue((async()=>await t.getUserInfo()));if(s.imagesList){const e=s.imagesList,a=e.map((e=>({id:e.id}))),r=await o(null,t.userIdKey()),c="myx@amial.com"===r?G:t.token;await i(n.FTAR_MAKE_QUEUE_LIST_ID,a,r);for(const{dataUrl:t,id:a}of e){await w(f.FTAR_SRC_IMG,a,t,r)}t.ftarQueueDelegate(c,(async e=>{e.err&&!e.error||(await z(await o(null,t.userIdKey())),e.userId=r,t.ports.forEach((t=>{t.postMessage({newFlexatar:e})}))),t.progressPorts.forEach((async e=>{e.postMessage({progressLists:await X(t.managerName)})}))}),t.userIdKey()),t.showProgress()}else s.needAuthorize?t.onNeedAuthorize():s.closing&&(t.lensPorts=t.lensPorts.filter((t=>t!==e)))}}onNeedAuthorize=()=>{};addPort(e){const t=this;for(const e of this.portsMustBeDeleted)t.ports=t.ports.filter((t=>t!==e));this.portsMustBeDeleted=[],this.ports.push(e),e.onmessage=async a=>{const s=a.data;if(!s)return;const r=await $.enqueue((async()=>await t.getUserInfo()));if(r.error)return void e.postMessage({msgID:s.msgID,payload:r});const o=r.user_id,c={};if(c[o]=t.token,c["myx@amial.com"]=G,s.ftarList){const a=await b(t.token,s,o,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.backgroundsList){if("empty"===t.managerName)return void e.postMessage({msgID:s.msgID,payload:[]});const a=s.opts??{};let r;if(r=a.id?[{id:a.id,userId:a.userId}]:await O(n.FTAR_BACKGROUND_LIST_ID,"id",o,t.needMyxAccount),!r||0===r.length){const e=await t.defaultBackgroundFn();for(const t of e)await y(t,o);r=await O(n.FTAR_BACKGROUND_LIST_ID,"id",o,t.needMyxAccount)}const i=[];for(const{id:e,userId:t}of r){const a=await m(f.BACKGROUND_SRC_IMAGE,e,t);i.push([{id:e,userId:t},a])}e.postMessage({msgID:s.msgID,payload:i})}else if(s.preview){s.preview;let t=await async function(e,t,a){const s=a+"_ftarpreview_"+e.id,r=(await chrome.storage.local.get([s]))[s];if(r)return await(await fetch(r)).arrayBuffer();if(e.preview){const t=await P(e,a);if(t)return t}const o=await F(t,e.id,{preview:!0});return e.preview=o.preview,await P(e,a)}({id:s.preview.id},c[s.preview.userId],s.preview.userId);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.flexatar){s.flexatar;let t=await v(c[s.flexatar.userId],{id:s.flexatar.id,is_myx:!1},s.flexatar.userId);if(!t)return void e.postMessage({msgID:s.msgID,payload:null});s.setAsCurrent&&(s.flexatar,await K(s.flexatar,o)),s.setAsCurrentSlot2&&(s.flexatar,await j(s.flexatar,o)),e.postMessage({msgID:s.msgID,payload:t},[t])}else if(s.closing)t.ports=t.ports.filter((t=>t!==e)),e.close();else if(s.storeNewBackground){const t=await y(s.storeNewBackground,o);e.postMessage({msgID:s.msgID,payload:{id:t,userId:o}}),e.postMessage({newBackGround:{id:t,userId:o}})}else if(s.getCurrentBkg){let t=await m(f.BACKGROUND_CURRENT_ID,"",o);t||(t=await m(f.BACKGROUND_CURRENT_ID,"","myx@amial.com")),t&&s.getCurrentBkg.dataUrl&&(t="no"===t.id?null:await m(f.BACKGROUND_SRC_IMAGE,t.id,t.userId)),e.postMessage({msgID:s.msgID,payload:t})}else if(s.deleteBackground)h(n.FTAR_BACKGROUND_LIST_ID,s.deleteBackground,o),p(f.BACKGROUND_SRC_IMAGE,s.deleteBackground,o),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.setCurrentBkg)w(f.BACKGROUND_CURRENT_ID,"",s.setCurrentBkg,o),e.postMessage({msgID:s.msgID,payload:{result:"success"}});else if(s.getSelectedFtar){const t=o+"_selectedFlexatarId";let a=(await chrome.storage.local.get([t]))[t];e.postMessage({msgID:s.msgID,payload:{selectedFtar:a}})}else if(s.setSelectedFtar)!async function(e,t){const a={};a[t+"_selectedFlexatarId"]=e,await chrome.storage.local.set(a)}(s.setSelectedFtar.value,o),e.postMessage({msgID:s.msgID,payload:{}});else if(s.currentFtarSlot2){s.opts={preview:!0};let a=await q(o);if(!a){const e=await b(t.token,s,o,t.needMyxAccount);await j(e[0],o)}a=await q(o),e.postMessage({msgID:s.msgID,payload:a})}else if(s.currentFtar){s.opts={preview:!0};let a=await H(o);if(!a){const e=await b(t.token,s,o,t.needMyxAccount);await K(e[0],o)}a=await H(o),e.postMessage({msgID:s.msgID,payload:a})}else if(s.makeFlexatar)this.lensPorts.forEach((async e=>{await te(e,{managerPort:!0}),e.postMessage({imageBuffer:s.buffer},[s.buffer])})),e.postMessage({msgID:s.msgID,payload:{status:"ok"}});else if(s.deleteFlexatar){const{isAuthorized:t}=await async function(e,t){const a=e+"_ftarlist";let s=await S(a);return s=s.filter((({id:e})=>t!==e)),await T(a,s),{isAuthorized:!0}}(o,s.deleteFlexatar),a="myx@amial.com"===o||await D({id:s.deleteFlexatar,token:this.token});a&&(await async function(e,t){const a=t+"_ftar_"+e,s=t+"_ftarpreview_"+e;await chrome.storage.local.remove([a,s])}(s.deleteFlexatar,o),await async function(e){await chrome.storage.local.remove([e+"_currentFlexatarId"])}(o)),e.postMessage({msgID:s.msgID,payload:{success:a}})}else if(s.userInfo)s.opts?e.postMessage({msgID:s.msgID,payload:await t.getUserInfo(s.opts)}):e.postMessage({msgID:s.msgID,payload:r});else if(s.decrementFtarCount)await Y(o,r.FtarCount-1),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.effectStateResponse)t.effectPorts.forEach((e=>{e.postMessage(s)}));else if(s.showRetarg)t.showRetarg();else if(s.showEffects)t.showEffects();else if(s.showProgress)t.showProgress();else if(s.setRetargetingStatus)await w(f.RETARGETING_STATUS,"",s.setRetargetingStatus,o),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingStatus){let t=await m(f.RETARGETING_STATUS,"",o);e.postMessage({msgID:s.msgID,payload:t?t.value:null})}else if(s.setRetargetingCalibration)await w(f.RETARGETING_CALIBRATION,"",s.setRetargetingCalibration,o),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getRetargetingCalibration){let t=await m(f.RETARGETING_CALIBRATION,"",o);e.postMessage({msgID:s.msgID,payload:t})}else if(s.setViewportSize)await w(f.CURRENT_VIEWPORT_SIZE,"",s.setViewportSize,o),e.postMessage({msgID:s.msgID,payload:{success:!0}});else if(s.getViewportSize){let t=await m(f.CURRENT_VIEWPORT_SIZE,"",o,{width:320,height:640});e.postMessage({msgID:s.msgID,payload:t||{width:640,height:480}})}else if(s.deleteEffectPreset){const t=(await l(n.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId)).filter((e=>e.presetId!==s.deleteEffectPreset.presetId));await u(n.FTAR_PRESET_LIST_ID,s.deleteEffectPreset.userId),await i(n.FTAR_PRESET_LIST_ID,t,s.deleteEffectPreset.userId),e.postMessage({msgID:s.msgID,payload:{success:!0}})}else if(s.getEffectPresets){const a=await O(n.FTAR_PRESET_LIST_ID,"presetInfo",o,t.needMyxAccount);e.postMessage({msgID:s.msgID,payload:a})}else if(s.saveEffectPreset)await i(n.FTAR_PRESET_LIST_ID,[s.saveEffectPreset],o),e.postMessage({msgID:s.msgID,payload:{success:{userId:o}}});else if(s.getManagerName)e.postMessage({msgID:s.msgID,payload:t.managerName});else if(s.getUserToken){const a="myx@amial.com"===o?await G.getToken():await t.tokenFn();e.postMessage({msgID:s.msgID,payload:a})}},e.postMessage({ready:!0}),this.handShakePorts()}newBackgroundCreated(e){this.ports.forEach((t=>{t.postMessage({newBackGround:e})}))}}function te(e,t){const a=se();return t.msgID=a,new Promise((s=>{e.addEventListener("message",(function t(r){r.data&&r.data.msgID===a&&(s(r.data.payload),e.removeEventListener("message",t))})),e.postMessage(t)}))}class ae{constructor(){const e=new MessageChannel;this.port=e.port1,this.port.start(),this.outPort=e.port2,this.onNewBackground=()=>{},this.onNewFlexatar=()=>{},e.port1.onmessage=t=>{t.data&&t.data.handShake?e.port1.postMessage(t.data):t.data&&t.data.newBackGround?this.onNewBackground&&this.onNewBackground(t.data.newBackGround):t.data&&t.data.isEffectMessage?this.onEffectMessage&&this.onEffectMessage(t.data):t.data&&t.data.slot2?this.onSlot2&&this.onSlot2(t.data):t.data&&t.data.slot1?this.onSlot1&&this.onSlot1(t.data):t.data&&t.data.effectStateRequest?this.onEffectStateRequest&&this.onEffectStateRequest(t.data):t.data&&t.data.newFlexatar&&this.onNewFlexatar&&this.onNewFlexatar(t.data.newFlexatar)},this.ready=new Promise((t=>{e.port1.addEventListener("message",(function a(s){s.data&&s.data.ready&&(t(),e.port1.removeEventListener("message",a))}))}))}sendWithResponse(e){const t=se();e.msgID=t;const a=this.port;return new Promise((s=>{a.addEventListener("message",(function e(r){r.data&&r.data.msgID===t&&(s(r.data.payload),a.removeEventListener("message",e))})),a.postMessage(e)}))}async getList(e){return e||(e={}),await this.sendWithResponse({ftarList:!0,opts:e})}async getBackgrounds(e){return e||(e={}),await this.sendWithResponse({backgroundsList:!0,opts:e})}async getPreview(e){return await this.sendWithResponse({preview:e})}async getFlexatar(e,t=!0,a=!0){return await this.sendWithResponse({flexatar:e,setAsCurrent:t,setAsCurrentSlot2:a})}close(){this.port.postMessage({closing:!0}),this.port.close()}async getCurrentFtar(){return await this.sendWithResponse({currentFtar:!0})}async getCurrentFtarSlot2(){return await this.sendWithResponse({currentFtarSlot2:!0})}async getSelectedFtar(){return await this.sendWithResponse({getSelectedFtar:!0})}async setSelectedFtar(e){return await this.sendWithResponse({setSelectedFtar:{value:e}})}async setCurrentBackground(e){return await this.sendWithResponse({setCurrentBkg:e})}async deleteBackground(e){return await this.sendWithResponse({deleteBackground:e})}async getCurrentBackground(e={id:!0}){return await this.sendWithResponse({getCurrentBkg:e})}async storeNewBackground(e){return await this.sendWithResponse({storeNewBackground:e})}async makeFlexatar(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFlexatar=!0,await this.sendWithResponse(t,[t.buffer])}async deleteFlexatar(e){return await this.sendWithResponse({deleteFlexatar:e})}async userInfo(e){return await this.sendWithResponse({userInfo:!0,opts:e})}async decrementFtarCount(){return await this.sendWithResponse({decrementFtarCount:!0})}async showProgress(){return await this.sendWithResponse({showProgress:!0})}async showEffects(){return await this.sendWithResponse({showEffects:!0})}async showRetarg(){return await this.sendWithResponse({showRetarg:!0})}sendEffectState(e){this.port.postMessage(e)}async getToken(){return await this.sendWithResponse({getUserToken:!0})}async getManagerName(){return await this.sendWithResponse({getManagerName:!0})}async saveEffectPreset(e){return await this.sendWithResponse({saveEffectPreset:e})}async getEffectPresets(){return await this.sendWithResponse({getEffectPresets:!0})}async deleteEffectPreset(e){return await this.sendWithResponse({deleteEffectPreset:e})}async getViewportSize(){return await this.sendWithResponse({getViewportSize:!0})}async setViewportSize(e){return await this.sendWithResponse({setViewportSize:e})}async getRetargetingStatus(){return await this.sendWithResponse({getRetargetingStatus:!0})}async setRetargetingStatus(e){return await this.sendWithResponse({setRetargetingStatus:e})}async getRetargetingCalibration(){return await this.sendWithResponse({getRetargetingCalibration:!0})}async setRetargetingCalibration(e){return await this.sendWithResponse({setRetargetingCalibration:e})}}function se(){return Math.random().toString(32).slice(-10)+Date.now()+Math.random().toString(34).slice(-5)+Math.random().toString(36).slice(-5)}const re={Manager:ee,ManagerConnection:ae,getFlexatar:async function(e,t){const a="/ftar/"+t.id,s=await caches.open(R);let r=await s.match(a);if(!r){const o=await F(e,t.id,{ftar:!0});if(r=await fetch(o.ftar,{method:"GET"}),!r.ok)return;const n=await r.arrayBuffer(),i=new Response(new Uint8Array(n),{headers:{"Content-Type":"application/octet-stream"}});return await s.put(a,i),n}return await r.arrayBuffer()},getPreview:async function(e){const t="/ftarpreview/"+e.id,a=await caches.open(R);let s=await a.match(t);if(!s){if(s=await fetch(e.preview,{method:"GET"}),!s.ok)return;const r=await s.arrayBuffer(),o=new Response(new Uint8Array(r),{headers:{"Content-Type":"application/octet-stream"}});return await a.put(t,o),r}return await s.arrayBuffer()},flexatarList:U,makeFlexatar:M,deleteFlexatar:D,flexatarEntry:F,userInfo:N,GetToken:x,ERR_UNAUTHORIZED:A,ERR_UNEXPECTED:B};if(void 0===oe)var oe=self;oe.Ftar=re;const ne=new ae;let ie;ne.onEffectMessage=e=>{ie.postMessage(e)},ne.onSlot2=e=>{ie.postMessage(e,[e.slot2])},ne.onSlot1=e=>{e.ftarLink1,ie.postMessage(e,[e.slot1])},ne.onEffectStateRequest=e=>{ce.then((t=>{t.postMessage(e)}))},window.parent.postMessage({ftarUIPort:ne.outPort},"*",[ne.outPort]);const ce=new Promise((e=>{window.addEventListener("message",(t=>{t.data&&t.data.flexatarControllerPort?(t.data.flexatarControllerPort,ie=t.data.flexatarControllerPort,ie.onmessage=e=>{const t=e.data;t&&t.effectStateResponse&&ne.sendEffectState(t)},e(ie)):t.data&&t.data.closing&&(ie&&(ie.postMessage({closing:!0}),ie.close(),ie=null),ne.close())}))}));async function le(t,a){const s=await ne.getList({preview:!0,noCache:t});if(s.error)return reloadIcon.classList.remove("roating"),plusCircle.classList.add("rotated"),void(makeTextHolder.textContent=e.SUBSCRIPTION_END);for(const e of s){const t=await ne.getPreview(e),s=new Blob([t],{type:"image/jpg"}),r=URL.createObjectURL(s),{holder:o}=await Ie(e,r,null,a.id,ne)}}confirmButton.onclick=async()=>{if(confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,Fe)noBackgroundButton!==Be&&(await ne.deleteBackground(Be.id),Be&&Be.remove(),imageBackgroundContainer.firstElementChild?.click());else{const t=pe;await async function(e){return(await he.deleteFlexatar(e)).success}(me)&&(t.remove(),previewListHolder.children.length>0?t===pe&&previewListHolder.children[0]?.click():(me=null,emptyBlock.textContent=e.EMPTY))}trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),_e=!_e},reloadFtarListButton.onclick=async()=>{for(reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");previewListHolder.children.length>0;)previewListHolder.children[0]?.remove();let e=await ne.getCurrentFtar();await le(!0,e),reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1},trashButton.onclick=()=>{_e?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),_e=!_e},reloadIcon.classList.add("roating"),ne.onNewFlexatar=async e=>{if(e.error)return;const t=await ne.getPreview(e),a=new Blob([t],{type:"image/jpg"}),s=URL.createObjectURL(a),{holder:r}=await Ie(e,s,!0,e.id,ne)},Promise.all([ne.ready]).then((async()=>{let e=await ne.getCurrentFtar();await le(!1,e),reloadIcon.classList.remove("roating")}));window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=e.ALLOW_AUDIO;const ue=window.location.search;new URLSearchParams(ue);function de(e,t){const a=document.createElement("input"),s=document.createElement("form");s.appendChild(a),a.type="file",a.accept="image/*",a.onchange=e=>{t(e),s.reset()},e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),a.dataTransfer,e.classList.remove("hover");const r=a.dataTransfer.files;t({target:{files:r}}),s.reset()}}async function ge(e){const t=await function(e){const t=e.type,a=e.name;return new Promise(((s,r)=>{const o=new FileReader;o.readAsArrayBuffer(e),o.onload=()=>s({buffer:o.result,fileType:t,fileName:a}),o.onerror=e=>r(e)}))}(e);return t.makeFtar=!0,await ne.makeFlexatar(e)}!function(){const s=createFlexatarHolder,r=plusCircle,o=makeTextHolder;o.textContent=e.DROP_PHOTO;const n=makeOverlayElement;let i;de(s,(async s=>{let c=s.target.files[0];if(!c)return;i&&(i(),i=null);const l=(r.style.display="none",o.style.display="none",n.style.display="block",()=>{r.style.display="block",o.style.display="block",n.style.display="none"});if(!a(c.type,t))return u=e.NOT_PHOTO,r.classList.add("rotated"),o.textContent=u,i=()=>{r.classList.remove("rotated"),o.textContent=e.DROP_PHOTO},void l();var u;await ge(c);l()}))}();const fe={};let we,me,pe,he;async function Ie(e,t,a,s,r){fe[e.id]=e;const o=t,n=document.createElement("span");n.className="item-holder";const i=document.createElement("img");i.src=o,i.draggable=!1,i.style.cursor="pointer",i.style.display="block",i.style.width="100%",i.style.height="auto",i.style.margin="0px",i.style.padding="0px",i.style.boxSizing="border-box",i.style.lineHeight="0px",i.style.verticalAlign="top",i.style.objectFit="contain",n.appendChild(i),n.id=e.id;const c=document.createElement("span");return c.className="loader",a?previewListHolder.insertBefore(n,previewListHolder.firstChild):previewListHolder.appendChild(n),n.onclick=async()=>{we&&we.classList.remove("selected-item"),we=n,n.classList.add("selected-item"),me=e.id,pe=n,he=r,n.appendChild(c);const t=await ne.getFlexatar(e,!0);ie&&(ie.postMessage({slot1:t,id:e.id},[t]),ie.postMessage({noEffect:!0})),c.remove()},s===e.id&&(pe=n,n.click()),{holder:n,previewImg:o}}trashButton.classList.remove("invisible");let _e=!1;reloadFtarListButton.classList.remove("invisible");let ye,Ee,Re,Te=!1;document.addEventListener("mousedown",(e=>{ke&&clearInterval(ke),Te=!0,ye=e.screenY,Ee=window.scrollY}));let Se,ke,De=0,ve=0,Ce=0,Pe=!1;function Le(){if(Te=!1,De=0,Re&&clearInterval(Re),document.body.style.pointerEvents="auto",!Pe)return;Pe=!1,Ee=window.scrollY,ve=.5*Ce,ke=setInterval((()=>{Ee+=ve,window.scrollTo(0,Ee),ve*=.9,Math.abs(ve)<1&&clearInterval(ke)}),50);const e=ke;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{Te&&(e.preventDefault(),Se=ye-e.screenY,!Pe&&Math.abs(Se)<10||(Pe||(Ce=0,Re=setInterval((()=>{ve=Se-De,De=Se,Ce=.5*(Ce+ve)}),100)),Pe=!0,document.body.style.pointerEvents="none",window.scrollTo(0,Ee+Se)))})),document.addEventListener("mouseup",Le),document.addEventListener("mouseleave",Le),emotionText.onclick=expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")};const Ae=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let Be,Ue=AllEmo;Ue.classList.add("color-emo-selected");for(const e of Ae)e.onclick=()=>{Ue.classList.remove("color-emo-selected"),Ue=e,Ue.classList.add("color-emo-selected"),ie&&ie.postMessage({animation:{pattern:e.id}})};AllEmo.onclick=()=>{Ue.classList.remove("color-emo-selected"),Ue=AllEmo,Ue.classList.add("color-emo-selected"),ie&&ie.postMessage({animation:{pattern:null}})};let Fe=!1;function Me(e,t,a,s=!1){const r=document.createElement("img");return r.id=e.id,r.src=t,r.draggable=!1,r.style.cursor="pointer",r.style.display="block",r.style.width="100%",r.style.height="auto",r.style.margin="0px",r.style.padding="0px",r.style.boxSizing="border-box",r.style.lineHeight="0px",r.style.verticalAlign="top",r.style.objectFit="contain",s?function(e,t){if(!t.nextSibling)return void t.parentNode.appendChild(e);t.parentNode.insertBefore(e,t.nextSibling)}(r,noBackgroundButton):imageBackgroundContainer.appendChild(r),r.onclick=async()=>{Be&&Be.classList.remove("selected-item"),Be=r,r.classList.add("selected-item"),ie&&ie.postMessage({background:t}),ne.setCurrentBackground(e)},r}backgroundText.onclick=expandBkgButton.onclick=async()=>{Fe?(expandBkgButton.classList.add("rot180"),dropBackgroundContainer.classList.add("invisible"),imageBackgroundContainer.querySelectorAll("img").forEach((e=>e.remove())),bkgExpander.classList.remove("full-height")):(expandBkgButton.classList.remove("rot180"),dropBackgroundContainer.classList.remove("invisible"),dropBackgroundText.textContent=e.DROP_BACKGROUND,bkgExpander.classList.add("full-height"),async function(){const e=(await ne.getBackgrounds()).reverse();let t=await ne.getCurrentBackground();t||(await ne.setCurrentBackground(e[0][0]),t=await ne.getCurrentBackground());for(const[t,a]of e)Me(t,a,ne);const a=document.getElementById(t.id);a?a.click():noBackgroundButton.click()}()),Fe=!Fe},noBackgroundButton.onclick=()=>{noBackgroundButton.classList.add("selected-item"),Be&&Be.classList.remove("selected-item"),Be=noBackgroundButton,ie&&ie.postMessage({background:!0,no:!0}),ne.setCurrentBackground("no")},de(dropBkgElement,(async e=>{let s=e.target.files[0];if(!s)return;if(!a(s.type,t))return;const r=await async function(e,t,a){const s=await createImageBitmap(e),r=new OffscreenCanvas(t,a),o=r.getContext("2d"),n=s.width/s.height;let i,c,l,u;n>t/a?(c=a,i=s.width*(a/s.height),l=-(i-t)/2,u=0):(i=t,c=s.height*(t/s.width),l=0,u=-(c-a)/2);o.drawImage(s,l,u,i,c);const d=await r.convertToBlob(),g=await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(d)}));return g}(s,480,640);await ne.storeNewBackground(r)})),ne.onNewBackground=async e=>{Me(e,(await ne.getBackgrounds(e))[0][1],0,!0).click()},ftarLogButton.onclick=e=>{ne.showProgress()},effectsButton.onclick=()=>{ne.showEffects()},retargetingButton.onclick=()=>{ne.showRetarg()}})();
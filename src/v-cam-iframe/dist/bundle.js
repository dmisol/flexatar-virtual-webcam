(()=>{"use strict";const e="ftarcache";const t=["image/jpeg","image/png","image/bmp","image/webp","image/avif","image/x-portable-bitmap","image/x-portable-anymap","image/x-portable-pixmap","image/tiff"];async function a(t,a){const n=await async function(t){const a=await caches.open(e),n=await a.match(t);if(!n)return null;const s=await n.arrayBuffer();return new Uint8Array(s)}("/ftar/"+t.id);if(n)return{data:n,ready:Promise.resolve(!0),id:t.id,name:t.meta?.name};t.ftar||(t=await FtarView.flexatarEntry(a,t.id,{ftar:!0}));const s=await FtarView.getFlexatar(t);return await async function(t,a){const n=await caches.open(e),s=new Response(a,{headers:{"Content-Type":"application/octet-stream"}});await n.put(t,s)}("/ftar/"+t.id,s.data),s}async function n(t){const a=await async function(t){const a=await caches.open(e),n=await a.match(t);if(!n)return null;const s=await n.blob();return URL.createObjectURL(s)}("/ftarpreview/"+t.id);if(a)return a;const n=await FtarView.getPreview(t);return await async function(t,a){const n=await async function(e){const t=await fetch(e);return await t.blob()}(a),s=await caches.open(e),i=new Response(n,{headers:{"Content-Type":n.type||"application/octet-stream"}});await s.put(t,i)}("/ftarpreview/"+t.id,n),n}class s{static DROP_PHOTO="DROP PHOTO";static BAD_PHOTO="BAD PHOTO";static NOT_PHOTO="NOT PHOTO";static LIMIT="LIMIT";static UNKNOWN="UNKNOWN";static EMPTY="EMPTY";static ALLOW_AUDIO="START"}function i(e,t){let a={};return t?a[t]=e:a=e,a}class r{constructor(e,t,a,n){this.iframeId=a,this.holderId=t,this.postMessageProvider=e,this.peerConnection=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all"});const s=this;if(n){this.messageManager=function(){try{return{processMessage:function(e){try{const o=JSON.parse(e);"flexatarPreview"===o.messageType?(r={id:o.payload.id,previewImage:o.payload.previewImage},s.onFlexatarPreview&&s.onFlexatarPreview(r)):"flexatarCreated"===o.messageType?(n={id:o.payload.id,previewImage:o.payload.previewImage},i=o.payload.error,s.onFlexatarCreated&&s.onFlexatarCreated(n,i)):"setFlexatarToSlot"===o.messageType?(t=o.payload.id,a=o.payload.slotNumber,s.onSetFlexatarToSlot&&s.onSetFlexatarToSlot(t,a)):"deleteFlexatar"===o.messageType?(e=>{s.onDeleteFlexatar&&s.onDeleteFlexatar(e)})(o.payload.id):"flexatarRemoved"===o.messageType?((e,t)=>{s.onFlexatarRemoved&&s.onFlexatarRemoved(e,t)})(o.payload.id):"setEffect"===o.messageType?(e=>{s.onSetEffect&&s.onSetEffect(e)})(o.payload.effectId):"setEffectAmount"===o.messageType?(e=>{s.onSetEffectAmount&&s.onSetEffectAmount(e)})(o.payload.amount):"flexatarActivated"===o.messageType?((e,t,a)=>{s.onFlexatarActivated&&s.onFlexatarActivated(e,t,a)})(o.payload.id,o.payload.slotIdx):"flexatarEmotionList"===o.messageType?(e=>{s.onFlexatarEmotionList&&s.onFlexatarEmotionList(e)})(o.payload.emotionList):"setFlexatarEmotion"===o.messageType?(e=>{s.onSetFlexatarEmotion&&s.onSetFlexatarEmotion(e)})(o.payload.emotionId):"setBackground"===o.messageType?(e=>{s.onSetBackground&&s.onSetBackground(e)})(o.payload.base64Image):"createFlexatar"===o.messageType?(e=>{s.onCreateFlexatar&&s.onCreateFlexatar(e)})(o.payload.base64Image):"reloadFlexatarList"===o.messageType&&s.onReloadFlexatarList&&s.onReloadFlexatarList()}catch(e){return{processMessage:function(){},makeFlexatarPreviewMessage:function(){return""},makeFlexatarCreatedMessage:function(){return""},makeSetFlexatarToSlotMessage:function(){return""},makeDeleteFlexatarMessage:function(){return""},makeFlexatarRemovedMessage:function(){return""},makeSetEffectMessage:function(){return""},makeSetEffectAmountMessage:function(){return""},makeFlexatarActivatedMessage:function(){return""},makeFlexatarEmotionListMessage:function(){return""},makeSetFlexatarEmotionMessage:function(){return""},makeSetBackgroundMessage:function(){return""},makeCreateFlexatarMessage:function(){return""},makeReloadFlexatarListMessage:function(){return""}}}var t,a,n,i,r},makeFlexatarPreviewMessage:function(e){return JSON.stringify({messageType:"flexatarPreview",payload:e})},makeFlexatarCreatedMessage:function(e,t){return JSON.stringify({messageType:"flexatarCreated",payload:{id:e.id,previewImage:e.previewImage,error:t}})},makeSetFlexatarToSlotMessage:function(e,t){return JSON.stringify({messageType:"setFlexatarToSlot",payload:{id:e,slotNumber:t}})},makeDeleteFlexatarMessage:function(e){return JSON.stringify({messageType:"deleteFlexatar",payload:{id:e}})},makeFlexatarRemovedMessage:function(e){return JSON.stringify({messageType:"flexatarRemoved",payload:{id:e}})},makeSetEffectMessage:function(e){return JSON.stringify({messageType:"setEffect",payload:{effectId:e}})},makeSetEffectAmountMessage:function(e){return JSON.stringify({messageType:"setEffectAmount",payload:{amount:e}})},makeFlexatarActivatedMessage:function(e,t){return JSON.stringify({messageType:"flexatarActivated",payload:{id:e,slotIdx:t}})},makeFlexatarEmotionListMessage:function(e){return JSON.stringify({messageType:"flexatarEmotionList",payload:{emotionList:e}})},makeSetFlexatarEmotionMessage:function(e){return JSON.stringify({messageType:"setFlexatarEmotion",payload:{emotionId:e}})},makeSetBackgroundMessage:function(e){return JSON.stringify({messageType:"setBackground",payload:{base64Image:e}})},makeCreateFlexatarMessage:function(e){return JSON.stringify({messageType:"createFlexatar",payload:{base64Image:e}})},makeReloadFlexatarListMessage:function(){return JSON.stringify({messageType:"reloadFlexatarList",payload:{}})}}}catch(e){return{processMessage:function(){},makeFlexatarPreviewMessage:function(){return""},makeFlexatarCreatedMessage:function(){return""},makeSetFlexatarToSlotMessage:function(){return""},makeDeleteFlexatarMessage:function(){return""},makeFlexatarRemovedMessage:function(){return""},makeSetEffectMessage:function(){return""},makeSetEffectAmountMessage:function(){return""},makeFlexatarActivatedMessage:function(){return""},makeFlexatarEmotionListMessage:function(){return""},makeSetFlexatarEmotionMessage:function(){return""},makeSetBackgroundMessage:function(){return""},makeCreateFlexatarMessage:function(){return""},makeReloadFlexatarListMessage:function(){return""}}}}();const{sendStringFunction:e,initializationError:a}=function(e,t,a){try{const n=e.createDataChannel(t);return n.addEventListener("open",(()=>{a&&a()})),{sendStringFunction:e=>{if("open"!==n.readyState)throw new Error("Data channel is not open");n.send(e)},initializationError:null}}catch(e){return e}}(this.peerConnection,t,(()=>{this.onDataChanelAvailable&&this.onDataChanelAvailable()}));this.sendMessage=e,a&&console.log(a),function(e,t,a){try{return e.ondatachannel=e=>{e.channel.label===t&&(e.channel.onmessage=e=>{if(e.data instanceof Blob){const t=new FileReader;t.onload=()=>{a(t.result)},t.readAsText(e.data)}else a(e.data)})},null}catch(e){return e}}(this.peerConnection,"host"===t?"iframe":"host",(e=>{this.messageManager.processMessage(e)}))}this.peerConnection.ontrack=e=>{const a=e.track;"iframe"==t?"audio"==a.kind&&this.onaudioready&&this.onaudioready(a):"host"==t&&("video"==a.kind?this.onflexatarready&&this.onflexatarready(a):this.ondelayedaudio&&this.ondelayedaudio(a))},this.peerConnection.onicecandidate=t=>{t.candidate&&e.postMessage({flexatar:i({type:"ice-candidate",candidate:JSON.stringify(t.candidate)},this.iframeId)},"*")},this.peerConnection.onconnectionstatechange=()=>{this.peerConnection.connectionState},this.isNegotiating=!0,this.peerConnection.onnegotiationneeded=async()=>{this.isNegotiating||(this.isNegotiating=!0,e.postMessage({flexatar:i(await this.offerMessage(),this.iframeId)},"*"))}}async recvOffer(e){const t=new RTCSessionDescription({type:"offer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t);const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.postMessageProvider.postMessage({flexatar:i({type:"answer",sdp:a.sdp},this.iframeId)},"*")}async recvAnswer(e){const t=new RTCSessionDescription({type:"answer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t)}async addIceCandidate(e){await this.peerConnection.addIceCandidate(JSON.parse(e.candidate))}async offerMessage(){const e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),{type:"offer",sdp:e.sdp}}addAudioTrack(e){e?this.audioTransiver?this.audioTransiver.sender.replaceTrack(e).then((()=>{})).catch((e=>{console.error("Error replacing track:",e)})):this.audioTransiver=this.peerConnection.addTransceiver(e,{direction:"sendonly"}):this.audioTransiver&&(this.peerConnection.getSenders().forEach((e=>{e.track&&"audio"===e.track.kind&&this.peerConnection.removeTrack(e)})),this.audioTransiver.stop(),this.audioTransiver=null)}addAllTraks(e){e.getTracks().forEach((e=>{this.peerConnection.addTransceiver(e,{direction:"sendonly"})}))}}async function o(e){const t=await fetch(e),a=await t.blob();return new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(a)}))}const c={no:0,morph:1,hybrid:2};let l={mode:0,parameter:0};window.onload=function(){window.scrollTo(0,200)},allowAuidoOverlay.textContent=s.ALLOW_AUDIO;const d=window.location.search,m=new URLSearchParams(d);let u,f=!1;m.forEach(((e,t)=>{"id"===t?u=e:"external_ctl"===t&&(f="true"===e)}));const p=FtarLipsync.newInstance();let g;const y=new Promise((e=>{g=e})),w=new Promise((e=>{allowAuidoOverlay.onclick=()=>{e()}})),v=new Promise((async e=>{const t=await p;await y,allowAuidoOverlay.classList.remove("invisible"),await w,allowAuidoOverlay.classList.add("invisible"),await t.startAudioContext(),e(t)}));let h,x;!function(){const e=createFlexatarHolder,i=plusCircle,r=makeTextHolder;r.textContent=s.DROP_PHOTO;const o=makeOverlayElement,c=e=>(i.classList.add("rotated"),r.textContent=e,()=>{i.classList.remove("rotated"),r.textContent=s.DROP_PHOTO});let l;!function(e,t){const a=document.createElement("input");a.type="file",a.accept="image/*",a.onchange=e=>t(e),e.onclick=()=>{a.click()},e.ondragover=t=>{t.preventDefault(),e.classList.add("hover")},e.ondragleave=t=>{e.classList.remove("hover")},e.ondrop=a=>{a.preventDefault(),e.classList.remove("hover");const n=a.dataTransfer.files;t({target:{files:n}})}}(e,(async e=>{l&&(l(),l=null);const d=(i.style.display="none",r.style.display="none",o.style.display="block",()=>{i.style.display="block",r.style.display="block",o.style.display="none"}),m=e.target.files[0];if(!function(e,t){for(const a of t)if(e==a)return!0;return!1}(m.type,t))return l=c(s.NOT_PHOTO),void d();let u;try{u=await FtarView.makeFlexatar(E,m,"noname",{ftar:!0,preview:!0})}catch{}if(d(),u||(l=c(s.UNKNOWN)),u.err)return void(u.reason&&("queue_limit"===u.reason||("subscription_limit"===u.reason?l=c(s.LIMIT):"bad_photo"===u.reason&&(l=c(s.BAD_PHOTO)))));FtarView.userInfo(E).then((e=>{ftarCountSign.textContent=e.FtarCount})),await a(u,E);const f=await n(u),{holder:p}=await b(u,f);p.click(),emptyBlock.textContent=""}))}();const k={};async function F(e,t){for(const a of e){k[a.id]=a;const e=await n(a);e&&t(a,e)}}let L,M,T;async function b(e,t,n){k[e.id]=e;const s=t,i=document.createElement("span");i.className="item-holder";const r=document.createElement("img");r.src=s,r.draggable=!1,r.style.cursor="pointer",r.style.display="block",r.style.width="100%",r.style.height="auto",r.style.margin="0px",r.style.padding="0px",r.style.boxSizing="border-box",r.style.lineHeight="0px",r.style.verticalAlign="top",r.style.objectFit="contain",i.appendChild(r),i.id=e.id;const o=document.createElement("span");return o.className="loader",L||(i.classList.add("selected-item"),L=i,M={element:i,ftarId:e.id}),previewListHolder.insertBefore(i,previewListHolder.children[2]),i.onclick=async()=>{M={element:i,ftarId:e.id},L&&L.classList.remove("selected-item"),L=i,i.classList.add("selected-item"),i.appendChild(o);try{x.slot1=await a(e,E),x.start()}finally{o.remove()}},{holder:i,previewImg:s}}let S,C,E,I,O=new MediaStream,A=new Promise((e=>{I=e}));window.addEventListener("message",(async e=>{let t=e.data;if(t.flexatar){if(t=t.flexatar,"reload_token"===t.type)C(t.token);else if("request_audio"===t.type){allowAuidoOverlay.classList.remove("invisible"),await w,allowAuidoOverlay.classList.add("invisible");const e={};e[u]={type:"request_audio"},window.parent.postMessage({flexatar:e},"*")}else if("resolution"===t.type)await A,x.canvas.width=t.resolution.width,x.canvas.height=t.resolution.height;else if("background"===t.type){await A;const e=URL.createObjectURL(new Blob([t.imageBuffer],{type:"image/jpg"})),a=await h.newOverlay(e);x.addOverlay(a,{x:0,y:0,width:100,height:100,mode:"back"})}else if(t.token){const e={};e[u]={type:"heart_beat"},window.parent.postMessage({flexatar:e},"*");const t=new FtarView.GetToken((async()=>{const e=new Promise((e=>{C=e})),t={};return t[u]={type:"reload_token"},window.parent.postMessage({flexatar:t},"*"),await e}));E=t,FtarView.userInfo(E).then((e=>{e.restricted||(createFlexatarHolder.classList.remove("invisible"),reloadFtarListButton.classList.remove("invisible"),trashButton.classList.remove("invisible"),ftarCountSign.textContent=e.FtarCount)}));const i=await FtarView.flexatarList(t,{preview:!0});if(i.error)return;let d;const m=new Promise((e=>{d=e}));F(i,(async(e,t)=>{b(e,t),(async()=>{await m,T.sendMessage&&T.sendMessage(T.messageManager.makeFlexatarPreviewMessage({id:e.id,previewImage:await o(t)}))})()})),h=new FtarView.SDK(t),x=await h.getRenderer();const p=[Joy,Anger,Sadness,Surprise,Disgust,Confusion];let y=AllEmo;y.classList.add("color-emo-selected");for(const e of p)e.onclick=()=>{y.classList.remove("color-emo-selected"),y=e,y.classList.add("color-emo-selected"),x.animator.currentAnimationPattern=e.id};AllEmo.onclick=()=>{y.classList.remove("color-emo-selected"),y=AllEmo,y.classList.add("color-emo-selected"),x.animator.currentAnimationPattern=null},i.length>0?previewListHolder.children[2].click():emptyBlock.textContent=s.EMPTY,I(),x.canvas.width=240,x.canvas.height=320,x.canvas.style.display="none",document.body.appendChild(x.canvas);const w=x.canvas.captureStream(30);T=new r(window.parent,"iframe",u,f),T.onDataChanelAvailable=()=>{d(),T.sendMessage(T.messageManager.makeFlexatarEmotionListMessage(["All"].concat(p.map((e=>e.id)))))},T.onReloadFlexatarList=async()=>{const e=await FtarView.flexatarList(E,{preview:!0});e.error||F(e,(async(e,t)=>{T.sendMessage(T.messageManager.makeFlexatarPreviewMessage({id:e.id,previewImage:await o(t)}))}))},T.onSetFlexatarToSlot=async(e,t)=>{const n=await a(k[e],E);n?(1===t?(x.slot1=n,x.start()):(x.slot2=n,x.start()),T.sendMessage(T.messageManager.makeFlexatarActivatedMessage(e,t,!1))):T.sendMessage(T.messageManager.makeFlexatarActivatedMessage(e,t,!0))},T.onSetFlexatarEmotion=e=>{x.animator.currentAnimationPattern=e},T.onDeleteFlexatar=async e=>{let t=!1;await FtarView.deleteFlexatar({id:e,token:E})&&(t=!0,M.element.remove(),previewListHolder.children.length>2?previewListHolder.children[2].click():x.pause()),T.sendMessage(T.messageManager.makeFlexatarRemovedMessage(e,!t))},T.onSetEffect=async e=>{if("no"===e.effectId||"id2"!==x.slot2.id)if(e.animated)"no"===e.effectId?x.effect=FtarView.effect.no():"morph"===e.effectId?x.effect=FtarView.effect.morph():"hybrid"===e.effectId&&(x.effect=FtarView.effect.hybrid());else if("no"===e.effectId)x.effect=FtarView.effect.no();else{const t=c[e.effectId];l.mode=t,l.parameter=.5,x.effect=()=>l}},T.onSetEffectAmount=async e=>{l.parameter=e},T.onSetBackground=async e=>{const t=await h.newOverlay(e);x.addOverlay(t,{x:0,y:0,width:100,height:100,mode:"back"})},T.onCreateFlexatar=async e=>{const t=(e=>{try{const t=atob(e.split(",")[1]),a=new Uint8Array(t.length);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);return new File([a],"file",{type:e.split(",")[0].split(":")[1].split(";")[0]})}catch(e){return console.error("Error restoring file from string:",e),null}})(e),a=await FtarView.makeFlexatar(E,t,"noname",{ftar:!0,preview:!0});let i="";if(a){if(a.err)return i=a.reason?a.reason:"unknown_error",void T.sendMessage(T.messageManager.makeFlexatarCreatedMessage({},i))}else i="unknown_error",removeErrorSign=setErrorSign(s.UNKNOWN);const r=await n(a);await b(a,r),T.sendMessage(T.messageManager.makeFlexatarCreatedMessage({id:a.id,previewImage:await o(r)},i))},T.addAllTraks(w);const L={};L[u]=await T.offerMessage(),window.parent.postMessage({flexatar:L},"*"),T.onaudioready=async e=>{g(),S&&O.removeTrack(S),S=e,O.addTrack(e);const t=new Audio;t.srcObject=O,t.pause(),t.muted=!0;const a=await v;a.mediaStream=O,a.connect(x);const n=a.synchronizedStream();T.addAudioTrack(n.getAudioTracks()[0]),e.onended=()=>{setTimeout((()=>{a.mediaStream=null,T.addAudioTrack(null),T.isNegotiating=!1}),700)},T.isNegotiating=!1}}"offer"===t.type?T.recvOffer(t):"ice-candidate"===t.type?T.addIceCandidate(t):"answer"===t.type&&T.recvAnswer(t)}}));let P=!1;trashButton.onclick=()=>{P?(crossIcon.classList.add("invisible"),trashIcon.classList.remove("invisible"),confirmButton.classList.add("invisible")):(confirmButton.classList.remove("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.remove("invisible")),P=!P},confirmButton.onclick=async()=>{confirmButton.classList.add("invisible"),trashIcon.classList.add("invisible"),crossIcon.classList.add("invisible"),waitIcon.classList.remove("invisible"),waitIcon.classList.add("roating"),trashButton.disabled=!0,await new Promise((e=>{setTimeout((()=>{e()}),3e3)})),await FtarView.deleteFlexatar({id:M.ftarId,token:E})&&(M.element.remove(),previewListHolder.children.length>1?previewListHolder.children[2].click():x.pause()),trashIcon.classList.remove("invisible"),waitIcon.classList.add("invisible"),waitIcon.classList.remove("roating"),P=!P},reloadFtarListButton.onclick=async()=>{reloadFtarListButton.disabled=!0,reloadIcon.classList.add("roating");const e=await FtarView.flexatarList(E,{preview:!0});if(e.error)return void reloadIcon.classList.remove("roating");const t=M.element.id;for(;previewListHolder.children.length>3;)previewListHolder.children[2].remove();F(e,(async(e,a)=>{const{holder:n}=await b(e,a);e.id===t&&n.click()})),reloadIcon.classList.remove("roating"),reloadFtarListButton.disabled=!1};let N,B,R,D=!1;document.addEventListener("mousedown",(e=>{_&&clearInterval(_),D=!0,N=e.screenY,B=window.scrollY}));let H,_,V=0,J=0,U=0,Y=!1;function j(){if(D=!1,V=0,R&&clearInterval(R),document.body.style.pointerEvents="auto",!Y)return;Y=!1,B=window.scrollY,J=.5*U,_=setInterval((()=>{B+=J,window.scrollTo(0,B),J*=.9,Math.abs(J)<1&&clearInterval(_)}),50);const e=_;setTimeout((()=>{clearInterval(e)}),2e3)}document.addEventListener("mousemove",(e=>{D&&(e.preventDefault(),H=N-e.screenY,!Y&&Math.abs(H)<10||(Y||(U=0,R=setInterval((()=>{J=H-V,V=H,U=.5*(U+J)}),100)),Y=!0,document.body.style.pointerEvents="none",window.scrollTo(0,B+H)))})),document.addEventListener("mouseup",j),document.addEventListener("mouseleave",j),expandEmoButton.onclick=()=>{emoContainer.classList.remove("invisible"),closeEmoButton.classList.remove("invisible"),expandEmoButton.classList.add("invisible")},closeEmoButton.onclick=()=>{emoContainer.classList.add("invisible"),closeEmoButton.classList.add("invisible"),expandEmoButton.classList.remove("invisible")}})();
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.VCAM=t():e.VCAM=t()}(this,(()=>(()=>{"use strict";var e={d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>i});class a{constructor(e,t,a,n){this.iframeId=a,this.holderId=t,this.postMessageProvider=e,this.peerConnection=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all"});const i=this;if(n){this.messageManager=function(){try{return{processMessage:function(e){try{const r=JSON.parse(e);"flexatarPreview"===r.messageType?(s={id:r.payload.id,previewImage:r.payload.previewImage},i.onFlexatarPreview&&i.onFlexatarPreview(s)):"flexatarCreated"===r.messageType?(n={id:r.payload.id,previewImage:r.payload.previewImage},o=r.payload.error,i.onFlexatarCreated&&i.onFlexatarCreated(n,o)):"setFlexatarToSlot"===r.messageType?(t=r.payload.id,a=r.payload.slotNumber,i.onSetFlexatarToSlot&&i.onSetFlexatarToSlot(t,a)):"deleteFlexatar"===r.messageType?(e=>{i.onDeleteFlexatar&&i.onDeleteFlexatar(e)})(r.payload.id):"flexatarRemoved"===r.messageType?((e,t)=>{i.onFlexatarRemoved&&i.onFlexatarRemoved(e,t)})(r.payload.id):"setEffect"===r.messageType?(e=>{i.onSetEffect&&i.onSetEffect(e)})(r.payload.effectId):"setEffectAmount"===r.messageType?(e=>{i.onSetEffectAmount&&i.onSetEffectAmount(e)})(r.payload.amount):"flexatarActivated"===r.messageType?((e,t,a)=>{i.onFlexatarActivated&&i.onFlexatarActivated(e,t,a)})(r.payload.id,r.payload.slotIdx):"flexatarEmotionList"===r.messageType?(e=>{i.onFlexatarEmotionList&&i.onFlexatarEmotionList(e)})(r.payload.emotionList):"setFlexatarEmotion"===r.messageType?(e=>{i.onSetFlexatarEmotion&&i.onSetFlexatarEmotion(e)})(r.payload.emotionId):"setBackground"===r.messageType?(e=>{i.onSetBackground&&i.onSetBackground(e)})(r.payload.base64Image):"createFlexatar"===r.messageType?(e=>{i.onCreateFlexatar&&i.onCreateFlexatar(e)})(r.payload.base64Image):"reloadFlexatarList"===r.messageType&&i.onReloadFlexatarList&&i.onReloadFlexatarList()}catch(e){return{processMessage:function(){},makeFlexatarPreviewMessage:function(){return""},makeFlexatarCreatedMessage:function(){return""},makeSetFlexatarToSlotMessage:function(){return""},makeDeleteFlexatarMessage:function(){return""},makeFlexatarRemovedMessage:function(){return""},makeSetEffectMessage:function(){return""},makeSetEffectAmountMessage:function(){return""},makeFlexatarActivatedMessage:function(){return""},makeFlexatarEmotionListMessage:function(){return""},makeSetFlexatarEmotionMessage:function(){return""},makeSetBackgroundMessage:function(){return""},makeCreateFlexatarMessage:function(){return""},makeReloadFlexatarListMessage:function(){return""}}}var t,a,n,o,s},makeFlexatarPreviewMessage:function(e){return JSON.stringify({messageType:"flexatarPreview",payload:e})},makeFlexatarCreatedMessage:function(e,t){return JSON.stringify({messageType:"flexatarCreated",payload:{id:e.id,previewImage:e.previewImage,error:t}})},makeSetFlexatarToSlotMessage:function(e,t){return JSON.stringify({messageType:"setFlexatarToSlot",payload:{id:e,slotNumber:t}})},makeDeleteFlexatarMessage:function(e){return JSON.stringify({messageType:"deleteFlexatar",payload:{id:e}})},makeFlexatarRemovedMessage:function(e){return JSON.stringify({messageType:"flexatarRemoved",payload:{id:e}})},makeSetEffectMessage:function(e){return JSON.stringify({messageType:"setEffect",payload:{effectId:e}})},makeSetEffectAmountMessage:function(e){return JSON.stringify({messageType:"setEffectAmount",payload:{amount:e}})},makeFlexatarActivatedMessage:function(e,t){return JSON.stringify({messageType:"flexatarActivated",payload:{id:e,slotIdx:t}})},makeFlexatarEmotionListMessage:function(e){return JSON.stringify({messageType:"flexatarEmotionList",payload:{emotionList:e}})},makeSetFlexatarEmotionMessage:function(e){return JSON.stringify({messageType:"setFlexatarEmotion",payload:{emotionId:e}})},makeSetBackgroundMessage:function(e){return JSON.stringify({messageType:"setBackground",payload:{base64Image:e}})},makeCreateFlexatarMessage:function(e){return JSON.stringify({messageType:"createFlexatar",payload:{base64Image:e}})},makeReloadFlexatarListMessage:function(){return JSON.stringify({messageType:"reloadFlexatarList",payload:{}})}}}catch(e){return{processMessage:function(){},makeFlexatarPreviewMessage:function(){return""},makeFlexatarCreatedMessage:function(){return""},makeSetFlexatarToSlotMessage:function(){return""},makeDeleteFlexatarMessage:function(){return""},makeFlexatarRemovedMessage:function(){return""},makeSetEffectMessage:function(){return""},makeSetEffectAmountMessage:function(){return""},makeFlexatarActivatedMessage:function(){return""},makeFlexatarEmotionListMessage:function(){return""},makeSetFlexatarEmotionMessage:function(){return""},makeSetBackgroundMessage:function(){return""},makeCreateFlexatarMessage:function(){return""},makeReloadFlexatarListMessage:function(){return""}}}}();const{sendStringFunction:e,initializationError:a}=function(e,t,a){try{const n=e.createDataChannel(t);return n.addEventListener("open",(()=>{a&&a()})),{sendStringFunction:e=>{if("open"!==n.readyState)throw new Error("Data channel is not open");n.send(e)},initializationError:null}}catch(e){return e}}(this.peerConnection,t,(()=>{this.onDataChanelAvailable&&this.onDataChanelAvailable()}));this.sendMessage=e,a&&console.log(a),function(e,t,a){try{return e.ondatachannel=e=>{e.channel.label===t&&(e.channel.onmessage=e=>{if(e.data instanceof Blob){const t=new FileReader;t.onload=()=>{a(t.result)},t.readAsText(e.data)}else a(e.data)})},null}catch(e){return e}}(this.peerConnection,"host"===t?"iframe":"host",(e=>{this.messageManager.processMessage(e)}))}this.peerConnection.ontrack=e=>{const a=e.track;"iframe"==t?"audio"==a.kind&&this.onaudioready&&this.onaudioready(a):"host"==t&&("video"==a.kind?this.onflexatarready&&this.onflexatarready(a):this.ondelayedaudio&&this.ondelayedaudio(a))},this.peerConnection.onicecandidate=t=>{t.candidate&&e({type:"ice-candidate",candidate:JSON.stringify(t.candidate)},this.iframeId)},this.peerConnection.onconnectionstatechange=()=>{this.peerConnection.connectionState},this.isNegotiating=!0,this.peerConnection.onnegotiationneeded=async()=>{this.isNegotiating||(this.isNegotiating=!0,e(await this.offerMessage(),this.iframeId))}}async recvOffer(e){const t=new RTCSessionDescription({type:"offer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t);const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.postMessageProvider({type:"answer",sdp:a.sdp},this.iframeId)}async recvAnswer(e){const t=new RTCSessionDescription({type:"answer",sdp:e.sdp});await this.peerConnection.setRemoteDescription(t)}async addIceCandidate(e){await this.peerConnection.addIceCandidate(JSON.parse(e.candidate))}async offerMessage(){const e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),{type:"offer",sdp:e.sdp}}addAudioTrack(e){e?this.audioTransiver?this.audioTransiver.sender.replaceTrack(e).then((()=>{})).catch((e=>{console.error("Error replacing track:",e)})):this.audioTransiver=this.peerConnection.addTransceiver(e,{direction:"sendonly"}):this.audioTransiver&&(this.peerConnection.getSenders().forEach((e=>{e.track&&"audio"===e.track.kind&&this.peerConnection.removeTrack(e)})),this.audioTransiver.stop(),this.audioTransiver=null)}addAllTraks(e){e.getTracks().forEach((e=>{this.peerConnection.addTransceiver(e,{direction:"sendonly"})}))}}class n{#e;#t=async()=>{};#a=()=>{};#n;setupTokenFetch(e,t){let a=!0;this.#t=async()=>{if(a&&this.#n?.token)return a=!1,this.#n.token;try{const a=await fetch(e,t);if(!a.ok)return void this.#a({status:a.status,message:await a.text()});const n=await a.json();return n.token||this.#a({status:403,message:"token_expired"}),n.token}catch(e){return void this.#a({exception:e})}}}set ontokenerror(e){this.#a=e}set background(e){(async()=>{const t=await fetch(e);if(!t.ok)return void console.error("can not fetch ",e);const a=await t.arrayBuffer();await this.#i,this.#o.contentWindow.postMessage({flexatar:{type:"background",imageBuffer:a}},"*")})()}#o;#i;#s;#r;constructor(e,t){let a,n;this.#s=crypto.randomUUID(),this.#n=t,t?.token&&(this.#t=()=>t.token),this.#o=document.createElement("iframe"),this.#r=new Promise((e=>{a=e})),this.#d=a,window.addEventListener("message",(async e=>{let t=e.data;if(t.flexatar&&(t=t.flexatar,t=t[this.#s],t))if("answer"===t.type?this.#c.recvAnswer(t):"ice-candidate"===t.type&&this.#c.addIceCandidate(t),"offer"===t.type)this.#c.recvOffer(t);else if("request_audio"===t.type)this.#l&&(this.#l(),this.#l);else if("reload_token"===t.type){const e=await this.#t();this.#o.contentWindow.postMessage({flexatar:{type:"reload_token",token:e}},"*")}else"heart_beat"===t.type&&n&&(clearTimeout(n),n=null)})),this.#i=new Promise((e=>{this.#o.onload=async()=>{this.#o.contentWindow.postMessage({flexatar:{token:!0}},"*"),this.#u(t.externalControl),n=setTimeout((()=>{this.oninvalidurl&&this.oninvalidurl()}),2e3),e()}})),this.#o.onerror=function(){console.log("error iframe"),this.oninvalidurl&&this.oninvalidurl()};let i=`${e}?id=${this.#s}`;t.externalControl&&(i+="&external_ctl=true"),this.#o.src=i,this.#o.style.width="100%",this.#o.style.height="100%",this.#o.style.border="none",this.#o.style.position="absolute",this.#o.style.top="0",this.#o.style.left="0",this.#m=this.#o.style}set resolution(e){(async()=>{await this.#r,this.#o.contentWindow.postMessage({flexatar:{type:"resolution",resolution:e}},"*")})()}#m;set style(e){this.#o.style=e}get style(){return this.#m}#f;set src(e){e||(this.audiotrack=null),e instanceof MediaStream?this.audiostream=e:"string"==typeof e?this.url=e:e instanceof ArrayBuffer?this.arraybuffer=e:e instanceof MediaStreamTrack&&"audio"==e.kind&&(this.audiotrack=e)}set url(e){e||(this.audiotrack=null),(async()=>{const t=await async function(e){const t=await fetch(e);if(!t.ok)return void console.error(`can't load from ${e}`);let a;try{a=await t.arrayBuffer()}catch(e){return void console.error(`Error while reading arrayBuffer: ${e.message}`)}return a}(e);t&&(this.arraybuffer=t)})()}set audiotrack(e){(async()=>{await this.#r,e&&(e.onended=()=>{this.#c.addAudioTrack(null),this.#c.isNegotiating=!1}),this.#c.addAudioTrack(e),this.#c.isNegotiating=!1})()}set arraybuffer(e){e||(this.audiotrack=null),(async()=>{this.#f&&this.#f.stopBufferSource(),this.#f=await async function(e,t){let a;try{a=await t.decodeAudioData(e)}catch(e){return void console.error(`Error while decoding audio data: ${e.message}`)}const n=t.createBufferSource();n.buffer=a;const i=t.createMediaStreamDestination();let o=!1;n.connect(i);const s=i.stream;return n.onended=()=>{if(!o){const e=s.getAudioTracks()[0];e&&(e.stop(),e.dispatchEvent(new Event("ended")))}},n.start(),s.stopBufferSource=()=>{o=!0,n.stop()},s}(e,n.#h()),this.audiostream=this.#f})()}static#g;static#h(){return n.#g||(n.#g=new(window.AudioContext||window.webkitAudioContext)),n.#g}set audiostream(e){if(!e)return void(this.audiotrack=null);const t=e.getAudioTracks()[0];this.audiotrack=t}set onoutputstream(e){this.#e=e}mediastream=new MediaStream;#d;#c;#p;#u(e){var t;this.#c=new a((t=this.#o.contentWindow,e=>{t.postMessage({flexatar:e},"*")}),"host",void 0,e),this.#c.ondelayedaudio=e=>{this.#p&&this.mediastream.removeTrack(this.#p),this.#p=e,this.mediastream.addTrack(e)},this.#c.onflexatarready=e=>{this.#d(),this.mediastream.addTrack(e),this.#e&&this.#e(this.mediastream)},this.#c.onFlexatarPreview=e=>{this.onFlexatarPreview&&this.onFlexatarPreview(e)},this.#c.onFlexatarEmotionList=e=>{this.onFlexatarEmotionList&&this.onFlexatarEmotionList(e)},this.#c.onNewFlexatarItem=e=>{this.onNewFlexatarItem&&this.onNewFlexatarItem(e)},this.#c.onFlexatarRemoved=(e,t)=>{this.onFlexatarRemoved&&this.onFlexatarRemoved(e,t)},this.#c.onFlexatarActivated=(e,t)=>{this.onFlexatarActivated&&this.onFlexatarActivated(e,t)},this.#c.onFlexatarCreated=(e,t)=>{this.onFlexatarCreated&&this.onFlexatarCreated(e,t)},this.#c.onDataChanelAvailable=()=>{this.onDataChanelAvailable&&this.onDataChanelAvailable()}}#l;#y=!1;get isAudioReady(){return this.#y}sendSetToSlot(e,t){this.#c.sendMessage(this.#c.messageManager.makeSetFlexatarToSlotMessage(e,t))}setFlexatarEmotion(e){this.#c.sendMessage(this.#c.messageManager.makeSetFlexatarEmotionMessage(e))}deleteFlexatar(e){this.#c.sendMessage(this.#c.messageManager.makeDeleteFlexatarMessage(e))}setEffect(e){this.#c.sendMessage(this.#c.messageManager.makeSetEffectMessage(e))}setEffectAmount(e){this.#c.sendMessage(this.#c.messageManager.makeSetEffectAmountMessage(e))}setBackground(e){this.#c.sendMessage(this.#c.messageManager.makeSetBackgroundMessage(e))}createFlexatar(e){this.#c.sendMessage(this.#c.messageManager.makeCreateFlexatarMessage(e))}setEffect(e){this.#c.sendMessage(this.#c.messageManager.makeSetEffectMessage(e))}setEffectAmount(e){this.#c.sendMessage(this.#c.messageManager.makeSetEffectAmountMessage(e))}reloadFlexatarList(){this.#c.sendMessage(this.#c.messageManager.makeReloadFlexatarListMessage())}async requestAudioPermission(e){await this.requestAudioPermition(e)}async requestAudioPermition(e){this.#y||(this.#y=!0,this.#o.contentWindow.postMessage({flexatar:{type:"request_audio"}},"*"),await new Promise((e=>{this.#l=e})),e())}mount(e){e.style.position="relative",e.appendChild(this.#o)}get element(){return this.#o}unmount(){this.#o.remove()}destroy(){this.#o.parentNode&&this.#o.remove(),this.#o.src=null}}const i={getVCamElement:function(e,t){return new n(e,t)}};return t})()));